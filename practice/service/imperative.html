<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">

<!-- Mirrored from qedcode.com/practice/service/imperative by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 12:22:22 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Imperative programming | Q.E.D. Code</title>
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="prev" href="../service.html" />
<link rel="up" href="../service.html" />
<link rel="next" href="fixing-an-unhelpful-api.html" />
<link rel="shortcut icon" href="http://qedcode.com/misc/favicon.ico" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/book/book.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/node/node.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/system/defaults.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/system/system.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/system/system-menus.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/user/user.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/sites/all/modules/mollom/mollom.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/sites/all/modules/views/css/views.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/comment/comment.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/themes/theme073/style.css?2" />
  <script type="text/javascript" src="http://qedcode.com/misc/jquery.js?2"></script>
<script type="text/javascript" src="http://qedcode.com/misc/drupal.js?2"></script>
<script type="text/javascript" src="http://qedcode.com/sites/all/modules/google_analytics/googleanalytics.js?2"></script>
<script type="text/javascript" src="http://qedcode.com/sites/all/modules/mollom/mollom.js?2"></script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
jQuery.extend(Drupal.settings, { "basePath": "/", "googleanalytics": { "trackOutbound": 1, "trackMailto": 1, "trackDownload": 1, "trackDownloadExtensions": "7z|aac|arc|arj|asf|asx|avi|bin|csv|doc|exe|flv|gif|gz|gzip|hqx|jar|jpe?g|js|mp(2|3|4|e?g)|mov(ie)?|msi|msp|pdf|phps|png|ppt|qtm?|ra(m|r)?|sea|sit|tar|tgz|torrent|txt|wav|wma|wmv|wpd|xls|xml|z|zip" } });
//--><!]]>
</script>
  
</head>
  
<body>
    <table id="main">
        <tr>
            <td width="100%" class="header">
            	<div class="top-left">
                	<div class="top-right">
                    	<table width="100%">
                            <tr>
                                <td width="100%" style="height:195px;">
                                    <table width="100%">
                                        <tr>
                                            <td width="">
                                                                                                    <a href="../../index.html" title="Home"><img src="http://qedcode.com/themes/theme073/images/logo.png" alt="Home" border="0" class="logo" /></a><br />
                                                                                                                                                
                                                                                            </td>
                                            <td width="270">
                                                <div class="search-box">
                                                                                                    </div>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                            <tr>
                                <td width="100%" style="height:54px;">
                                                                            <div class="pr-menu">
                                            <ul class="links primary-links"><li class="menu-227 first"><a href="../../node.html" title="">Latest Article</a></li>
<li class="menu-339"><a href="../../podcast.html" title="Q.E.D. Code Podcast">Podcast</a></li>
<li class="menu-219"><a href="../../theory.html" title="">Theory</a></li>
<li class="menu-220"><a href="../../practice.html" title="">Practice</a></li>
<li class="menu-221 last"><a href="../../speaking.html" title="">Speaking</a></li>
</ul>                                            <br class="clear" />
                                        </div>
                                                                    </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </td>
        </tr>
        <tr>
            <td width="100%">
                <table width="100%" >
                    <tr>
                        <td width="189">
                            <div class="left2">
                                                                    <table width="100%">
                                      <tr>
                                        <td width="100%">
                                            <div class="block block-block" id="block-block-2">
	<div class="block-bot">
    	<div class="block-top">
        	<div class="block-indent">
                <div class="title">
                    <h3>About me</h3>
                </div>
                <div class="content"><div style="margin: 15px;">
<p style="margin-bottom: 7px;">Michael L Perry</p>
<p><a href="http://improvingenterprises.com/"><img src="../../images/IE-Logo.png" width="145" alt="Improving Enterprises" /></a></p>
<p style="margin-bottom: 15px;">Principal Consultant</p>
<p><a href="http://twitter.com/michaellperry">@michaellperry</a></p>
</div>
</div>
            </div>
        </div>
    </div>
</div><div class="block block-user" id="block-user-0">
	<div class="block-bot">
    	<div class="block-top">
        	<div class="block-indent">
                <div class="title">
                    <h3>User login</h3>
                </div>
                <div class="content"><form action="http://qedcode.com/practice/service/imperative?destination=node%2F17"  accept-charset="UTF-8" method="post" id="user-login-form">
<div><div class="form-item" id="edit-name-wrapper">
 <label for="edit-name">Username: <span class="form-required" title="This field is required.">*</span></label>
 <input type="text" maxlength="60" name="name" id="edit-name" size="15" value="" class="form-text required" />
</div>
<div class="form-item" id="edit-pass-wrapper">
 <label for="edit-pass">Password: <span class="form-required" title="This field is required.">*</span></label>
 <input type="password" name="pass" id="edit-pass"  maxlength="60"  size="15"  class="form-text required" />
</div>
<input type="submit" name="op" id="edit-submit" value="Log in"  class="form-submit" />
<div class="item-list"><ul><li class="first last"><a href="../../user/password.html" title="Request new password via e-mail.">Request new password</a></li>
</ul></div><input type="hidden" name="form_build_id" id="form-49d68c7477c494ed86c6a84cf78d48a2" value="form-49d68c7477c494ed86c6a84cf78d48a2"  />
<input type="hidden" name="form_id" id="edit-user-login-block" value="user_login_block"  />

</div></form>
</div>
            </div>
        </div>
    </div>
</div>                                        </td>
                                      </tr>
                                    </table>
                                                            </div>
                        </td>
                        <td width="0">
                            <div class="right2">
                                                            </div>
                        </td>
                        <td width="" class="cont-row">
                            <div class="border-left">
                                <div class="border-right">
                                    <div class="border-bot">
                                        <div class="border-top">
                                            <div class="corner-bot-left">
                                                <div class="corner-bot-right">
                                                    <div class="corner-top-left">
                                                        <div class="corner-top-right">
                                                            <div class="cent">
                                                                                                                                                                                                
                                                                                                                        
                                                                <h2>Imperative programming</h2>
                                                                                                                                                                                                                                                                 
                                                                                                                    
                                                                                                                    
                                                              <!-- start main content -->
                                                            <div class="node">
	    <div class="taxonomy"></div>
  
    <div class="content"><p>The proof of the first two points is pretty straight forward. Because the transaction is assigned prior to calling the service function, we know the service function has a transaction. And because the transaction is created in a using statement, we know that it will be disposed.</p>
<p>The third point is harder to prove. If two threads call GetOrder on the same object, they will both try to assign a transaction to the same OrderServiceProvider. We have to prove that this won't happen. For that, we look at the Castle configuration:</p>
<pre><span style="color: blue">&lt;</span><span style="color: maroon">component</span>
    <span style="color: red">id</span>="...OrderService"
    <span style="color: red">service</span>="...OrderService, ..."
    <span style="color: red">type</span>="...OrderService, ..."
    <span style="color: red">lifestyle</span>="<strong>transient</strong>”<span style="color: blue">&gt;</span>
        <span style="color: blue">&lt;</span><span style="color: maroon">parameters</span><span style="color: blue">&gt;</span>
            <span style="color: blue">&lt;</span><span style="color: maroon">orderRepository</span><span style="color: blue">&gt;</span>
                ${...OrderRepository}
            <span style="color: blue">&lt;</span>/<span style="color: maroon">orderRepository</span><span style="color: blue">&gt;</span>
        <span style="color: blue">&lt;</span>/<span style="color: maroon">parameters</span><span style="color: blue">&gt;</span>
<span style="color: blue">&lt;</span>/<span style="color: maroon">component</span><span style="color: blue">&gt;</span></pre><p>Because the OrderService is declared to be transient, we are guaranteed to get a new instance each time the component is resolved. Each web request resolves the service, so we know that each web request gets a unique object. The request is thread safe. Q.E.D.</p>
<p><strong>Perils of imperative proofs</strong><br />While these proofs are correct, there is a significant problem. We proved correctness based on the code that calls OrderService, not based on OrderService itself. In fact, there is nothing about the OrderService API that compels the caller to use it correctly.</p>
<p>For example, the service requires that we set the BusinessTransactionContext property before we call a method. If we forget one little assignment statement, then the service does not have a transaction. This problem can be caught no earlier than integration testing.</p>
<p>If, on the other hand, we forget to create our transaction in a using statement, we have a more subtle problem. We may see that database connections leak over time. Or we may see blocking because failed transactions remain open instead of being rolled back. This problem won't be caught in integration testing, and may be very difficult to diagnose when it finally is identified.</p>
<p>And what if we forget to configure our components to be transient? The only time this causes a measurable problem is when we have concurrency greater than 1. This doesn't happen during a typical integration test. Nor does this usually happen during manual testing. The first time a web application sees concurrency is usually during stress testing, or maybe even production.</p>
<p>This lead into a discussion of prerequisites. There are ways that we can rewrite the OrderService API so that it cannot be used incorrectly. Some examples are to <a href="http://adventuresinsoftware.com/blog/?p=415">require a parameter</a> and to <a href="http://adventuresinsoftware.com/blog/?p=416">use the constructor</a>. We'll apply these techniques to the OrderService in the next post.</p>
  <div id="book-navigation-16" class="book-navigation">
    
        <div class="page-links clear-block">
              <a href="../service.html" class="page-previous" title="Go to previous page">‹ Service transaction</a>
                    <a href="../service.html" class="page-up" title="Go to parent page">up</a>
                    <a href="fixing-an-unhelpful-api.html" class="page-next" title="Go to next page">Fixing an unhelpful API ›</a>
          </div>
    
  </div>
</div>
    <br />
        	<div class="links-align">
            <div class="bg-links">
                <div class="links-left">
                    <div class="links-right">
                        <div class="links"><ul class="links inline"><li class="comment_add first last"><a href="http://qedcode.com/comment/reply/17#comment-form" title="Share your thoughts and opinions related to this posting.">Add new comment</a></li>
</ul></div>
                    </div>
                </div>
            </div>
        </div>
	    <br class="clear" />    
    </div>                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
    <div id="footer">
    	<div class="foot">
        	                <span><a rel="license" href="http://creativecommons.org/licenses/by/3.0/us/"><img alt="Creative Commons License" src="../../../licensebuttons.net/l/by/3.0/us/88x31.png" /></a><br /><span dc="http://purl.org/dc/elements/1.1/" href="http://purl.org/dc/dcmitype/Text" property="title" rel="type">Q.E.D. Code</span> by <a cc="http://creativecommons.org/ns#" href="../../index.html" property="attributionName" rel="attributionURL">Michael L Perry</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/3.0/us/">Creative Commons Attribution 3.0 United States License</a>.</span>
                    </div>
    </div>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
var _gaq = _gaq || [];_gaq.push(["_setAccount", "UA-389401-7"]);_gaq.push(["_trackPageview"]);(function() {var ga = document.createElement("script");ga.type = "text/javascript";ga.async = true;ga.src = ("https:" == document.location.protocol ? "https://ssl" : "http://www") + ".google-analytics.com/ga.js";var s = document.getElementsByTagName("script")[0];s.parentNode.insertBefore(ga, s);})();
//--><!]]>
</script>
</body>

<!-- Mirrored from qedcode.com/practice/service/imperative by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 12:22:22 GMT -->
</html>
