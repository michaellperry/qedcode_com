<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">

<!-- Mirrored from qedcode.com/practice/provable-apis by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 12:22:16 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Provable APIs | Q.E.D. Code</title>
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="prev" href="../practice.html" />
<link rel="up" href="../practice.html" />
<link rel="next" href="movement.html" />
<link rel="shortcut icon" href="http://qedcode.com/misc/favicon.ico" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/book/book.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/node/node.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/system/defaults.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/system/system.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/system/system-menus.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/user/user.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/sites/all/modules/mollom/mollom.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/sites/all/modules/views/css/views.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/comment/comment.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/themes/theme073/style.css?2" />
  <script type="text/javascript" src="http://qedcode.com/misc/jquery.js?2"></script>
<script type="text/javascript" src="http://qedcode.com/misc/drupal.js?2"></script>
<script type="text/javascript" src="http://qedcode.com/sites/all/modules/google_analytics/googleanalytics.js?2"></script>
<script type="text/javascript" src="http://qedcode.com/sites/all/modules/mollom/mollom.js?2"></script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
jQuery.extend(Drupal.settings, { "basePath": "/", "googleanalytics": { "trackOutbound": 1, "trackMailto": 1, "trackDownload": 1, "trackDownloadExtensions": "7z|aac|arc|arj|asf|asx|avi|bin|csv|doc|exe|flv|gif|gz|gzip|hqx|jar|jpe?g|js|mp(2|3|4|e?g)|mov(ie)?|msi|msp|pdf|phps|png|ppt|qtm?|ra(m|r)?|sea|sit|tar|tgz|torrent|txt|wav|wma|wmv|wpd|xls|xml|z|zip" } });
//--><!]]>
</script>
  
</head>
  
<body>
    <table id="main">
        <tr>
            <td width="100%" class="header">
            	<div class="top-left">
                	<div class="top-right">
                    	<table width="100%">
                            <tr>
                                <td width="100%" style="height:195px;">
                                    <table width="100%">
                                        <tr>
                                            <td width="">
                                                                                                    <a href="../index.html" title="Home"><img src="http://qedcode.com/themes/theme073/images/logo.png" alt="Home" border="0" class="logo" /></a><br />
                                                                                                                                                
                                                                                            </td>
                                            <td width="270">
                                                <div class="search-box">
                                                                                                    </div>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                            <tr>
                                <td width="100%" style="height:54px;">
                                                                            <div class="pr-menu">
                                            <ul class="links primary-links"><li class="menu-227 first"><a href="../node.html" title="">Latest Article</a></li>
<li class="menu-339"><a href="../podcast.html" title="Q.E.D. Code Podcast">Podcast</a></li>
<li class="menu-219"><a href="../theory.html" title="">Theory</a></li>
<li class="menu-220"><a href="../practice.html" title="">Practice</a></li>
<li class="menu-221 last"><a href="../speaking.html" title="">Speaking</a></li>
</ul>                                            <br class="clear" />
                                        </div>
                                                                    </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </td>
        </tr>
        <tr>
            <td width="100%">
                <table width="100%" >
                    <tr>
                        <td width="189">
                            <div class="left2">
                                                                    <table width="100%">
                                      <tr>
                                        <td width="100%">
                                            <div class="block block-block" id="block-block-2">
	<div class="block-bot">
    	<div class="block-top">
        	<div class="block-indent">
                <div class="title">
                    <h3>About me</h3>
                </div>
                <div class="content"><div style="margin: 15px;">
<p style="margin-bottom: 7px;">Michael L Perry</p>
<p><a href="http://improvingenterprises.com/"><img src="../images/IE-Logo.png" width="145" alt="Improving Enterprises" /></a></p>
<p style="margin-bottom: 15px;">Principal Consultant</p>
<p><a href="http://twitter.com/michaellperry">@michaellperry</a></p>
</div>
</div>
            </div>
        </div>
    </div>
</div><div class="block block-user" id="block-user-0">
	<div class="block-bot">
    	<div class="block-top">
        	<div class="block-indent">
                <div class="title">
                    <h3>User login</h3>
                </div>
                <div class="content"><form action="http://qedcode.com/practice/provable-apis?destination=node%2F31"  accept-charset="UTF-8" method="post" id="user-login-form">
<div><div class="form-item" id="edit-name-wrapper">
 <label for="edit-name">Username: <span class="form-required" title="This field is required.">*</span></label>
 <input type="text" maxlength="60" name="name" id="edit-name" size="15" value="" class="form-text required" />
</div>
<div class="form-item" id="edit-pass-wrapper">
 <label for="edit-pass">Password: <span class="form-required" title="This field is required.">*</span></label>
 <input type="password" name="pass" id="edit-pass"  maxlength="60"  size="15"  class="form-text required" />
</div>
<input type="submit" name="op" id="edit-submit" value="Log in"  class="form-submit" />
<div class="item-list"><ul><li class="first last"><a href="../user/password.html" title="Request new password via e-mail.">Request new password</a></li>
</ul></div><input type="hidden" name="form_build_id" id="form-406a90a4879270a46f748404ca0c5e61" value="form-406a90a4879270a46f748404ca0c5e61"  />
<input type="hidden" name="form_id" id="edit-user-login-block" value="user_login_block"  />

</div></form>
</div>
            </div>
        </div>
    </div>
</div>                                        </td>
                                      </tr>
                                    </table>
                                                            </div>
                        </td>
                        <td width="0">
                            <div class="right2">
                                                            </div>
                        </td>
                        <td width="" class="cont-row">
                            <div class="border-left">
                                <div class="border-right">
                                    <div class="border-bot">
                                        <div class="border-top">
                                            <div class="corner-bot-left">
                                                <div class="corner-bot-right">
                                                    <div class="corner-top-left">
                                                        <div class="corner-top-right">
                                                            <div class="cent">
                                                                                                                                                                                                
                                                                                                                        
                                                                <h2>Provable APIs</h2>
                                                                                                                                                                                                                                                                 
                                                                                                                    
                                                                                                                    
                                                              <!-- start main content -->
                                                            <div class="node">
	    <div class="taxonomy"></div>
  
    <div class="content"><p><a href="http://qedcode.com/sites/default/files/ProvableAPIs_914F/image.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; margin-left: 0px; border-left-width: 0px; margin-right: 0px" title="image" border="0" alt="image" align="right" src="http://qedcode.com/sites/default/files/ProvableAPIs_914F/image_thumb.png" width="244" height="244" /></a>Tool vendors like Microsoft are not the only ones who publish APIs. When we create layered software, each layer has an API that is consumed by the next one up. To ensure the quality of our software, we should try to create provable APIs. These are interfaces that guide the caller to the correct usage patterns. They help the compiler help us to verify the correctness of our code.</p>
<p>An unhelpful API throws exceptions whenever we get something wrong. These kinds of APIs can cause stress and lead to bugs that are difficult to correct. There is a right way to call them, but there is also a wrong way. The wrong way still compiles, but it contains bugs nonetheless.</p>
<p>Some language features and patterns that can help us to prove the correctness of code:</p>
<ul>
<li>Parameters </li>
<li>Callbacks </li>
<li>Foreign keys </li>
<li>Factories </li>
<li>Constructors </li>
</ul>
<h3>You must set a property before calling this method</h3>
<p>A ShoppingService uses a Transaction to perform some basic operations. For example:</p>
<pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">Transaction
</span>{
}

<span style="color: blue">public class </span><span style="color: #2b91af">ShoppingService
</span>{
    <span style="color: blue">public </span><span style="color: #2b91af">Transaction </span>Transaction { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }

    <span style="color: blue">public void </span>AddToCart(<span style="color: blue">int </span>cartId, <span style="color: blue">int </span>itemId, <span style="color: blue">int </span>quantity)
    {
    }
}

<span style="color: blue">public static void </span>Right()
{
    <span style="color: #2b91af">ShoppingService </span>shoppingService = <span style="color: blue">new </span><span style="color: #2b91af">ShoppingService</span>();
    shoppingService.Transaction = <span style="color: blue">new </span><span style="color: #2b91af">Transaction</span>();
    shoppingService.AddToCart(1, 2, 3);
}

<span style="color: blue">public static void </span>Wrong()
{
    <span style="color: #2b91af">ShoppingService </span>shoppingService = <span style="color: blue">new </span><span style="color: #2b91af">ShoppingService</span>();
    shoppingService.AddToCart(1, 2, 3);
}</pre><p>It has a Transaction property that must be set before it is called. If you forget to set it, the method throws an exception. This API is unhelpful. If instead the method takes the transaction as a <strong>parameter</strong>, the compiler enforces this rule.</p>
<pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">ShoppingService
</span>{
    <span style="color: blue">public void </span>AddToCart(<span style="color: #2b91af">Transaction </span>transaction, <span style="color: blue">int </span>cartId, <span style="color: blue">int </span>itemId, <span style="color: blue">int </span>quantity)
    {
    }
}

<span style="color: blue">public static void </span>Right()
{
    <span style="color: #2b91af">ShoppingService </span>shoppingService = <span style="color: blue">new </span><span style="color: #2b91af">ShoppingService</span>();
    shoppingService.AddToCart(<span style="color: blue">new </span><span style="color: #2b91af">Transaction</span>(), 1, 2, 3);
}</pre><p>In this version of the code, we’ve refactored the Transaction property and turned it into a method parameter. The right way of calling the method compiles. The wrong way does not.</p>
<h3>You must check a condition before calling this method</h3>
<p>Now let’s look at the interface for a cache. You can Add an item, Get an item, or check to see if the cache already Contains an item. There is a right way to use this API, and a couple of wrong ways.</p>
<pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">Cache</span>&lt;TKey, TItem&gt;
{
    <span style="color: blue">public bool </span>Contains(TKey key)
    {
        <span style="color: blue">return false</span>;
    }

    <span style="color: blue">public void </span>Add(TKey key, TItem item)
    {
        <span style="color: blue">if </span>(Contains(key))
            <span style="color: blue">throw new </span><span style="color: #2b91af">ApplicationException</span>();
    }

    <span style="color: blue">public </span>TItem Get(TKey key)
    {
        <span style="color: blue">if </span>(!Contains(key))
            <span style="color: blue">throw new </span><span style="color: #2b91af">ApplicationException</span>();

        <span style="color: blue">return default</span>(TItem);
    }
}

<span style="color: blue">public static void </span>Right()
{
    <span style="color: #2b91af">Cache</span>&lt;<span style="color: blue">int</span>, <span style="color: blue">string</span>&gt; cache = <span style="color: blue">new </span><span style="color: #2b91af">Cache</span>&lt;<span style="color: blue">int</span>, <span style="color: blue">string</span>&gt;();
    <span style="color: blue">int </span>key = 42;
    <span style="color: blue">string </span>value;

    <span style="color: blue">if </span>(cache.Contains(key))
    {
        value = cache.Get(key);
    }
    <span style="color: blue">else
    </span>{
        value = LoadValue(key);
        cache.Add(key, value);
    }
}

<span style="color: blue">public static void </span>Wrong1()
{
    <span style="color: #2b91af">Cache</span>&lt;<span style="color: blue">int</span>, <span style="color: blue">string</span>&gt; cache = <span style="color: blue">new </span><span style="color: #2b91af">Cache</span>&lt;<span style="color: blue">int</span>, <span style="color: blue">string</span>&gt;();
    <span style="color: blue">int </span>key = 42;
    <span style="color: blue">string </span>value;

    value = cache.Get(key);
    <span style="color: blue">if </span>(value == <span style="color: blue">null</span>)
    {
        value = LoadValue(key);
        cache.Add(key, value);
    }
}

<span style="color: blue">public static void </span>Wrong2()
{
    <span style="color: #2b91af">Cache</span>&lt;<span style="color: blue">int</span>, <span style="color: blue">string</span>&gt; cache = <span style="color: blue">new </span><span style="color: #2b91af">Cache</span>&lt;<span style="color: blue">int</span>, <span style="color: blue">string</span>&gt;();
    <span style="color: blue">int </span>key = 42;
    <span style="color: blue">string </span>value;

    value = LoadValue(key);
    cache.Add(key, value);
}

<span style="color: blue">private static string </span>LoadValue(<span style="color: blue">int </span>key)
{
    <span style="color: blue">return </span><span style="color: #a31515">&quot;the value&quot;</span>;
}</pre><p>The right way is to check the condition first. If the item is not there, load it and add it. If the item is already there, get it.</p>
<p>But you might be confused. Maybe you need to get it first, and if Get returns null you know it’s not there. That is not the contract of this class, but it is impossible to see that from the public API alone. It will throw an exception.</p>
<p>You might also make the mistake of trying to add an item to the cache without first checking to see if it is there. This could be a copy/paste bug, or perhaps your code took a path that you didn’t anticipate. This is going to throw an exception, too.</p>
<p>Let’s refactor this code by pulling the right usage pattern into the Cache itself. Since we need to do some work right in the middle, we’ll provide a <strong>callback</strong>.</p>
<pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">Cache</span>&lt;TKey, TItem&gt;
{
    <span style="color: blue">public bool </span>Contains(TKey key)
    {
        <span style="color: blue">return false</span>;
    }

    <span style="color: blue">public </span>TItem GetValue(TKey key, Func&lt;TKey, TItem&gt; fetchValue)
    {
        TItem value;
        <span style="color: blue">if </span>(Contains(key))
        {
            value = Get(key);
        }
        <span style="color: blue">else
        </span>{
            value = fetchValue(key);
            Add(key, value);
        }
        <span style="color: blue">return </span>value;
    }

    <span style="color: blue">private void </span>Add(TKey key, TItem item)
    {
        <span style="color: blue">if </span>(Contains(key))
            <span style="color: blue">throw new </span><span style="color: #2b91af">ApplicationException</span>();
    }

    <span style="color: blue">private </span>TItem Get(TKey key)
    {
        <span style="color: blue">if </span>(!Contains(key))
            <span style="color: blue">throw new </span><span style="color: #2b91af">ApplicationException</span>();

        <span style="color: blue">return default</span>(TItem);
    }
}

<span style="color: blue">public static void </span>Right()
{
    <span style="color: #2b91af">Cache</span>&lt;<span style="color: blue">int</span>, <span style="color: blue">string</span>&gt; cache = <span style="color: blue">new </span><span style="color: #2b91af">Cache</span>&lt;<span style="color: blue">int</span>, <span style="color: blue">string</span>&gt;();
    <span style="color: blue">int </span>key = 42;
    <span style="color: blue">string </span>value;

    value = cache.GetValue(key, k =&gt; LoadValue(k));
}</pre><p>After moving this code into the Cache class, we can make the Add and Get methods private. This makes it impossible to use the Cache incorrectly.</p>
<h3>You must call this method after setting properties</h3>
<p>It’s a good idea to have business objects that perform validation. It lets you respond to the user, and it prevents bad data from getting into the database. But what if you forget to call the Validate method?</p>
<pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">Customer
</span>{
    <span style="color: blue">private static </span><span style="color: #2b91af">Regex </span>ValidPhoneNumber = <span style="color: blue">new </span><span style="color: #2b91af">Regex</span>(<span style="color: #a31515">@&quot;\([0-9]{3}\) [0-9]{3}-[0-9]{4}&quot;</span>);

    <span style="color: blue">public string </span>Name { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }
    <span style="color: blue">public string </span>PhoneNumber { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }

    <span style="color: blue">public bool </span>Validate()
    {
        <span style="color: blue">if </span>(!ValidPhoneNumber.IsMatch(PhoneNumber))
            <span style="color: blue">return false</span>;

        <span style="color: blue">return true</span>;
    }
}

<span style="color: blue">public static void </span>Right()
{
    <span style="color: #2b91af">Customer </span>customer = <span style="color: blue">new </span><span style="color: #2b91af">Customer</span>()
    {
        Name = <span style="color: #a31515">&quot;Michael L Perry&quot;</span>,
        PhoneNumber = <span style="color: #a31515">&quot;(214) 555-7909&quot;
    </span>};

    <span style="color: blue">if </span>(!customer.Validate())
        <span style="color: blue">throw new </span><span style="color: #2b91af">ApplicationException</span>();
}

<span style="color: blue">public static void </span>Wrong()
{
    <span style="color: #2b91af">Customer </span>customer = <span style="color: blue">new </span><span style="color: #2b91af">Customer</span>()
    {
        Name = <span style="color: #a31515">&quot;Michael L Perry&quot;</span>,
        PhoneNumber = <span style="color: #a31515">&quot;555-7909&quot;
    </span>};
}</pre><p>Nothing about this API forces you to call Validate. And if you don’t, bad data can get through.</p>
<p>The problem is that the PhoneNumber is a string – a very permissive type. We can make it a more restrictive type and use a <strong>factory</strong> method to enforce validation.</p>
<pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">PhoneNumber
</span>{
    <span style="color: blue">private static </span><span style="color: #2b91af">Regex </span>ValidPhoneNumber = <span style="color: blue">new </span><span style="color: #2b91af">Regex</span>(<span style="color: #a31515">@&quot;\([0-9]{3}\) [0-9]{3}-[0-9]{4}&quot;</span>);

    <span style="color: blue">private string </span>_value;

    <span style="color: blue">private </span>PhoneNumber(<span style="color: blue">string </span>value)
    {
        _value = value;
    }

    <span style="color: blue">public string </span>Value
    {
        <span style="color: blue">get </span>{ <span style="color: blue">return </span>_value; }
    }

    <span style="color: blue">public static </span><span style="color: #2b91af">PhoneNumber </span>Parse(<span style="color: blue">string </span>value)
    {
        <span style="color: blue">if </span>(!ValidPhoneNumber.IsMatch(value))
            <span style="color: blue">throw new </span><span style="color: #2b91af">ApplicationException</span>();

        <span style="color: blue">return new </span><span style="color: #2b91af">PhoneNumber</span>(value);
    }
}

<span style="color: blue">public class </span><span style="color: #2b91af">Customer
</span>{
    <span style="color: blue">public string </span>Name { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }
    <span style="color: blue">public </span><span style="color: #2b91af">PhoneNumber </span>PhoneNumber { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }
}

<span style="color: blue">public static void </span>Right()
{
    <span style="color: #2b91af">Customer </span>customer = <span style="color: blue">new </span><span style="color: #2b91af">Customer</span>()
    {
        Name = <span style="color: #a31515">&quot;Michael L Perry&quot;</span>,
        PhoneNumber = <span style="color: #2b91af">PhoneNumber</span>.Parse(<span style="color: #a31515">&quot;(214) 555-7909&quot;</span>)
    };
}</pre><p>Now we are forced to validate the string in order to get a PhoneNumber object. We can still provide feedback on user input, since that’s the time at which we will be parsing the string. But now we can’t forget.</p>
<h3>You cannot change this property after calling a method</h3>
<p>The .NET Connection class requires that you provide a connection string before you access any data. And it also prevents you from changing the connection string after you connect. These rules are fine. The problem is that they are enforced by a state machine behind an unhelpful API that throws exceptions if you get it wrong.</p>
<pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">Connection
</span>{
    <span style="color: blue">private string </span>_connectionString;
    <span style="color: blue">private bool </span>_connected = <span style="color: blue">false</span>;

    <span style="color: blue">public string </span>ConnectionString
    {
        <span style="color: blue">get
        </span>{
            <span style="color: blue">return </span>_connectionString;
        }
        <span style="color: blue">set
        </span>{
            <span style="color: blue">if </span>(_connected)
                <span style="color: blue">throw new </span><span style="color: #2b91af">ApplicationException</span>();

            _connectionString = <span style="color: blue">value</span>;
        }
    }

    <span style="color: blue">public void </span>Connect()
    {
        <span style="color: blue">if </span>(<span style="color: #2b91af">String</span>.IsNullOrEmpty(_connectionString))
            <span style="color: blue">throw new </span><span style="color: #2b91af">ApplicationException</span>();

        _connected = <span style="color: blue">true</span>;
    }

    <span style="color: blue">public void </span>Disconnect()
    {
        _connected = <span style="color: blue">false</span>;
    }
}

<span style="color: blue">public static void </span>Right()
{
    <span style="color: #2b91af">Connection </span>connection = <span style="color: blue">new </span><span style="color: #2b91af">Connection</span>();
    connection.ConnectionString = <span style="color: #a31515">&quot;DataSource=//MyMachine&quot;</span>;
    connection.Connect();
    connection.Disconnect();
}

<span style="color: blue">public static void </span>Wrong1()
{
    <span style="color: #2b91af">Connection </span>connection = <span style="color: blue">new </span><span style="color: #2b91af">Connection</span>();
    connection.Connect();
    connection.Disconnect();
}

<span style="color: blue">public static void </span>Wrong2()
{
    <span style="color: #2b91af">Connection </span>connection = <span style="color: blue">new </span><span style="color: #2b91af">Connection</span>();
    connection.ConnectionString = <span style="color: #a31515">&quot;DataSource=//MyMachine&quot;</span>;
    connection.Connect();
    connection.ConnectionString = <span style="color: #a31515">&quot;DataSource=//HisMachine&quot;</span>;
    connection.Disconnect();
}</pre><p>If we were to make the connection string a <strong>constructor</strong> parameter instead of a property, we wouldn’t be able to change it.</p>
<pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">Connection
</span>{
    <span style="color: blue">private string </span>_connectionString;

    <span style="color: blue">public </span>Connection(<span style="color: blue">string </span>connectionString)
    {
        _connectionString = connectionString;
    }

    <span style="color: blue">public string </span>ConnectionString
    {
        <span style="color: blue">get </span>{ <span style="color: blue">return </span>_connectionString; }
    }

    <span style="color: blue">public void </span>Connect()
    {
    }

    <span style="color: blue">public void </span>Disconnect()
    {
    }
}

<span style="color: blue">public static void </span>Right()
{
    <span style="color: #2b91af">Connection </span>connection = <span style="color: blue">new </span><span style="color: #2b91af">Connection</span>(<span style="color: #a31515">&quot;DataSource=//MyMachine&quot;</span>);
    connection.Connect();
    connection.Disconnect();
}</pre><p>The .NET Connection class has a constructor that takes a connection string. But it also has a constructor that does not. The overloaded constructor and modifiable property make it possible to do the wrong thing. Rip them out and let the compiler enforce correctness for you.</p>
<h3>You must dispose this object</h3>
<p>Let’s go back to the ShoppingService. There’s still a problem with the code. It’s possible to leak database transactions if you forget to dispose them.</p>
<pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">Transaction </span>: <span style="color: #2b91af">IDisposable
</span>{
    <span style="color: blue">public void </span>Dispose()
    {
    }
}

<span style="color: blue">public class </span><span style="color: #2b91af">ShoppingService
</span>{
    <span style="color: blue">public void </span>AddToCart(<span style="color: #2b91af">Transaction </span>transaction, <span style="color: blue">int </span>cartId, <span style="color: blue">int </span>itemId, <span style="color: blue">int </span>quantity)
    {
    }
}

<span style="color: blue">public static void </span>Right()
{
    <span style="color: #2b91af">ShoppingService </span>shoppingService = <span style="color: blue">new </span><span style="color: #2b91af">ShoppingService</span>();
    <span style="color: blue">using </span>(<span style="color: #2b91af">Transaction </span>transaction = <span style="color: blue">new </span><span style="color: #2b91af">Transaction</span>())
    {
        shoppingService.AddToCart(transaction, 1, 2, 3);
    }
}

<span style="color: blue">public static void </span>Wrong()
{
    <span style="color: #2b91af">ShoppingService </span>shoppingService = <span style="color: blue">new </span><span style="color: #2b91af">ShoppingService</span>();
    shoppingService.AddToCart(<span style="color: blue">new </span><span style="color: #2b91af">Transaction</span>(), 1, 2, 3);
}</pre><p>The compiler doesn’t require you to dispose an object that implements IDisposable. It doesn’t even issue a warning. Some refactoring tools and static analysis tools look for these problems, but we can refactor the API to enforce it at the compiler level. We’ll use a combination of a <strong>factory</strong> and a <strong>callback</strong> to take that responsibility away from the caller.</p>
<pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">TransactionFactory
</span>{
    <span style="color: blue">private </span>Func&lt;<span style="color: #2b91af">Transaction</span>&gt; _factoryMethod;

    <span style="color: blue">public </span>TransactionFactory(Func&lt;<span style="color: #2b91af">Transaction</span>&gt; factoryMethod)
    {
        _factoryMethod = factoryMethod;
    }

    <span style="color: blue">public void </span>Do(Action&lt;<span style="color: #2b91af">Transaction</span>&gt; action)
    {
        <span style="color: blue">using </span>(<span style="color: blue">var </span>transaction = _factoryMethod())
        {
            action(transaction);
        }
    }
}

<span style="color: blue">public static void </span>Right(<span style="color: #2b91af">TransactionFactory </span>transactionFactory)
{
    <span style="color: #2b91af">ShoppingService </span>shoppingService = <span style="color: blue">new </span><span style="color: #2b91af">ShoppingService</span>();
    transactionFactory.Do(transaction =&gt;
    {
        shoppingService.AddToCart(transaction, 1, 2, 3);
    });
}</pre><p>The caller receives a TransactionFactory, rather than creating a Transaction himself. But the factory doesn’t just ensure that the Transaction is created properly, it also ensures that it is disposed of properly.</p>
<h3>This step must occur before that step</h3>
<p>Finally, we can even use patterns to prove things about the business process as a whole. For example, A patient must be diagnosed with a disease before the doctor selects a treatment plan.</p>
<p><a href="http://qedcode.com/sites/default/files/ProvableAPIs_914F/image_3.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="http://qedcode.com/sites/default/files/ProvableAPIs_914F/image_thumb_3.png" width="728" height="522" /></a></p>
<p>It’s possible to insert a Diagnosis before a TreatmentPlanSelection, but nothing about the data model requires it. Let’s use a <strong>foreign key</strong> to prove that the steps happen in the right order.</p>
<p><a href="http://qedcode.com/sites/default/files/ProvableAPIs_914F/image_4.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="http://qedcode.com/sites/default/files/ProvableAPIs_914F/image_thumb_4.png" width="730" height="527" /></a></p>
<p>By moving the foreign key from Patient to Diagnosis, we’ve made it impossible to select a treatment plan before diagnosing the patient. We haven’t lost the ability to query for the patient. It just requires one additional join.</p>
<p>Furthermore, we can now easily add logic to verify that the selected treatment plan is approved for the same condition with which the patient was diagnosed. Sadly, we cannot enforce this rule in the data model.</p>
<p>It doesn’t require any special tools to prove that an API is properly used. All it takes is a little forethought to turn an unhelpful API that buzzes and throws exceptions into a helpful, provable API.</p>
  <div id="book-navigation-16" class="book-navigation">
    
        <div class="page-links clear-block">
              <a href="../practice.html" class="page-previous" title="Go to previous page">‹ Practice</a>
                    <a href="../practice.html" class="page-up" title="Go to parent page">up</a>
                    <a href="movement.html" class="page-next" title="Go to next page">Watch movement ›</a>
          </div>
    
  </div>
</div>
    <br />
        	<div class="links-align">
            <div class="bg-links">
                <div class="links-left">
                    <div class="links-right">
                        <div class="links"><ul class="links inline"><li class="blog_usernames_blog first"><a href="../blogs/michael-l-perry.html" title="Read Michael L Perry&#039;s latest blog entries.">Michael L Perry&#039;s blog</a></li>
<li class="comment_add last"><a href="http://qedcode.com/comment/reply/31#comment-form" title="Share your thoughts and opinions related to this posting.">Add new comment</a></li>
</ul></div>
                    </div>
                </div>
            </div>
        </div>
	    <br class="clear" />    
    </div><div id="comments">
  <a id="comment-57"></a>
<div class="comment comment-published">
    <h3 class="title"><a href="provable-apis.html#comment-57" class="active">Make your API impossible to misuse</a></h3>
  <div class="submitted">Submitted by <a href="http://cyrille.martraire.com/" rel="nofollow">Cyrille Martraire</a> (not verified) on Wed, 02/09/2011 - 00:09.</div>
  <div class="content">
    <p>Thanks for the link to this good article on how to prevent users from misusing an API. These advises are so fundamental but seldom expressed, I'm really glad to read that. </p>
<p>I may blog on that soon, but in Java, as I can think of a few more similar tips, like using enums to enumerate every valid combinations of parameters, if their number is not too high, detecting invalid properties as early as possible (e.g. catching null directly in the constructor) well before it is actually used then repair whenever possible, such as replacing nulls with null objects in the constructors or setters; on a similar idea, putting internal caches to memoize the results of slow computations helps mitigate the risk of users misusing an API; this is commonly done for hashcode() and toString() in objects that tend to be used as keys in Map (Dictionary).</p>
<p>Some would object that experienced developers don't get caught hence no need to be so defensive; however I claim that even good senior developers have much worthwhile things to focus on that taking care of not being caught by a trappy API design.</p>
<p>In the wording of Don Norman, these advises on how to guide the use of something would all be called "affordances", from his famous book "The Psychology of Everyday Things" (<a href="http://www.jnd.org/dn.mss/affordances_and.html" title="http://www.jnd.org/dn.mss/affordances_and.html">http://www.jnd.org/dn.mss/affordances_and.html</a>)</p>
      </div>
  <!-- BEGIN: links -->
  <div class="links"><ul class="links"><li class="comment_reply first last"><a href="http://qedcode.com/comment/reply/31/57">reply</a></li>
</ul></div>
  <!-- END: links -->
</div>
<a id="comment-50"></a>
<div class="comment comment-published">
    <h3 class="title"><a href="provable-apis.html#comment-50" class="active">Provable dynamic languages?</a></h3>
  <div class="submitted">Submitted by Anonymous on Mon, 10/25/2010 - 09:31.</div>
  <div class="content">
    <p>You use the type system quite a bit to prove things about code during compile time. Is it possible to do this in a dynamically-typed language?</p>
      </div>
  <!-- BEGIN: links -->
  <div class="links"><ul class="links"><li class="comment_reply first last"><a href="http://qedcode.com/comment/reply/31/50">reply</a></li>
</ul></div>
  <!-- END: links -->
</div>
</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
    <div id="footer">
    	<div class="foot">
        	                <span><a rel="license" href="http://creativecommons.org/licenses/by/3.0/us/"><img alt="Creative Commons License" src="../../licensebuttons.net/l/by/3.0/us/88x31.png" /></a><br /><span dc="http://purl.org/dc/elements/1.1/" href="http://purl.org/dc/dcmitype/Text" property="title" rel="type">Q.E.D. Code</span> by <a cc="http://creativecommons.org/ns#" href="../index.html" property="attributionName" rel="attributionURL">Michael L Perry</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/3.0/us/">Creative Commons Attribution 3.0 United States License</a>.</span>
                    </div>
    </div>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
var _gaq = _gaq || [];_gaq.push(["_setAccount", "UA-389401-7"]);_gaq.push(["_trackPageview"]);(function() {var ga = document.createElement("script");ga.type = "text/javascript";ga.async = true;ga.src = ("https:" == document.location.protocol ? "https://ssl" : "http://www") + ".google-analytics.com/ga.js";var s = document.getElementsByTagName("script")[0];s.parentNode.insertBefore(ga, s);})();
//--><!]]>
</script>
</body>

<!-- Mirrored from qedcode.com/practice/provable-apis by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 12:22:16 GMT -->
</html>
