<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">

<!-- Mirrored from qedcode.com/practice/cache/better-solution by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 12:22:22 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Better solution | Q.E.D. Code</title>
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="prev" href="solution.html" />
<link rel="up" href="../cache.html" />
<link rel="next" href="../../content/conditionals.html" />
<link rel="shortcut icon" href="http://qedcode.com/misc/favicon.ico" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/book/book.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/node/node.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/system/defaults.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/system/system.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/system/system-menus.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/user/user.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/sites/all/modules/mollom/mollom.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/sites/all/modules/views/css/views.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/comment/comment.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/themes/theme073/style.css?2" />
  <script type="text/javascript" src="http://qedcode.com/misc/jquery.js?2"></script>
<script type="text/javascript" src="http://qedcode.com/misc/drupal.js?2"></script>
<script type="text/javascript" src="http://qedcode.com/sites/all/modules/google_analytics/googleanalytics.js?2"></script>
<script type="text/javascript" src="http://qedcode.com/sites/all/modules/mollom/mollom.js?2"></script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
jQuery.extend(Drupal.settings, { "basePath": "/", "googleanalytics": { "trackOutbound": 1, "trackMailto": 1, "trackDownload": 1, "trackDownloadExtensions": "7z|aac|arc|arj|asf|asx|avi|bin|csv|doc|exe|flv|gif|gz|gzip|hqx|jar|jpe?g|js|mp(2|3|4|e?g)|mov(ie)?|msi|msp|pdf|phps|png|ppt|qtm?|ra(m|r)?|sea|sit|tar|tgz|torrent|txt|wav|wma|wmv|wpd|xls|xml|z|zip" } });
//--><!]]>
</script>
  
</head>
  
<body>
    <table id="main">
        <tr>
            <td width="100%" class="header">
            	<div class="top-left">
                	<div class="top-right">
                    	<table width="100%">
                            <tr>
                                <td width="100%" style="height:195px;">
                                    <table width="100%">
                                        <tr>
                                            <td width="">
                                                                                                    <a href="../../index.html" title="Home"><img src="http://qedcode.com/themes/theme073/images/logo.png" alt="Home" border="0" class="logo" /></a><br />
                                                                                                                                                
                                                                                            </td>
                                            <td width="270">
                                                <div class="search-box">
                                                                                                    </div>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                            <tr>
                                <td width="100%" style="height:54px;">
                                                                            <div class="pr-menu">
                                            <ul class="links primary-links"><li class="menu-227 first"><a href="../../node.html" title="">Latest Article</a></li>
<li class="menu-339"><a href="../../podcast.html" title="Q.E.D. Code Podcast">Podcast</a></li>
<li class="menu-219"><a href="../../theory.html" title="">Theory</a></li>
<li class="menu-220"><a href="../../practice.html" title="">Practice</a></li>
<li class="menu-221 last"><a href="../../speaking.html" title="">Speaking</a></li>
</ul>                                            <br class="clear" />
                                        </div>
                                                                    </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </td>
        </tr>
        <tr>
            <td width="100%">
                <table width="100%" >
                    <tr>
                        <td width="189">
                            <div class="left2">
                                                                    <table width="100%">
                                      <tr>
                                        <td width="100%">
                                            <div class="block block-block" id="block-block-2">
	<div class="block-bot">
    	<div class="block-top">
        	<div class="block-indent">
                <div class="title">
                    <h3>About me</h3>
                </div>
                <div class="content"><div style="margin: 15px;">
<p style="margin-bottom: 7px;">Michael L Perry</p>
<p><a href="http://improvingenterprises.com/"><img src="../../images/IE-Logo.png" width="145" alt="Improving Enterprises" /></a></p>
<p style="margin-bottom: 15px;">Principal Consultant</p>
<p><a href="http://twitter.com/michaellperry">@michaellperry</a></p>
</div>
</div>
            </div>
        </div>
    </div>
</div><div class="block block-user" id="block-user-0">
	<div class="block-bot">
    	<div class="block-top">
        	<div class="block-indent">
                <div class="title">
                    <h3>User login</h3>
                </div>
                <div class="content"><form action="http://qedcode.com/practice/cache/better-solution?destination=node%2F12"  accept-charset="UTF-8" method="post" id="user-login-form">
<div><div class="form-item" id="edit-name-wrapper">
 <label for="edit-name">Username: <span class="form-required" title="This field is required.">*</span></label>
 <input type="text" maxlength="60" name="name" id="edit-name" size="15" value="" class="form-text required" />
</div>
<div class="form-item" id="edit-pass-wrapper">
 <label for="edit-pass">Password: <span class="form-required" title="This field is required.">*</span></label>
 <input type="password" name="pass" id="edit-pass"  maxlength="60"  size="15"  class="form-text required" />
</div>
<input type="submit" name="op" id="edit-submit" value="Log in"  class="form-submit" />
<div class="item-list"><ul><li class="first last"><a href="../../user/password.html" title="Request new password via e-mail.">Request new password</a></li>
</ul></div><input type="hidden" name="form_build_id" id="form-b7570de0f4ab339868ab9eb8f1af0cf6" value="form-b7570de0f4ab339868ab9eb8f1af0cf6"  />
<input type="hidden" name="form_id" id="edit-user-login-block" value="user_login_block"  />

</div></form>
</div>
            </div>
        </div>
    </div>
</div>                                        </td>
                                      </tr>
                                    </table>
                                                            </div>
                        </td>
                        <td width="0">
                            <div class="right2">
                                                            </div>
                        </td>
                        <td width="" class="cont-row">
                            <div class="border-left">
                                <div class="border-right">
                                    <div class="border-bot">
                                        <div class="border-top">
                                            <div class="corner-bot-left">
                                                <div class="corner-bot-right">
                                                    <div class="corner-top-left">
                                                        <div class="corner-top-right">
                                                            <div class="cent">
                                                                                                                                                                                                
                                                                                                                        
                                                                <h2>Better solution</h2>
                                                                                                                                                                                                                                                                 
                                                                                                                    
                                                                                                                    
                                                              <!-- start main content -->
                                                            <div class="node">
	    <div class="taxonomy"></div>
  
    <div class="content"><p>The solution left the cache too constraining. While it was correct, it was too tightly locked. All users of the class will line up behind one another, whether they are after the same data or not.</p>
<p>To resolve this problem, let's move the lock. Instead of locking on the cache while fetching the value, let's lock on the key. Two clients accessing the cache with the same key will line up, but clients with different keys will not.</p>
<p>But we can't lock on the key itself. We need to lock on something with identity. The identity of the key is not important. A client can create a new instance of the key having the same value, and that should qualify as the same key. So we have to look elsewhere.</p>
<p>Fortunately, the value of the key is used to find an object in the dictionary. That object <em>does</em> have identity. So we move the lock there.</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> CachedObject&lt;TValue&gt;
{
    <span style="color: blue">private</span> TValue _value;
    <span style="color: blue">private</span> <span style="color: blue">bool</span> _fetched = <span style="color: maroon">false</span>;
    <span style="color: blue">public</span> DateTime DateCached { <span style="color: blue">get</span>; <span style="color: blue">private</span> <span style="color: blue">set</span>; }

    <span style="color: blue">public</span> CachedObject(DateTime dateCached)
    {
        DateCached = dateCached;
    }

    <span style="color: blue">public</span> TValue Value
    {
        <span style="color: blue">get</span> { <span style="color: blue">return</span> _value; }
        <span style="color: blue">set</span> { _value = value; _fetched = <span style="color: maroon">true</span>; }
    }

    <span style="color: blue">public</span> <span style="color: blue">bool</span> Fetched
    {
        <span style="color: blue">get</span> { <span style="color: blue">return</span> _fetched; }
    }
}

<span style="color: blue">public</span> <span style="color: blue">class</span> Cache&lt;TKey, TValue&gt;
{
    <span style="color: blue">private</span> TimeSpan _expiry;
    <span style="color: blue">private</span> Dictionary&lt;TKey, CachedObject&lt;TValue&gt;&gt; _store =
        <span style="color: blue">new</span> Dictionary&lt;TKey, CachedObject&lt;TValue&gt;&gt;();

    <span style="color: blue">public</span> Cache(TimeSpan expiry)
    {
        _expiry = expiry;
    }

    <span style="color: blue">public</span> TValue Get(TKey key, Func&lt;TKey, TValue&gt; fetch)
    {
        CachedObject&lt;TValue&gt; found;

        <span style="color: blue">lock</span> (_store)
        {
            <span style="color: green">// If the object is not in the cache, or it is expired,</span>
            <span style="color: green">// fetch it and add it to the cache.</span>
            DateTime now = DateTime.Now;
            <span style="color: blue">if</span> (_store.TryGetValue(key, <span style="color: blue">out</span> found) &amp;&amp;
                found.DateCached + _expiry &gt; now)
            {
                <span style="color: blue">return</span> found.Value;
            }

            found = <span style="color: blue">new</span> CachedObject&lt;TValue&gt;(now);
            _store.Add(key, found);
        }

        <span style="color: blue">lock</span> (found)
        {
            <span style="color: blue">if</span> (!found.Fetched)
                found.Value = fetch(key);
            <span style="color: blue">return</span> found.Value;
        }
    }
}</pre><p>The Get method locks first on the cache. This protects the data structure, and ensures that we get just one instance of CachedObject. Once it has that, it locks on the found CachedObject so that clients after the same key line up.</p>
<p>Inside the lock, it checks to see whether the value has already been fetched. If not, this thread is the first in line, so it fetches the value. But if it <em>has</em> already been fetched, then the thread was not the first in line and can just use the fetched object.</p>
<p>The above is not a formal proof, and has many logical holes. Hopefully we'll have time to shore it up, and possibly find bugs in the code along the way. This is the kind of code that definitely needs to be proven. Sure, unit testing can give us some confidence, but no amount of unit testing can verify that this code is completely thread safe.</p>
  <div id="book-navigation-16" class="book-navigation">
    
        <div class="page-links clear-block">
              <a href="solution.html" class="page-previous" title="Go to previous page">‹ Solution</a>
                    <a href="../cache.html" class="page-up" title="Go to parent page">up</a>
                    <a href="../../content/conditionals.html" class="page-next" title="Go to next page">Conditionals ›</a>
          </div>
    
  </div>
</div>
    <br />
        	<div class="links-align">
            <div class="bg-links">
                <div class="links-left">
                    <div class="links-right">
                        <div class="links"><ul class="links inline"><li class="blog_usernames_blog first"><a href="../../blogs/michael-l-perry.html" title="Read Michael L Perry&#039;s latest blog entries.">Michael L Perry&#039;s blog</a></li>
<li class="comment_add last"><a href="http://qedcode.com/comment/reply/12#comment-form" title="Share your thoughts and opinions related to this posting.">Add new comment</a></li>
</ul></div>
                    </div>
                </div>
            </div>
        </div>
	    <br class="clear" />    
    </div>                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
    <div id="footer">
    	<div class="foot">
        	                <span><a rel="license" href="http://creativecommons.org/licenses/by/3.0/us/"><img alt="Creative Commons License" src="../../../licensebuttons.net/l/by/3.0/us/88x31.png" /></a><br /><span dc="http://purl.org/dc/elements/1.1/" href="http://purl.org/dc/dcmitype/Text" property="title" rel="type">Q.E.D. Code</span> by <a cc="http://creativecommons.org/ns#" href="../../index.html" property="attributionName" rel="attributionURL">Michael L Perry</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/3.0/us/">Creative Commons Attribution 3.0 United States License</a>.</span>
                    </div>
    </div>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
var _gaq = _gaq || [];_gaq.push(["_setAccount", "UA-389401-7"]);_gaq.push(["_trackPageview"]);(function() {var ga = document.createElement("script");ga.type = "text/javascript";ga.async = true;ga.src = ("https:" == document.location.protocol ? "https://ssl" : "http://www") + ".google-analytics.com/ga.js";var s = document.getElementsByTagName("script")[0];s.parentNode.insertBefore(ga, s);})();
//--><!]]>
</script>
</body>

<!-- Mirrored from qedcode.com/practice/cache/better-solution by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 12:22:22 GMT -->
</html>
