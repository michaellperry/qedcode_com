<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">

<!-- Mirrored from qedcode.com/blogs/michael-l-perry?page=7 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 12:22:18 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Michael L Perry's blog | Q.E.D. Code</title>
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="alternate" type="application/rss+xml" title="RSS - Michael L Perry&#039;s blog" href="michael-l-perry/feed" />
<link rel="shortcut icon" href="http://qedcode.com/misc/favicon.ico" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/book/book.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/node/node.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/system/defaults.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/system/system.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/system/system-menus.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/user/user.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/sites/all/modules/mollom/mollom.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/sites/all/modules/views/css/views.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/themes/theme073/style.css?2" />
  <script type="text/javascript" src="http://qedcode.com/misc/jquery.js?2"></script>
<script type="text/javascript" src="http://qedcode.com/misc/drupal.js?2"></script>
<script type="text/javascript" src="http://qedcode.com/sites/all/modules/google_analytics/googleanalytics.js?2"></script>
<script type="text/javascript" src="http://qedcode.com/sites/all/modules/mollom/mollom.js?2"></script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
jQuery.extend(Drupal.settings, { "basePath": "/", "googleanalytics": { "trackOutbound": 1, "trackMailto": 1, "trackDownload": 1, "trackDownloadExtensions": "7z|aac|arc|arj|asf|asx|avi|bin|csv|doc|exe|flv|gif|gz|gzip|hqx|jar|jpe?g|js|mp(2|3|4|e?g)|mov(ie)?|msi|msp|pdf|phps|png|ppt|qtm?|ra(m|r)?|sea|sit|tar|tgz|torrent|txt|wav|wma|wmv|wpd|xls|xml|z|zip" } });
//--><!]]>
</script>
  
</head>
  
<body>
    <table id="main">
        <tr>
            <td width="100%" class="header">
            	<div class="top-left">
                	<div class="top-right">
                    	<table width="100%">
                            <tr>
                                <td width="100%" style="height:195px;">
                                    <table width="100%">
                                        <tr>
                                            <td width="">
                                                                                                    <a href="../index.html" title="Home"><img src="http://qedcode.com/themes/theme073/images/logo.png" alt="Home" border="0" class="logo" /></a><br />
                                                                                                                                                
                                                                                            </td>
                                            <td width="270">
                                                <div class="search-box">
                                                                                                    </div>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                            <tr>
                                <td width="100%" style="height:54px;">
                                                                            <div class="pr-menu">
                                            <ul class="links primary-links"><li class="menu-227 first"><a href="../node.html" title="">Latest Article</a></li>
<li class="menu-339"><a href="../podcast.html" title="Q.E.D. Code Podcast">Podcast</a></li>
<li class="menu-219"><a href="../theory.html" title="">Theory</a></li>
<li class="menu-220"><a href="../practice.html" title="">Practice</a></li>
<li class="menu-221 last"><a href="../speaking.html" title="">Speaking</a></li>
</ul>                                            <br class="clear" />
                                        </div>
                                                                    </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </td>
        </tr>
        <tr>
            <td width="100%">
                <table width="100%" >
                    <tr>
                        <td width="189">
                            <div class="left2">
                                                                    <table width="100%">
                                      <tr>
                                        <td width="100%">
                                            <div class="block block-block" id="block-block-2">
	<div class="block-bot">
    	<div class="block-top">
        	<div class="block-indent">
                <div class="title">
                    <h3>About me</h3>
                </div>
                <div class="content"><div style="margin: 15px;">
<p style="margin-bottom: 7px;">Michael L Perry</p>
<p><a href="http://improvingenterprises.com/"><img src="../images/IE-Logo.png" width="145" alt="Improving Enterprises" /></a></p>
<p style="margin-bottom: 15px;">Principal Consultant</p>
<p><a href="http://twitter.com/michaellperry">@michaellperry</a></p>
</div>
</div>
            </div>
        </div>
    </div>
</div><div class="block block-user" id="block-user-0">
	<div class="block-bot">
    	<div class="block-top">
        	<div class="block-indent">
                <div class="title">
                    <h3>User login</h3>
                </div>
                <div class="content"><form action="http://qedcode.com/blogs/michael-l-perry?destination=blog%2F1%3Fpage%3D7"  accept-charset="UTF-8" method="post" id="user-login-form">
<div><div class="form-item" id="edit-name-wrapper">
 <label for="edit-name">Username: <span class="form-required" title="This field is required.">*</span></label>
 <input type="text" maxlength="60" name="name" id="edit-name" size="15" value="" class="form-text required" />
</div>
<div class="form-item" id="edit-pass-wrapper">
 <label for="edit-pass">Password: <span class="form-required" title="This field is required.">*</span></label>
 <input type="password" name="pass" id="edit-pass"  maxlength="60"  size="15"  class="form-text required" />
</div>
<input type="submit" name="op" id="edit-submit" value="Log in"  class="form-submit" />
<div class="item-list"><ul><li class="first last"><a href="../user/password.html" title="Request new password via e-mail.">Request new password</a></li>
</ul></div><input type="hidden" name="form_build_id" id="form-147ebc06fb51a16a51a043f649c4d668" value="form-147ebc06fb51a16a51a043f649c4d668"  />
<input type="hidden" name="form_id" id="edit-user-login-block" value="user_login_block"  />

</div></form>
</div>
            </div>
        </div>
    </div>
</div>                                        </td>
                                      </tr>
                                    </table>
                                                            </div>
                        </td>
                        <td width="0">
                            <div class="right2">
                                                            </div>
                        </td>
                        <td width="" class="cont-row">
                            <div class="border-left">
                                <div class="border-right">
                                    <div class="border-bot">
                                        <div class="border-top">
                                            <div class="corner-bot-left">
                                                <div class="corner-bot-right">
                                                    <div class="corner-top-left">
                                                        <div class="corner-top-right">
                                                            <div class="cent">
                                                                                                                                                                                                
                                                                                                                        
                                                                <h2>Michael L Perry's blog</h2>
                                                                                                                                                                                                                                                                 
                                                                                                                    
                                                                                                                    
                                                              <!-- start main content -->
                                                            <div class="item-list"></div><div class="node">
	    	
			            <div class="bg-h2">
                <h1 class="title"><a href="../practice/socket/solution.html">Solution</a></h1>
                <div class="submit"><span class="submitted">Submitted by Michael L Perry on Sat, 10/10/2009 - 23:18</span></div>
            </div>
       
        <div class="taxonomy"></div>
  
    <div class="content"><p>Two weeks ago, I assigned <a href="http://adventuresinsoftware.com/blog/?p=440">homework</a>. Rewrite the .NET Socket API so that you can prove the following assertions:
<ul>
<li>You cannot use a Socket returned from Accept to accept any additional connections from the connection queue.
</li><li>You cannot call Accept, Bind, Connect, Listen, Receive, or Send if the socket has been closed.
</li><li>You must call Bind before you can call the Listen method.
</li><li>You must call Listen before calling Accept.
</li><li>Connect(string host, int port) can only be called if addressFamily is either InterNetwork or InterNetworkV6.
</li><li>Connect cannot be called if Listen has been called.
</li><li>You have to either call Connect or Accept before Sending and Receiving data.
</li><li>If the socket has been previously disconnected, then you cannot use Connect to restore the connection. </li>
</ul>
</p><p> These assertions are prominently listed in the MSDN documentation. Why not roll them into the API itself? Let the compiler prove that we are using sockets correctly. Last week, I gave you a <a href="http://adventuresinsoftware.com/blog/?p=445">hint</a>. I moved the Send and Receive methods out to a different class so that we can prove that you've called Accept or Connect prior to Send or Receive. Both Accept and Connect became factory methods. You must call the factory before you get the object, and you must get the object before you call its methods. Q.E.D. Let's start from there and prove the rest of the assertions. <strong>Starting point</strong>
<ul>
<li>You have to either call Connect or Accept before Sending and Receiving data. </li>
</ul>
<pre>public class ConnectedSocket
{
    public int Receive(byte[] buffer);
    public int Send(byte[] buffer);
}

public class Socket : IDisposable
{
    public Socket(SocketInformation socketInformation);
    public Socket(AddressFamily addressFamily, SocketType socketType, ProtocolType protocolType);

    public ConnectedSocket Accept();
    public void Bind(EndPoint localEP);
    public ConnectedSocket Connect(EndPoint remoteEP);
    public ConnectedSocket Connect(string host, int port);
    public void Dispose();
    public void Listen(int backlog);
}</pre></p><p>Looking through the list of assertions, we find that this one is already taken care of by the first change:</p>
<ul>
<li>You cannot use a Socket returned from Accept to accept any additional connections from the connection queue. </li>
</ul>
<p>The ConnectedSocket class doesn't have an Accept method, so you can't call it. Q.E.D.<br />
<strong>Other prerequisites</strong>There are three other prerequisite assertions that we can prove in exactly the same way:</p>
<ul>
<li>You must call Bind before you can call the Listen method.
</li><li>You must call Listen before calling Accept.
</li><li>Connect cannot be called if Listen has been called. </li>
</ul>
<pre>public class Socket : IDisposable
{
    public Socket(SocketInformation socketInformation);
    public Socket(AddressFamily addressFamily, SocketType socketType, ProtocolType protocolType);

    public <strong>BoundSocket</strong> Bind(EndPoint localEP);
    public ConnectedSocket Connect(EndPoint remoteEP);
    public ConnectedSocket Connect(string host, int port);
    public void Dispose();
}

public class BoundSocket
{
    public ListeningSocket Listen(int backlog);
    public ConnectedSocket Connect(EndPoint remoteEP);
    public ConnectedSocket Connect(string host, int port);
}

public class ListeningSocket
{
    public ConnectedSocket Accept();
}</pre><p>Bind becomes a factory for the class that gives you Listen. Bind does not take away your ability to call Connect. Listen does.<br />
<strong>Factory and product</strong>Factories are great prerequisites. Now that it is becoming more obvious that we are using that pattern, let's rename Socket and move IDisposable to the product.</p>
<pre>public class <strong>SocketFactory</strong>
{
    public SocketFactory(SocketInformation socketInformation);
    public SocketFactory(AddressFamily addressFamily, SocketType socketType, ProtocolType protocolType);

    public BoundSocket Bind(EndPoint localEP);
    public ConnectedSocket Connect(EndPoint remoteEP);
    public ConnectedSocket Connect(string host, int port);
}

public class ConnectedSocket : <strong>IDisposable</strong>
{
    public int Receive(byte[] buffer);
    public int Send(byte[] buffer);
    public void Dispose();
}</pre><p>The ConnectedSocket is the ultimate product. That's the socket that needs to be closed. And what do you know, this change proves another of our assertions:</p>
<ul>
<li>If the socket has been previously disconnected, then you cannot use Connect to restore the connection. </li>
</ul>
<p>It is impossible to call Connect on a socket that has been disposed, since they aren't the same object anymore.<br />
<strong>Dispose once</strong>Now that the Dispose method is where it belongs, let's focus on the assertion most concerned with its use:</p>
<ul>
<li>You cannot call Accept, Bind, Connect, Listen, Receive, or Send if the socket has been closed. </li>
</ul>
<p>Accept, Bind, Connect, and Listen have already been taken care of, since they have become factory methods. To handle Send and Receive, we turn every ConnectedSocket factory into a callback:</p>
<pre>public class ConnectedSocket
{
    public int Receive(byte[] buffer);
    public int Send(byte[] buffer);
}

public <strong>void</strong> Connect(string host, int port, <strong>Action&lt;ConnectedSocket&gt;</strong> action);</pre><p>We have taken away the capability of disposing a socket. The factory does it on the consumer's behalf. Since there is no way for the consumer to call Dispose, and since the callback returns before Dispose is called, there is no way to call Send or Receive after Dispose. Q.E.D.<br />
<strong>Specialized factory</strong>Which leaves us with one final assertion:</p>
<ul>
<li>Connect(string host, int port) can only be called if addressFamily is either InterNetwork or InterNetworkV6. </li>
</ul>
<p>Again, we want to move the restricted method into its own special class. But now, we want to enforce that certain values are provided, not that certain methods are called. We'll limit this by creating our own smaller enumeration.</p>
<pre>public class IPSocketFactory : SocketFactory
{
    public enum Version { V4, V6 }
    public IPSocketFactory(<strong>Version version</strong>, SocketType socketType, ProtocolType protocolType)
        : base(
            version == Version.V4 ? AddressFamily.InterNetwork : AddressFamily.InterNetworkV6,
            socketType,
            protocolType) { }

    public void Connect(string host, int port, Action&lt;ConnectedSocket&gt; action);
}</pre><p>If you want to call the Connect overload with two parameters, you have to use the limited enumeration to get the right factory. I didn't mess with the overloaded constructor, because it complicates things.<br />
One slight wrinkle. In a previous change we created a copy of the Connect method, since it can be called after Bind(). So we make the same change there:</p>
<pre>public class IPBoundSocket : BoundSocket
{
    public void Connect(string host, int port, Action&lt;ConnectedSocket&gt; action);
}

public class IPSocketFactory : SocketFactory
{
    public enum Version { V4, V6 }
    public IPSocketFactory(Version version, SocketType socketType, ProtocolType protocolType)
        : base(
            version == Version.V4 ? AddressFamily.InterNetwork : AddressFamily.InterNetworkV6,
            socketType,
            protocolType) { }

    public <strong>IPBoundSocket</strong> Bind(EndPoint localEP);
    public void Connect(string host, int port, Action&lt;ConnectedSocket&gt; action);
}</pre><p>The only way to get an IPBoundSocket is to use the IPSocketFactory. Therefore, you must have selected one of the Internet protocols. By the way, this is taking advantage of a little-used feature of C# called covarience. This is the one part of the proof that might not work in other languages.<br />
So there you have it. A provably correct Socket API. There is no way to use it incorrectly. The compiler enforces all of the assertions that we would otherwise have to read the documentation to discover.</p>
</div>
    <br />
        	<div class="links-align">
            <div class="bg-links">
                <div class="links-left">
                    <div class="links-right">
                        <div class="links"><ul class="links inline"><li class="comment_add first last"><a href="http://qedcode.com/comment/reply/15#comment-form" title="Add a new comment to this page.">Add new comment</a></li>
</ul></div>
                    </div>
                </div>
            </div>
        </div>
	    <br class="clear" />    
    </div><div class="node">
	    	
			            <div class="bg-h2">
                <h1 class="title"><a href="../practice/socket/hint.html">Hint</a></h1>
                <div class="submit"><span class="submitted">Submitted by Michael L Perry on Sat, 10/10/2009 - 23:17</span></div>
            </div>
       
        <div class="taxonomy"></div>
  
    <div class="content"><p>Your homework is extended for another week, but let me give you a hint what I'm looking for. The problem was to <a href="http://adventuresinsoftware.com/blog/?p=440">Fix the Socket API</a>. Rewrite the .NET Socket interface so that the assertions made in the MSDN documentation can be proven. To give you an example of what I'm looking for, take the following assertion:
<ul>
<li>You have to either call Connect or Accept before Sending and Receiving data. </li>
</ul>
</p><p> This is a prerequisite assertion. We must first call Connect or Accept, then we can call Send or Receive. To prove this assertion, I'll use factory methods. Here's the original Socket class:</p>
<pre>public class Socket : IDisposable
{
    public Socket(SocketInformation socketInformation);
    public Socket(AddressFamily addressFamily, SocketType socketType, ProtocolType protocolType);

    public Socket Accept();
    public void Bind(EndPoint localEP);
    public void Connect(EndPoint remoteEP);
    public void Connect(string host, int port);
    public void Dispose();
    public void Listen(int backlog);
    public int Receive(byte[] buffer);
    public int Send(byte[] buffer);
}</pre><p>Move the Send and Receive methods out of this class. We cannot call them yet. Move them into a new class called ConnectedSocket.</p>
<pre>public class ConnectedSocket
{
    public int Receive(byte[] buffer);
    public int Send(byte[] buffer);
}</pre><p>To prove that we have to call Connect or Accept before any of the ConnectedSocket methods, we make Connect and Accept factory methods:</p>
<pre>public class Socket : IDisposable
{
    public Socket(SocketInformation socketInformation);
    public Socket(AddressFamily addressFamily, SocketType socketType, ProtocolType protocolType);

    public <strong>ConnectedSocket</strong> Accept();
    public void Bind(EndPoint localEP);
    public <strong>ConnectedSocket</strong> Connect(EndPoint remoteEP);
    public <strong>ConnectedSocket</strong> Connect(string host, int port);
    public void Dispose();
    public void Listen(int backlog);
}</pre><p>This API proves one of the assertions in the MSDN documentation. Try the others on your own. Answers will be posted next week.</p>
</div>
    <br />
        	<div class="links-align">
            <div class="bg-links">
                <div class="links-left">
                    <div class="links-right">
                        <div class="links"><ul class="links inline"><li class="comment_add first last"><a href="http://qedcode.com/comment/reply/14#comment-form" title="Add a new comment to this page.">Add new comment</a></li>
</ul></div>
                    </div>
                </div>
            </div>
        </div>
	    <br class="clear" />    
    </div><div class="node">
	    	
			            <div class="bg-h2">
                <h1 class="title"><a href="../practice/socket.html">Socket API</a></h1>
                <div class="submit"><span class="submitted">Submitted by Michael L Perry on Sat, 10/10/2009 - 23:16</span></div>
            </div>
       
        <div class="taxonomy"></div>
  
    <div class="content"><p>Your task is to fix the .NET Socket API. This is as unhelpful as an API gets. There are several rules that a user of a Socket must follow. Create an API that proves that they are following all of the rules. Here is the relevant part of the existing unhelpful API:</p>
<pre>public class Socket : IDisposable
{
    public Socket(SocketInformation socketInformation);
    public Socket(AddressFamily addressFamily, SocketType socketType, ProtocolType protocolType);

    public Socket Accept();
    public void Bind(EndPoint localEP);
    public void Connect(EndPoint remoteEP);
    public void Connect(string host, int port);
    public void Dispose();
    public void Listen(int backlog);
    public int Receive(byte[] buffer);
    public int Send(byte[] buffer);
}</pre><p>Here are the rules as documented in MSDN:</p>
<ul>
<li>You cannot use a Socket returned from Accept to accept any additional connections from the connection queue.
</li><li>You cannot call Accept, Bind, Connect, Listen, Receive, or Send if the socket has been closed.
</li><li>You must call Bind before you can call the Listen method.
</li><li>You must call Listen before calling Accept.
</li><li>Connect(string host, int port) can only be called if addressFamily is either InterNetwork or InterNetworkV6.
</li><li>Connect cannot be called if Listen has been called.
</li><li>You have to either call Connect or Accept before Sending and Receiving data.
</li><li>If the socket has been previously disconnected, then you cannot use Connect to restore the connection. </li>
</ul>
<p>You may use as the basis of your proof the concepts that were discussed in previous Q.E.D. articles, including:</p>
<ul>
<li><a href="http://adventuresinsoftware.com/blog/?p=410">Math 101 for developers</a>
</li><li><a href="http://adventuresinsoftware.com/blog/?p=415">Proving prerequisites</a>
</li><li><a href="http://adventuresinsoftware.com/blog/?p=416">The constructor: the strongest of all methods</a>
</li><li><a href="http://adventuresinsoftware.com/blog/?p=429">Closure</a>
</li><li><a href="http://adventuresinsoftware.com/blog/?p=432">Proof based on imperative programming</a>
</li><li><a href="http://adventuresinsoftware.com/blog/?p=436">Fixing an unhelpful API</a> </li>
</ul>
<p>Please post responses in the comments, email them to <a href="mailto:mperry@adventuresinsoftware.com">mperry@adventuresinsoftware.com</a>, or post links on your own blog. I will share my solution next week.</p>
</div>
    <br />
        	<div class="links-align">
            <div class="bg-links">
                <div class="links-left">
                    <div class="links-right">
                        <div class="links"><ul class="links inline"><li class="comment_add first last"><a href="http://qedcode.com/comment/reply/13#comment-form" title="Add a new comment to this page.">Add new comment</a></li>
</ul></div>
                    </div>
                </div>
            </div>
        </div>
	    <br class="clear" />    
    </div><div class="node">
	    	
			            <div class="bg-h2">
                <h1 class="title"><a href="../practice/cache/better-solution.html">Better solution</a></h1>
                <div class="submit"><span class="submitted">Submitted by Michael L Perry on Sat, 10/10/2009 - 23:16</span></div>
            </div>
       
        <div class="taxonomy"></div>
  
    <div class="content"><p>The solution left the cache too constraining. While it was correct, it was too tightly locked. All users of the class will line up behind one another, whether they are after the same data or not.</p>
<p>To resolve this problem, let's move the lock. Instead of locking on the cache while fetching the value, let's lock on the key. Two clients accessing the cache with the same key will line up, but clients with different keys will not.</p>
<p>But we can't lock on the key itself. We need to lock on something with identity. The identity of the key is not important. A client can create a new instance of the key having the same value, and that should qualify as the same key. So we have to look elsewhere.</p>
<p>Fortunately, the value of the key is used to find an object in the dictionary. That object <em>does</em> have identity. So we move the lock there.</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> CachedObject&lt;TValue&gt;
{
    <span style="color: blue">private</span> TValue _value;
    <span style="color: blue">private</span> <span style="color: blue">bool</span> _fetched = <span style="color: maroon">false</span>;
    <span style="color: blue">public</span> DateTime DateCached { <span style="color: blue">get</span>; <span style="color: blue">private</span> <span style="color: blue">set</span>; }

    <span style="color: blue">public</span> CachedObject(DateTime dateCached)
    {
        DateCached = dateCached;
    }

    <span style="color: blue">public</span> TValue Value
    {
        <span style="color: blue">get</span> { <span style="color: blue">return</span> _value; }
        <span style="color: blue">set</span> { _value = value; _fetched = <span style="color: maroon">true</span>; }
    }

    <span style="color: blue">public</span> <span style="color: blue">bool</span> Fetched
    {
        <span style="color: blue">get</span> { <span style="color: blue">return</span> _fetched; }
    }
}

<span style="color: blue">public</span> <span style="color: blue">class</span> Cache&lt;TKey, TValue&gt;
{
    <span style="color: blue">private</span> TimeSpan _expiry;
    <span style="color: blue">private</span> Dictionary&lt;TKey, CachedObject&lt;TValue&gt;&gt; _store =
        <span style="color: blue">new</span> Dictionary&lt;TKey, CachedObject&lt;TValue&gt;&gt;();

    <span style="color: blue">public</span> Cache(TimeSpan expiry)
    {
        _expiry = expiry;
    }

    <span style="color: blue">public</span> TValue Get(TKey key, Func&lt;TKey, TValue&gt; fetch)
    {
        CachedObject&lt;TValue&gt; found;

        <span style="color: blue">lock</span> (_store)
        {
            <span style="color: green">// If the object is not in the cache, or it is expired,</span>
            <span style="color: green">// fetch it and add it to the cache.</span>
            DateTime now = DateTime.Now;
            <span style="color: blue">if</span> (_store.TryGetValue(key, <span style="color: blue">out</span> found) &amp;&amp;
                found.DateCached + _expiry &gt; now)
            {
                <span style="color: blue">return</span> found.Value;
            }

            found = <span style="color: blue">new</span> CachedObject&lt;TValue&gt;(now);
            _store.Add(key, found);
        }

        <span style="color: blue">lock</span> (found)
        {
            <span style="color: blue">if</span> (!found.Fetched)
                found.Value = fetch(key);
            <span style="color: blue">return</span> found.Value;
        }
    }
}</pre><p>The Get method locks first on the cache. This protects the data structure, and ensures that we get just one instance of CachedObject. Once it has that, it locks on the found CachedObject so that clients after the same key line up.</p>
<p>Inside the lock, it checks to see whether the value has already been fetched. If not, this thread is the first in line, so it fetches the value. But if it <em>has</em> already been fetched, then the thread was not the first in line and can just use the fetched object.</p>
<p>The above is not a formal proof, and has many logical holes. Hopefully we'll have time to shore it up, and possibly find bugs in the code along the way. This is the kind of code that definitely needs to be proven. Sure, unit testing can give us some confidence, but no amount of unit testing can verify that this code is completely thread safe.</p>
</div>
    <br />
        	<div class="links-align">
            <div class="bg-links">
                <div class="links-left">
                    <div class="links-right">
                        <div class="links"><ul class="links inline"><li class="comment_add first last"><a href="http://qedcode.com/comment/reply/12#comment-form" title="Add a new comment to this page.">Add new comment</a></li>
</ul></div>
                    </div>
                </div>
            </div>
        </div>
	    <br class="clear" />    
    </div><div class="node">
	    	
			            <div class="bg-h2">
                <h1 class="title"><a href="../practice/cache.html">Cache</a></h1>
                <div class="submit"><span class="submitted">Submitted by Michael L Perry on Sat, 10/10/2009 - 23:15</span></div>
            </div>
       
        <div class="taxonomy"></div>
  
    <div class="content"><p>Given this source code for a cache, rewrite the API to prove that a race condition cannot occur:<br /></p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> CachedObject&lt;TValue&gt;
{
    <span style="color: blue">public</span> TValue Value { <span style="color: blue">get</span>; <span style="color: blue">private</span> <span style="color: blue">set</span>; }
    <span style="color: blue">public</span> DateTime DateCached { <span style="color: blue">get</span>; <span style="color: blue">private</span> <span style="color: blue">set</span>; }

    <span style="color: blue">public</span> CachedObject(TValue value, DateTime dateCached)
    {
        Value = value;
        DateCached = dateCached;
    }
}

<span style="color: blue">public</span> <span style="color: blue">class</span> Cache&lt;TKey, TValue&gt;
{
    <span style="color: blue">private</span> TimeSpan _expiry;
    <span style="color: blue">private</span> Dictionary&lt;TKey, CachedObject&lt;TValue&gt;&gt; _store =
        <span style="color: blue">new</span> Dictionary&lt;TKey, CachedObject&lt;TValue&gt;&gt;();

    <span style="color: blue">public</span> Cache(TimeSpan expiry)
    {
        _expiry = expiry;
    }

    <span style="color: blue">public</span> TValue Get(TKey key)
    {
        CachedObject&lt;TValue&gt; found;

        <span style="color: green">// If the object is in the cache, check the date.</span>
        <span style="color: blue">if</span> (_store.TryGetValue(key, <span style="color: blue">out</span> found) &amp;&amp;
            found.DateCached + _expiry &lt; DateTime.Now)
        {
            <span style="color: blue">return</span> found.Value;
        }
        <span style="color: blue">else</span>
        {
            <span style="color: blue">return</span> <span style="color: blue">default</span>(TValue);
        }
    }

    <span style="color: blue">public</span> <span style="color: blue">void</span> Put(TKey key, TValue value)
    {
        _store.Add(key, <span style="color: blue">new</span> CachedObject&lt;TValue&gt;(value, DateTime.Now));
    }
}</pre><p>The caller has to use it properly for it to work. They have to call Get before Put (prerequisite), and they have to synchronize around the two calls. If they don't, they run the risk of creating a race condition.</p>
<p>A race condition occurs when the outcome of an operation depends upon other operations happening in parallel. If one thread gets finished first, there is one result. If another thread finishes first, there is another. In this case, two threads could try to Get the same value. Finding none, they can both race to fetch the value and put it in the cache.</p>
<p>Rewrite this API to prove that a race condition cannot occur.</p>
</div>
    <br />
        	<div class="links-align">
            <div class="bg-links">
                <div class="links-left">
                    <div class="links-right">
                        <div class="links"><ul class="links inline"><li class="comment_add first last"><a href="http://qedcode.com/comment/reply/11#comment-form" title="Add a new comment to this page.">Add new comment</a></li>
</ul></div>
                    </div>
                </div>
            </div>
        </div>
	    <br class="clear" />    
    </div><div class="node">
	    	
			            <div class="bg-h2">
                <h1 class="title"><a href="../practice/service/fixing-an-unhelpful-api.html">Fixing an unhelpful API</a></h1>
                <div class="submit"><span class="submitted">Submitted by Michael L Perry on Sat, 10/10/2009 - 23:13</span></div>
            </div>
       
        <div class="taxonomy"></div>
  
    <div class="content"><p>Prove the correctness of a service. Here is how it started:</p>
<pre><span style="color: blue">public</span> <span style="color: blue">void</span> DoWorkWithOrderService()
{
    <span style="color: blue">using</span> (ITransaction currentTransaction = <span style="color: blue">new</span> AcidTransaction(_container))
    {
        OrderService.Transaction = currentTransaction;
        OrderService.DoWork();
        currentTransaction.Commit();
    }
}</pre><p>It is only possible to prove the correctness of this code based on the caller (seen here), and not the order service itself. If the caller forgets to initialize the transaction property, if the caller forgets to create the transaction in a using statement, or if the caller forgets to create a new instance per thread, then bad things can happen.</p>
<p><a href="../../adventuresinsoftware.com/blog/wp-content/uploads/2009/09/unhelpful-api.jpg"><img style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" border="0" alt="Unhelpful_API" align="right" src="../../adventuresinsoftware.com/blog/wp-content/uploads/2009/09/unhelpful-api-thumb.jpg" width="244" height="133" /></a> The order service is an unhelpful API. When you approach it, you have to use caution. If you use it in the wrong way, bad things will happen. If you're lucky, it will throw an exception. If you are unlucky, you won't catch errors until you release to production.</p>
<p>An unhelpful API must be approached with fear.</p>
<p><strong>Parameters are prerequisites</strong><br />The first step in improving this unhelpful API is to ensure that a transaction exists before a service method is called. We can do this by turning the property into a parameter.</p>
<p>Before:</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> Service : IService
{
    <span style="color: blue">public</span> ITransaction Transaction
    {
        <span style="color: blue">set</span>;
        <span style="color: blue">get</span>;
    }
    
    <span style="color: blue">public</span> <span style="color: blue">void</span> DoWork() { }
}</pre><p>After:</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> ServiceFactory : IServiceFactory
{
    <span style="color: blue">public</span> IService CreateService(ITransaction transaction)
    {
        <span style="color: blue">return</span> <span style="color: blue">new</span> Service(transaction);
    }
}

<span style="color: blue">public</span> <span style="color: blue">class</span> Service : IService
{
    <span style="color: blue">private</span> ITransaction _transaction;
    
    <span style="color: blue">public</span> Service(ITransaction transaction)
    {
        _transaction = transaction;
    }
    
    <span style="color: blue">public</span> <span style="color: blue">void</span> DoWork() { }
}</pre><p>You cannot get a service from the factory without providing a transaction. Therefore, you cannot make any service calls before providing a transaction. Q.E.D.</p>
<p><strong>Callbacks are prerequisites</strong><br />We have proven that a transaction is provided before a service method is called, but we haven't yet proven that the transaction gets disposed. We can take one more step toward making this a helpful, provable API using a callback.</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> ServiceFactory : IServiceFactory
{
    <span style="color: blue">private</span> ITransactionFactory _transactionFactory;

    <span style="color: blue">public</span> <span style="color: blue">void</span> CallService(Action&lt;IService&gt; action)
    {
        <span style="color: blue">using</span> (ITransaction transaction =
            _transactionFactory.CreateTransaction())
        {
            action(<span style="color: blue">new</span> Service(transaction));
        }
    }
}</pre><p>A transaction factory is injected into the service factory (via constructor not shown here), and that is used to create a transaction as needed. That creation happens within a using statement in the service factory, not in the calling code. There is no way for the caller to forget to do this. Thus we have proven that the transaction gets disposed.</p>
<p>In these two steps, we have transformed an unhelpful API into a helpful one. The unhelpful API offered many options, most of them wrong. The helpful API offers only the options that are correct. It guides the caller in its proper use. It cannot be used incorrectly.</p>
<p>An unhelpful API cannot be proven. It must be approached with fear. A helpful API can be proven. It can be approached with confidence.</p>
</div>
    <br />
        	<div class="links-align">
            <div class="bg-links">
                <div class="links-left">
                    <div class="links-right">
                        <div class="links"><ul class="links inline"><li class="comment_add first last"><a href="http://qedcode.com/comment/reply/10#comment-form" title="Add a new comment to this page.">Add new comment</a></li>
</ul></div>
                    </div>
                </div>
            </div>
        </div>
	    <br class="clear" />    
    </div><div class="node">
	    	
			            <div class="bg-h2">
                <h1 class="title"><a href="../practice/service.html">Service transaction</a></h1>
                <div class="submit"><span class="submitted">Submitted by Michael L Perry on Sat, 10/10/2009 - 23:12</span></div>
            </div>
       
        <div class="taxonomy"></div>
  
    <div class="content"><p>Below is the source code for a service. Prove that:</p>
<ul>
<li>The service has a transaction when it is called.
</li><li>The transaction is disposed.
</li><li>The code is thread safe. </li>
</ul>
<pre><span style="color: blue">public</span> Order GetOrder(<span style="color: blue">int</span> orderId)
{
   <span style="color: blue">return</span> InvokeGetOrder(() =&gt; OrderServiceProvider.GetOrderWithItems(orderId));
}

<span style="color: blue">public</span> Order InvokeGetOrder(Func&lt;Order&gt; function)
{
    Order order;
    <span style="color: blue">using</span> (IBusinessTransactionContext currentBusinessTransactionContext =
        <span style="color: blue">new</span> AcidBusinessTransactionContext(_container, <span style="color: maroon">false</span>))
    {
        OrderServiceProvider.BusinessTransactionContext =
            currentBusinessTransactionContext;

        order = function();
        OrderServiceProvider.BusinessTransactionContext.Commit();
    }

    <span style="color: blue">return</span> order;
}</pre></div>
    <br />
        	<div class="links-align">
            <div class="bg-links">
                <div class="links-left">
                    <div class="links-right">
                        <div class="links"><ul class="links inline"><li class="comment_add first last"><a href="http://qedcode.com/comment/reply/9#comment-form" title="Add a new comment to this page.">Add new comment</a></li>
</ul></div>
                    </div>
                </div>
            </div>
        </div>
	    <br class="clear" />    
    </div><div class="node">
	    	
			            <div class="bg-h2">
                <h1 class="title"><a href="../practice/movement/correction.html">Correct the induction problem</a></h1>
                <div class="submit"><span class="submitted">Submitted by Michael L Perry on Sat, 10/10/2009 - 23:10</span></div>
            </div>
       
        <div class="taxonomy"></div>
  
    <div class="content"><p>Let's take another run at proving that a watch movement with 20 parts has 19 connections.</p>
<p><a href="../../adventuresinsoftware.com/blog/wp-content/uploads/2009/09/sixgears.jpg"><img style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" border="0" alt="SixGears" align="right" src="../../adventuresinsoftware.com/blog/wp-content/uploads/2009/09/sixgears-thumb.jpg" width="235" height="169" /></a> It is difficult to prove that any movement can be constructed one gear at a time by making just one connection with an existing gear. And here is a counter-example to demonstrate the problem.</p>
<p>A ring of six gears, all the same size, is a movement with one degree of freedom. If you construct this movement one gear at a time, you will connect the final gear to two prior components, not to just one. This movement has 6 gears and 6 connections, not the 5 that we want our proof to show.</p>
<p>Something is obviously wrong here. This movement is not what is intended by the problem, but it is not explicitly prohibited either. We need to change the problem:</p>
<p><strong>Given:</strong> A movement with 20 moving parts having one degree of freedom <strong><em>and no redundant connections</em></strong>.</p>
<p><strong>Prove: </strong>There are 19 connections among those parts.</p>
<p>Now our problem is precise enough. While it may seem wrong to change a problem in order to solve it, this is something that happens all the time in software. The requirements are never stated precisely. We always have to go back and ask questions. In the process, we refine the definition of the problem until we agree on something that can be implemented unambiguously.</p>
<p><strong>Find a new induction</strong><br />After changing our problem to make it provable, we still find that our original approach is difficult. In order to prove that any valid movement can be built on part at a time, we have to prove that there is always at least one component connected to only one neighbor. We have to prove the existence of a leaf.</p>
<p>While this is not a terribly difficult proof, there is an easier way. We could choose a less restrictive induction. Rather than assuming that we can build a movement one part at a time, we only need to know that we can build any movement from two smaller movements. This satisfies the requirements of inductive reasoning.</p>
<p>So first, to prove that we can construct any movement from two smaller movements, we just need to select any connection within the movement. Now break this connection. One of two things will happen:</p>
<ul>
<li>You are left with one movement, in which case the connection was redundant. The larger movement was invalid and therefore not covered by the proof.
</li><li>You are left with two movements, each with one degree of freedom. Since we broke only one connection, the others remain intact. Assuming the larger movement had no redundant connections, neither do the smaller ones. </li>
</ul>
<p>So the process of building a movement out of smaller movements is valid. Now we can write our proof:</p>
<ol>
<li>Let M<sub>j+k</sub> be the movement formed by connecting M<sub>j</sub> and M<sub>k</sub>.
</li><li>g(M<sub>j+k</sub>) = g(M<sub>j</sub>) + g(M<sub>k</sub>), because we combined two sets of gears.
</li><li>c(M<sub>j+k</sub>) = c(M<sub>j</sub>) + c(M<sub>k</sub>) + 1, because we added only one new connection.
</li><li>c(M<sub>j+k</sub>) = g(M<sub>j</sub>)-1 + g(M<sub>k</sub>)-1 + 1, by applying the assumption of the induction.
</li><li>c(M<sub>j+k</sub>) = g(M<sub>j</sub>) + g(M<sub>k</sub>) - 1, by association.
</li><li>c(M<sub>j+k</sub>) = g(M<sub>j+k</sub>) - 1, by combining 2 and 5. </li>
</ol>
<p>Q.E.D.</p>
</div>
    <br />
    </div><div class="node">
	    	
			            <div class="bg-h2">
                <h1 class="title"><a href="../practice/movement/inductive-reasoning.html">Inductive reasoning</a></h1>
                <div class="submit"><span class="submitted">Submitted by Michael L Perry on Sat, 10/10/2009 - 23:09</span></div>
            </div>
       
        <div class="taxonomy"></div>
  
    <div class="content"><p>The problem was: <strong>Given:</strong> A movement with 20 moving parts having one degree of freedom. <strong>Prove: </strong>There are ___ connections among those parts. The answer, of course, is 19. But the real exercise is in the proof. This problem is solvable using a technique called inductive reasoning. Inductive reasoning is proving a statement in two parts. First, you prove it for a trivial case. Then, you prove that if it's true for a smaller case, it must be true for a larger case. <strong>State the problem</strong>To begin, we need to define some terms to help us reason about the problem. We'll define the terms M, g(M), and c(M) like this:
<ul>
<li>Let M be a movement with one degree of freedom.
</li><li>Let g(M) be the number of gears in the movement.
</li><li>Let c(M) be the number of connections in the movement.</li>
</ul>
</p><p> Using these terms, we can state the problem as:
<ul>
<li>Proove that c(M) = g(M)-1.</li>
</ul>
</p><p> <strong>Start with the trivial</strong>The trivial case is a movement having a single gear. This movement has no connections, since there are no other gears to which it can connect. Written using our new terms:
<ul>
<li>Let M0 be a movement having only one gear.
</li><li>g(M0) = 1.
</li><li>c(M0) = 0.
</li><li>c(M0) = g(M0) - 1.</li>
</ul>
</p><p> <strong>Build upward</strong>Now if I have a movement Mj, what happens when I add another gear to it? I end up with a movement Mj+1. I want to prove that the connections in Mj+1 are one fewer than the gears. Inductive reasoning lets me assume that this is true for Mj.
<ol>
<li>c(Mj) = g(Mj) - 1.
</li><li>g(Mj+1) = g(Mj) + 1, because I added a gear.
</li><li>c(Mj+1) = c(Mj) + 1, because I connected that gear to exactly one previous gear.
</li><li>c(Mj+1) = g(Mj) - 1 + 1, by combining steps 1 and 3.
</li><li>c(Mj+1) = g(Mj) + 1 - 1, by commuting step 4.
</li><li>c(Mj+1) = g(Mj+1) - 1, by combining steps 2 and 5.</li>
</ol>
</p><p> Q.E.D. <strong>Not so fast</strong>I was imprecise in my reasoning in a few places. While this still led to the correct answer in this case, it might have led to something completely wrong in a different problem. Inductive reasoning requires that you prove that the steps you take to get from a smaller problem to a bigger one will cover all possible problems. You have to prove that you can build a movement one part at a time by connecting that gear to exactly one gear of the previous movement. While this is true, it is by no means obvious. If we can't prove that our induction can build any movement, then we can't use it to prove statements about all movements. What about those that can't be assembled one part at a time? What we need is a different induction, one that more obviously covers all movements.</p>
</div>
    <br />
        	<div class="links-align">
            <div class="bg-links">
                <div class="links-left">
                    <div class="links-right">
                        <div class="links"><ul class="links inline"><li class="comment_add first last"><a href="http://qedcode.com/comment/reply/7#comment-form" title="Add a new comment to this page.">Add new comment</a></li>
</ul></div>
                    </div>
                </div>
            </div>
        </div>
	    <br class="clear" />    
    </div><div class="node">
	    	
			            <div class="bg-h2">
                <h1 class="title"><a href="../practice/movement.html">Watch movement</a></h1>
                <div class="submit"><span class="submitted">Submitted by Michael L Perry on Sat, 10/10/2009 - 23:04</span></div>
            </div>
       
        <div class="taxonomy"></div>
  
    <div class="content"><p>In Q.E.D. Hour, we will be proving things about our code. To get the group started in thinking about proof, I assigned some homework. It has to do with a watch. The mechanism inside of a wristwatch is known as a movement. It has many moving parts, but all of those parts work together in unison. It measures only one thing. It has only one degree of freedom. The secret to why the movement works is not in the parts. It is in the connections between the parts, where a connection is the point at which two moving parts touch. Which brings us to our proof. <strong>Given:</strong> A movement with 20 moving parts having one degree of freedom. <strong>Prove: </strong>There are ___ connections among those parts. Fill in the blank. I'm sure you already know the answer. But the challenge is to prove it. This is representative of the types of proofs that we will write in Q.E.D. Hour.</p>
</div>
    <br />
        	<div class="links-align">
            <div class="bg-links">
                <div class="links-left">
                    <div class="links-right">
                        <div class="links"><ul class="links inline"><li class="comment_add first last"><a href="http://qedcode.com/comment/reply/6#comment-form" title="Add a new comment to this page.">Add new comment</a></li>
</ul></div>
                    </div>
                </div>
            </div>
        </div>
	    <br class="clear" />    
    </div><div class="item-list"><ul class="pager"><li class="pager-first first"><a href="michael-l-perry.html" title="Go to first page" class="active"> first</a></li>
<li class="pager-previous"><a href="michael-l-perryc575.html?page=6" title="Go to previous page" class="active"> previous</a></li>
<li class="pager-item"><a href="michael-l-perry.html" title="Go to page 1" class="active">1</a></li>
<li class="pager-item"><a href="michael-l-perry2679.html?page=1" title="Go to page 2" class="active">2</a></li>
<li class="pager-item"><a href="michael-l-perry4658.html?page=2" title="Go to page 3" class="active">3</a></li>
<li class="pager-item"><a href="michael-l-perry9ba9.html?page=3" title="Go to page 4" class="active">4</a></li>
<li class="pager-item"><a href="michael-l-perryfdb0.html?page=4" title="Go to page 5" class="active">5</a></li>
<li class="pager-item"><a href="michael-l-perryaf4d.html?page=5" title="Go to page 6" class="active">6</a></li>
<li class="pager-item"><a href="michael-l-perryc575.html?page=6" title="Go to page 7" class="active">7</a></li>
<li class="pager-current">8</li>
<li class="pager-item"><a href="michael-l-perryfdfa.html?page=8" title="Go to page 9" class="active">9</a></li>
<li class="pager-next"><a href="michael-l-perryfdfa.html?page=8" title="Go to next page" class="active">next </a></li>
<li class="pager-last last"><a href="michael-l-perryfdfa.html?page=8" title="Go to last page" class="active">last </a></li>
</ul></div>                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
    <div id="footer">
    	<div class="foot">
        	                <span><a rel="license" href="http://creativecommons.org/licenses/by/3.0/us/"><img alt="Creative Commons License" src="../../licensebuttons.net/l/by/3.0/us/88x31.png" /></a><br /><span dc="http://purl.org/dc/elements/1.1/" href="http://purl.org/dc/dcmitype/Text" property="title" rel="type">Q.E.D. Code</span> by <a cc="http://creativecommons.org/ns#" href="../index.html" property="attributionName" rel="attributionURL">Michael L Perry</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/3.0/us/">Creative Commons Attribution 3.0 United States License</a>.</span>
                    </div>
    </div>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
var _gaq = _gaq || [];_gaq.push(["_setAccount", "UA-389401-7"]);_gaq.push(["_trackPageview"]);(function() {var ga = document.createElement("script");ga.type = "text/javascript";ga.async = true;ga.src = ("https:" == document.location.protocol ? "https://ssl" : "http://www") + ".google-analytics.com/ga.js";var s = document.getElementsByTagName("script")[0];s.parentNode.insertBefore(ga, s);})();
//--><!]]>
</script>
</body>

<!-- Mirrored from qedcode.com/blogs/michael-l-perry?page=7 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 12:22:18 GMT -->
</html>
