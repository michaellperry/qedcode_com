<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">

<!-- Mirrored from qedcode.com/toward-pattern-matching-in-csharp by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 12:21:33 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Toward Pattern Matching in C# | Q.E.D. Code</title>
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="http://qedcode.com/misc/favicon.ico" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/book/book.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/node/node.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/system/defaults.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/system/system.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/system/system-menus.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/user/user.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/sites/all/modules/mollom/mollom.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/sites/all/modules/views/css/views.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/comment/comment.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/themes/theme073/style.css?2" />
  <script type="text/javascript" src="http://qedcode.com/misc/jquery.js?2"></script>
<script type="text/javascript" src="http://qedcode.com/misc/drupal.js?2"></script>
<script type="text/javascript" src="http://qedcode.com/sites/all/modules/google_analytics/googleanalytics.js?2"></script>
<script type="text/javascript" src="http://qedcode.com/sites/all/modules/mollom/mollom.js?2"></script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
jQuery.extend(Drupal.settings, { "basePath": "/", "googleanalytics": { "trackOutbound": 1, "trackMailto": 1, "trackDownload": 1, "trackDownloadExtensions": "7z|aac|arc|arj|asf|asx|avi|bin|csv|doc|exe|flv|gif|gz|gzip|hqx|jar|jpe?g|js|mp(2|3|4|e?g)|mov(ie)?|msi|msp|pdf|phps|png|ppt|qtm?|ra(m|r)?|sea|sit|tar|tgz|torrent|txt|wav|wma|wmv|wpd|xls|xml|z|zip" } });
//--><!]]>
</script>
  
</head>
  
<body>
    <table id="main">
        <tr>
            <td width="100%" class="header">
            	<div class="top-left">
                	<div class="top-right">
                    	<table width="100%">
                            <tr>
                                <td width="100%" style="height:195px;">
                                    <table width="100%">
                                        <tr>
                                            <td width="">
                                                                                                    <a href="index.html" title="Home"><img src="http://qedcode.com/themes/theme073/images/logo.png" alt="Home" border="0" class="logo" /></a><br />
                                                                                                                                                
                                                                                            </td>
                                            <td width="270">
                                                <div class="search-box">
                                                                                                    </div>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                            <tr>
                                <td width="100%" style="height:54px;">
                                                                            <div class="pr-menu">
                                            <ul class="links primary-links"><li class="menu-227 first"><a href="node.html" title="">Latest Article</a></li>
<li class="menu-339"><a href="podcast.html" title="Q.E.D. Code Podcast">Podcast</a></li>
<li class="menu-219"><a href="theory.html" title="">Theory</a></li>
<li class="menu-220"><a href="practice.html" title="">Practice</a></li>
<li class="menu-221 last"><a href="speaking.html" title="">Speaking</a></li>
</ul>                                            <br class="clear" />
                                        </div>
                                                                    </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </td>
        </tr>
        <tr>
            <td width="100%">
                <table width="100%" >
                    <tr>
                        <td width="189">
                            <div class="left2">
                                                                    <table width="100%">
                                      <tr>
                                        <td width="100%">
                                            <div class="block block-block" id="block-block-2">
	<div class="block-bot">
    	<div class="block-top">
        	<div class="block-indent">
                <div class="title">
                    <h3>About me</h3>
                </div>
                <div class="content"><div style="margin: 15px;">
<p style="margin-bottom: 7px;">Michael L Perry</p>
<p><a href="http://improvingenterprises.com/"><img src="images/IE-Logo.png" width="145" alt="Improving Enterprises" /></a></p>
<p style="margin-bottom: 15px;">Principal Consultant</p>
<p><a href="http://twitter.com/michaellperry">@michaellperry</a></p>
</div>
</div>
            </div>
        </div>
    </div>
</div><div class="block block-user" id="block-user-0">
	<div class="block-bot">
    	<div class="block-top">
        	<div class="block-indent">
                <div class="title">
                    <h3>User login</h3>
                </div>
                <div class="content"><form action="http://qedcode.com/toward-pattern-matching-in-csharp?destination=node%2F110"  accept-charset="UTF-8" method="post" id="user-login-form">
<div><div class="form-item" id="edit-name-wrapper">
 <label for="edit-name">Username: <span class="form-required" title="This field is required.">*</span></label>
 <input type="text" maxlength="60" name="name" id="edit-name" size="15" value="" class="form-text required" />
</div>
<div class="form-item" id="edit-pass-wrapper">
 <label for="edit-pass">Password: <span class="form-required" title="This field is required.">*</span></label>
 <input type="password" name="pass" id="edit-pass"  maxlength="60"  size="15"  class="form-text required" />
</div>
<input type="submit" name="op" id="edit-submit" value="Log in"  class="form-submit" />
<div class="item-list"><ul><li class="first last"><a href="user/password.html" title="Request new password via e-mail.">Request new password</a></li>
</ul></div><input type="hidden" name="form_build_id" id="form-d5bb0259e8ae39d918475b2852eac065" value="form-d5bb0259e8ae39d918475b2852eac065"  />
<input type="hidden" name="form_id" id="edit-user-login-block" value="user_login_block"  />

</div></form>
</div>
            </div>
        </div>
    </div>
</div>                                        </td>
                                      </tr>
                                    </table>
                                                            </div>
                        </td>
                        <td width="0">
                            <div class="right2">
                                                            </div>
                        </td>
                        <td width="" class="cont-row">
                            <div class="border-left">
                                <div class="border-right">
                                    <div class="border-bot">
                                        <div class="border-top">
                                            <div class="corner-bot-left">
                                                <div class="corner-bot-right">
                                                    <div class="corner-top-left">
                                                        <div class="corner-top-right">
                                                            <div class="cent">
                                                                                                                                                                                                
                                                                                                                        
                                                                <h2>Toward Pattern Matching in C#</h2>
                                                                                                                                                                                                                                                                 
                                                                                                                    
                                                                                                                    
                                                              <!-- start main content -->
                                                            <div class="node">
	    <div class="taxonomy"></div>
  
    <div class="content"><p>A powerful tool in many functional programming languages is called &quot;pattern matching&quot;. It is a concise syntax for expressing conditions based on the shape of a value. For example, in Haskell, the factorial function can be expressed as a pattern:</p>
<pre>factorial :: (Integral a) => a -> a  
factorial 0 = 1  
factorial n = n * factorial (n - 1)
</pre><p>
<a href="http://learnyouahaskell.com/syntax-in-functions">Learn You a Haskell: Syntax in Functions</a></p>
<p>Often the pattern is expressed in terms of the type of the value. For example, Maybe is a type that can either be Nothing or Just some value.</p>
<pre>applyMaybe :: Maybe a -> (a -> Maybe b) -> Maybe b  
applyMaybe Nothing f  = Nothing  
applyMaybe (Just x) f = f x
</pre><p>
<a href="http://learnyouahaskell.com/a-fistful-of-monads">Learn You a Haskell: A Fistful of Monads</a></p>
<p>Notice that the pattern extracts the parts of the value, and gives you names for those parts.</p>
<h3>Toward patterns in C#</h3>
<p>So what would patterns look like in C#? Here&apos;s a start. I&apos;m not sure where I will take this, if anywhere.</p>
<p>Say we wanted to return one of two things from a function, based on whether it was successful or not. </p>
<pre>private Pattern&lt;int, Error&gt; ParseInteger(string s, string description)
{
    int value;
    if (!int.TryParse(s, out value))
        return new Error(new List&lt;string&gt;
        {
            String.Format(&quot;Invalid value for {0}: {1}.&quot;, description, s)
        });
    else
        return value;
}
</pre><p>
We define a Pattern class taking generic parameters indicating the types that could be returned. To make it possible to return the types directly as written above, we define implicit operators.</p>
<pre>public abstract class Pattern&lt;TOption1, TOption2&gt;
{
    public static implicit operator Pattern&lt;TOption1, TOption2&gt;(TOption1 value)
    {
        return new Match&lt;TOption1, TOption1, TOption2&gt;(value);
    }

    public static implicit operator Pattern&lt;TOption1, TOption2&gt;(TOption2 value)
    {
        return new Match&lt;TOption2, TOption1, TOption2&gt;(value);
    }
}
</pre><p>
Here we create a Match type, which inherits Pattern to represent one of the two options.</p>
<pre>class Match&lt;TValue, TOption1, TOption2&gt; : Pattern&lt;TOption1, TOption2&gt;
{
    private readonly TValue _value;

    internal Match(TValue value)
    {
        _value = value;
    }
}
</pre><p>
Unfortunately, there is no way in C# to express the constraint that TValue is either TOption1 or TOption2. However, that constraint is implicit in the way that a Match is constructed. By making this class private and its constructor internal, we ensure that only classes in the assembly (i.e. Pattern) can create a Match.</p>
<h3>Selecting a path based on the pattern</h3>
<p>Now that we have the Pattern class, and can construct a Match to satisfy the pattern, we can select our response. For example, we could do the following:</p>
<pre>ParseInteger(s, &quot;iteration count&quot;)
    .If&lt;int&gt;(i => _configuration.IterationCount = i)
    .If&lt;Error&gt;(HandleError)
</pre><p>
Here HandleError is a method taking an Error object. We can define the If method in Pattern as follows:</p>
<pre>public abstract class Pattern&lt;TOption1, TOption2&gt;
{
    public abstract Pattern&lt;TOption1, TOption2&gt; If&lt;T&gt;(Action&lt;T&gt; action);
}
</pre><p>
Again, we can&apos;t express the generic constraint that T is one of TOption1 or TOption2. And this time, we don&apos;t have any context that enforces that relationship. We just need to trust that the consumer of this API wouldn&apos;t write something that would never match.<br />
We satisfy this abstract method in the Match derived class.</p>
<pre>class Match&lt;TValue, TOption1, TOption2&gt; : Pattern&lt;TOption1, TOption2&gt;
{
    public override Pattern&lt;TOption1, TOption2&gt; If&lt;T&gt;(Action&lt;T&gt; action)
    {
        if (typeof(T) == typeof(TValue))
        {
            action((T)(object)_value);
            return Matched;
        }
        return this;
    }
}
</pre><p>
The C# compiler <em>could</em> actually expand the generic parameters at compile time and come up with a constant for the condition. That would allow it to optimize this method body to one of the two branches. I don&apos;t think it actually <em>does</em>, but it could be measured.</p>
<p>The Matched object returned when the condition is matched is a simple flyweight that always fails an If.</p>
<pre>class Matched&lt;TOption1, TOption2&gt; : Pattern&lt;TOption1, TOption2&gt;
{
    public override Pattern&lt;TOption1, TOption2&gt; If&lt;T&gt;(Action&lt;T&gt; action)
    {
        return this;
    }
}
</pre><p>
The flyweight is instantiated in Pattern.</p>
<pre>public abstract class Pattern&lt;TOption1, TOption2&gt;
{
    protected static readonly Pattern&lt;TOption1, TOption2&gt; Matched = new Matched&lt;TOption1, TOption2&gt;();
}
</pre><h3>Future directions</h3>
<p>To make this Pattern class generally useful, it needs to be expanded in a number of ways. First, the number of options must be made flexible. It should support three, four, or possibly even just one option. This could be done through nesting (Pattern&lt;T1, Pattern&lt;T2, T3&gt;&gt;).</p>
<p>Second, the If method should also support conditions. In Haskell, these are called guard clauses. It isn&apos;t just the type of the expression that matters, it&apos;s also the value.</p>
<p>Third, there should be an Else method that is called if none of the If methods match. This should be easy to construct.</p>
<p>Fourth, the If method should take Func&lt;T, TResult&gt;, and not just Action&lt;T&gt;. You should be able to use pattern matching within an expression. Quite possibly, the expression would return yet more Pattern types based on the types of all of its results, so that patterns could be further composed.</p>
<p>And fifth, we should be able to concisely express an action to be taken at any point within a composition. For example, the HandleError method used above should be called on any path where Error is encountered.</p>
<p>There are almost certainly more ways that this concept can be expanded. Do you have any ideas you would like to try?</p>
</div>
    <br />
        	<div class="links-align">
            <div class="bg-links">
                <div class="links-left">
                    <div class="links-right">
                        <div class="links"><ul class="links inline"><li class="blog_usernames_blog first"><a href="blogs/michael-l-perry.html" title="Read Michael L Perry&#039;s latest blog entries.">Michael L Perry&#039;s blog</a></li>
<li class="comment_add last"><a href="http://qedcode.com/comment/reply/110#comment-form" title="Share your thoughts and opinions related to this posting.">Add new comment</a></li>
</ul></div>
                    </div>
                </div>
            </div>
        </div>
	    <br class="clear" />    
    </div>                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
    <div id="footer">
    	<div class="foot">
        	                <span><a rel="license" href="http://creativecommons.org/licenses/by/3.0/us/"><img alt="Creative Commons License" src="../licensebuttons.net/l/by/3.0/us/88x31.png" /></a><br /><span dc="http://purl.org/dc/elements/1.1/" href="http://purl.org/dc/dcmitype/Text" property="title" rel="type">Q.E.D. Code</span> by <a cc="http://creativecommons.org/ns#" href="index.html" property="attributionName" rel="attributionURL">Michael L Perry</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/3.0/us/">Creative Commons Attribution 3.0 United States License</a>.</span>
                    </div>
    </div>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
var _gaq = _gaq || [];_gaq.push(["_setAccount", "UA-389401-7"]);_gaq.push(["_trackPageview"]);(function() {var ga = document.createElement("script");ga.type = "text/javascript";ga.async = true;ga.src = ("https:" == document.location.protocol ? "https://ssl" : "http://www") + ".google-analytics.com/ga.js";var s = document.getElementsByTagName("script")[0];s.parentNode.insertBefore(ga, s);})();
//--><!]]>
</script>
</body>

<!-- Mirrored from qedcode.com/toward-pattern-matching-in-csharp by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 12:21:33 GMT -->
</html>
