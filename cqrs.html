<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">

<!-- Mirrored from qedcode.com/cqrs by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 12:22:18 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>CQRS | Q.E.D. Code</title>
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="prev" href="content/visual-proof-cap-theorem.html" />
<link rel="up" href="content/distributed-systems.html" />
<link rel="next" href="durability.html" />
<link rel="shortcut icon" href="http://qedcode.com/misc/favicon.ico" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/book/book.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/node/node.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/system/defaults.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/system/system.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/system/system-menus.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/user/user.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/sites/all/modules/mollom/mollom.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/sites/all/modules/views/css/views.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/comment/comment.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/themes/theme073/style.css?2" />
  <script type="text/javascript" src="http://qedcode.com/misc/jquery.js?2"></script>
<script type="text/javascript" src="http://qedcode.com/misc/drupal.js?2"></script>
<script type="text/javascript" src="http://qedcode.com/sites/all/modules/google_analytics/googleanalytics.js?2"></script>
<script type="text/javascript" src="http://qedcode.com/sites/all/modules/mollom/mollom.js?2"></script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
jQuery.extend(Drupal.settings, { "basePath": "/", "googleanalytics": { "trackOutbound": 1, "trackMailto": 1, "trackDownload": 1, "trackDownloadExtensions": "7z|aac|arc|arj|asf|asx|avi|bin|csv|doc|exe|flv|gif|gz|gzip|hqx|jar|jpe?g|js|mp(2|3|4|e?g)|mov(ie)?|msi|msp|pdf|phps|png|ppt|qtm?|ra(m|r)?|sea|sit|tar|tgz|torrent|txt|wav|wma|wmv|wpd|xls|xml|z|zip" } });
//--><!]]>
</script>
  
</head>
  
<body>
    <table id="main">
        <tr>
            <td width="100%" class="header">
            	<div class="top-left">
                	<div class="top-right">
                    	<table width="100%">
                            <tr>
                                <td width="100%" style="height:195px;">
                                    <table width="100%">
                                        <tr>
                                            <td width="">
                                                                                                    <a href="index.html" title="Home"><img src="http://qedcode.com/themes/theme073/images/logo.png" alt="Home" border="0" class="logo" /></a><br />
                                                                                                                                                
                                                                                            </td>
                                            <td width="270">
                                                <div class="search-box">
                                                                                                    </div>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                            <tr>
                                <td width="100%" style="height:54px;">
                                                                            <div class="pr-menu">
                                            <ul class="links primary-links"><li class="menu-227 first"><a href="node.html" title="">Latest Article</a></li>
<li class="menu-339"><a href="podcast.html" title="Q.E.D. Code Podcast">Podcast</a></li>
<li class="menu-219"><a href="theory.html" title="">Theory</a></li>
<li class="menu-220"><a href="practice.html" title="">Practice</a></li>
<li class="menu-221 last"><a href="speaking.html" title="">Speaking</a></li>
</ul>                                            <br class="clear" />
                                        </div>
                                                                    </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </td>
        </tr>
        <tr>
            <td width="100%">
                <table width="100%" >
                    <tr>
                        <td width="189">
                            <div class="left2">
                                                                    <table width="100%">
                                      <tr>
                                        <td width="100%">
                                            <div class="block block-block" id="block-block-2">
	<div class="block-bot">
    	<div class="block-top">
        	<div class="block-indent">
                <div class="title">
                    <h3>About me</h3>
                </div>
                <div class="content"><div style="margin: 15px;">
<p style="margin-bottom: 7px;">Michael L Perry</p>
<p><a href="http://improvingenterprises.com/"><img src="images/IE-Logo.png" width="145" alt="Improving Enterprises" /></a></p>
<p style="margin-bottom: 15px;">Principal Consultant</p>
<p><a href="http://twitter.com/michaellperry">@michaellperry</a></p>
</div>
</div>
            </div>
        </div>
    </div>
</div><div class="block block-user" id="block-user-0">
	<div class="block-bot">
    	<div class="block-top">
        	<div class="block-indent">
                <div class="title">
                    <h3>User login</h3>
                </div>
                <div class="content"><form action="http://qedcode.com/cqrs?destination=node%2F92"  accept-charset="UTF-8" method="post" id="user-login-form">
<div><div class="form-item" id="edit-name-wrapper">
 <label for="edit-name">Username: <span class="form-required" title="This field is required.">*</span></label>
 <input type="text" maxlength="60" name="name" id="edit-name" size="15" value="" class="form-text required" />
</div>
<div class="form-item" id="edit-pass-wrapper">
 <label for="edit-pass">Password: <span class="form-required" title="This field is required.">*</span></label>
 <input type="password" name="pass" id="edit-pass"  maxlength="60"  size="15"  class="form-text required" />
</div>
<input type="submit" name="op" id="edit-submit" value="Log in"  class="form-submit" />
<div class="item-list"><ul><li class="first last"><a href="user/password.html" title="Request new password via e-mail.">Request new password</a></li>
</ul></div><input type="hidden" name="form_build_id" id="form-2d9fd9adc3a616dbe3fa11fc8e781448" value="form-2d9fd9adc3a616dbe3fa11fc8e781448"  />
<input type="hidden" name="form_id" id="edit-user-login-block" value="user_login_block"  />

</div></form>
</div>
            </div>
        </div>
    </div>
</div>                                        </td>
                                      </tr>
                                    </table>
                                                            </div>
                        </td>
                        <td width="0">
                            <div class="right2">
                                                            </div>
                        </td>
                        <td width="" class="cont-row">
                            <div class="border-left">
                                <div class="border-right">
                                    <div class="border-bot">
                                        <div class="border-top">
                                            <div class="corner-bot-left">
                                                <div class="corner-bot-right">
                                                    <div class="corner-top-left">
                                                        <div class="corner-top-right">
                                                            <div class="cent">
                                                                                                                                                                                                
                                                                                                                        
                                                                <h2>CQRS</h2>
                                                                                                                                                                                                                                                                 
                                                                                                                    
                                                                                                                    
                                                              <!-- start main content -->
                                                            <div class="node">
	    <div class="taxonomy"></div>
  
    <div class="content"><p>Greg Young and Udi Dahan have documented a pattern that they found worked well in large-scale distributed systems. They called this pattern Command Query Responsibility Segregation, or CQRS. This pattern is based on the principal of Command Query Separation, or CQS, which is described in Bertrand Meyer’s Object-Oriented Software Construction. It seeks to scale read-heavy components separately from write-heavy components. In order to achieve that scale, the responsibilities for processing write-heavy commands had to be segregated from the responsibility of processing read-heavy queries.</p>
<h3>Command Query Separation</h3>
<p><a href="http://qedcode.com/sites/default/files/CQRS_7A35/image.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: right; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" align="right" src="http://qedcode.com/sites/default/files/CQRS_7A35/image_thumb.png" width="485" height="367" /></a>The underlying principal of Command Query Separation tells us that a method should either change the state of the system, or return results. A method should not do both. <strong>It is very difficult to reason about the behavior of a software system if it changes state whenever you observe it</strong>. The methods that change state are commands. The methods that return results are queries.</p>
<p>It is very easy for a user of the API to recognize commands and queries. Commands declare their return type as “void”. Queries have a non-void return type. This also makes it easy to spot the calls in code. The code will be doing something with the results of queries.</p>
<p>Have you ever seen code that ignores the return value of a method call? The caller probably made a mistake. It’s very difficult to see that mistake in the written code, since you can’t see that the method returns a value. If the method obeyed the principal of Command Query Separation, then it either wouldn’t have any effect on the system, or it wouldn’t have a return value to ignore. Either way, the caller wouldn’t be able to make that mistake.</p>
<p>When code follows the principal of Command Query Separation, callers are encouraged to organize their code in three sections. The first section gathers information by executing queries. The second section makes a decision based on that information. And the third section records the decision by calling a command.</p>
<p>There can be many calls to different objects to get the information the caller needs. These calls can occur in any order. Since the calls have no side-effects, they can be easily reordered. New calls can be inserted with no change in correctness.</p>
<p>There is usually just one command issued at the end of this kind of sequence. Chains of commands open the possibility for corruption and inconsistencies due to partial successes. It is much easier to maintain code in which each command leaves the system in a consistent state. A subsequent sequence of operations can read that state and issue the next command.</p>
<p>This kind of structure is much easier to reason about. In the gather information section, we can rewrite the calls just as we would a mathematical equation. We can apply the commutative and associative properties, because the order in which we execute queries has no effect on their results. There is only one state change in the entire sequence, and that always occurs at the end.</p>
<h3>Command Query Responsibility Segregation</h3>
<p>The CQRS pattern has a much different goal than it’s predecessor, the CQS principal. The goal of CQRS is to scale reads differently than writes.</p>
<p>Many of the systems that we build are read-heavy. We tend to read data much more often and in much higher quantity than we write it. You can actually calculate a ratio for any given system. Take a typical record. It will be written once. How many times will it be read? How many times will it be aggregated to produce a report? How many times will it be shared with the other users of the system? In most systems, it is not surprising to find that the average record is read hundreds or thousands of times. So the ratio of reads to writes is easily two to three orders of magnitude, in most business systems.</p>
<p>Given the read-heavy nature of business systems, when they come under load, it makes sense to scale up the number of resources dedicated to servicing reads. However, if those same resources are responsible for writes, then those resources are wasted. Worse, those resources can put heavier write load on the system, compete with the reads, and counteract the benefit of scaling up in the first place.</p>
<p>Where CQS separates commands from queries at the method level, CQRS separates them at the component level. Some components are responsible for commands – writes – and others are responsible for queries – reads. To scale out a read-heavy business system, you can allocate more resources just to the read components.</p>
<h3>CQRS in practice</h3>
<p>Consider this WCF contract.</p>
<pre class="code">[<span style="color: #2b91af">ServiceContract</span>]
<span style="color: blue">public interface </span><span style="color: #2b91af">IFulfillmentService
</span>{
    [<span style="color: #2b91af">OperationContract</span>]
    <span style="color: #2b91af">Confirmation </span>PlaceOrder(<span style="color: #2b91af">Order </span>order);
}</pre><p>This method does not obey the CQS principal. It is changing the state of the system, and returning a result. Hidden inside of this result is a tracking number. This result is quite expensive. To process an order and get a tracking number, the fulfillment system needs to:</p>
<ul>
<li>Locate inventory</li>
<li>Allocate that inventory to this order</li>
<li>Determine the shipment method</li>
<li>Allocate space on a pallet</li>
<li>Obtain a tracking number from the carrier</li>
</ul>
<p>Because this is returned from a method, all of these steps must be performed synchronously. The caller will have to wait while those steps are performed before they know that their order has even been submitted.</p>
<p>The first step in correcting this problem is to define two methods: a command and a query.</p>
<pre class="code">[<span style="color: #2b91af">ServiceContract</span>]
<span style="color: blue">public interface </span><span style="color: #2b91af">IFulfillmentService
</span>{
    [<span style="color: #2b91af">OperationContract</span>]
    <span style="color: blue">void </span>PlaceOrder(<span style="color: #2b91af">Order </span>order);

    [<span style="color: #2b91af">OperationContract</span>]
    <span style="color: #2b91af">Confirmation </span>CheckOrderStatus(<span style="color: #2b91af">Guid </span>orderId);
}</pre><p>Now the service can return immediately after storing the incoming order. It doesn’t have to go through all of the steps before letting the caller know that the order was received. The caller can come back later and check the status of the order by executing a query.</p>
<p>The next step will be to move the processing of that command to a different component. We will see how to do that in the next article.</p>
<p>For the complete example, please download the code from the <a href="http://github.com/michaellperry/pharmanet">PharmaNet</a> repository on GitHub. Look at the Fulfillment solution for this service.</p>
  <div id="book-navigation-3" class="book-navigation">
    
        <div class="page-links clear-block">
              <a href="content/visual-proof-cap-theorem.html" class="page-previous" title="Go to previous page">‹ A visual proof of the CAP Theorem</a>
                    <a href="content/distributed-systems.html" class="page-up" title="Go to parent page">up</a>
                    <a href="durability.html" class="page-next" title="Go to next page">Durability ›</a>
          </div>
    
  </div>
</div>
    <br />
        	<div class="links-align">
            <div class="bg-links">
                <div class="links-left">
                    <div class="links-right">
                        <div class="links"><ul class="links inline"><li class="blog_usernames_blog first"><a href="blogs/michael-l-perry.html" title="Read Michael L Perry&#039;s latest blog entries.">Michael L Perry&#039;s blog</a></li>
<li class="comment_add last"><a href="http://qedcode.com/comment/reply/92#comment-form" title="Share your thoughts and opinions related to this posting.">Add new comment</a></li>
</ul></div>
                    </div>
                </div>
            </div>
        </div>
	    <br class="clear" />    
    </div>                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
    <div id="footer">
    	<div class="foot">
        	                <span><a rel="license" href="http://creativecommons.org/licenses/by/3.0/us/"><img alt="Creative Commons License" src="../licensebuttons.net/l/by/3.0/us/88x31.png" /></a><br /><span dc="http://purl.org/dc/elements/1.1/" href="http://purl.org/dc/dcmitype/Text" property="title" rel="type">Q.E.D. Code</span> by <a cc="http://creativecommons.org/ns#" href="index.html" property="attributionName" rel="attributionURL">Michael L Perry</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/3.0/us/">Creative Commons Attribution 3.0 United States License</a>.</span>
                    </div>
    </div>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
var _gaq = _gaq || [];_gaq.push(["_setAccount", "UA-389401-7"]);_gaq.push(["_trackPageview"]);(function() {var ga = document.createElement("script");ga.type = "text/javascript";ga.async = true;ga.src = ("https:" == document.location.protocol ? "https://ssl" : "http://www") + ".google-analytics.com/ga.js";var s = document.getElementsByTagName("script")[0];s.parentNode.insertBefore(ga, s);})();
//--><!]]>
</script>
</body>

<!-- Mirrored from qedcode.com/cqrs by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 12:22:18 GMT -->
</html>
