<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">

<!-- Mirrored from qedcode.com/node?page=1 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 12:21:33 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Q.E.D. Code | - Reliable software through mathematical proof</title>
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="alternate" type="application/rss+xml" title="Q.E.D. Code RSS" href="http://feeds.feedburner.com/qedcode?q=rss.xml" />
<link rel="shortcut icon" href="http://qedcode.com/misc/favicon.ico" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/book/book.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/node/node.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/system/defaults.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/system/system.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/system/system-menus.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/user/user.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/sites/all/modules/mollom/mollom.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/sites/all/modules/views/css/views.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/themes/theme073/style.css?2" />
  <script type="text/javascript" src="http://qedcode.com/misc/jquery.js?2"></script>
<script type="text/javascript" src="http://qedcode.com/misc/drupal.js?2"></script>
<script type="text/javascript" src="http://qedcode.com/sites/all/modules/google_analytics/googleanalytics.js?2"></script>
<script type="text/javascript" src="http://qedcode.com/sites/all/modules/mollom/mollom.js?2"></script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
jQuery.extend(Drupal.settings, { "basePath": "/", "googleanalytics": { "trackOutbound": 1, "trackMailto": 1, "trackDownload": 1, "trackDownloadExtensions": "7z|aac|arc|arj|asf|asx|avi|bin|csv|doc|exe|flv|gif|gz|gzip|hqx|jar|jpe?g|js|mp(2|3|4|e?g)|mov(ie)?|msi|msp|pdf|phps|png|ppt|qtm?|ra(m|r)?|sea|sit|tar|tgz|torrent|txt|wav|wma|wmv|wpd|xls|xml|z|zip" } });
//--><!]]>
</script>
  
</head>
  
<body>
    <table id="main">
        <tr>
            <td width="100%" class="header">
            	<div class="top-left">
                	<div class="top-right">
                    	<table width="100%">
                            <tr>
                                <td width="100%" style="height:195px;">
                                    <table width="100%">
                                        <tr>
                                            <td width="">
                                                                                                    <a href="index.html" title="Home"><img src="http://qedcode.com/themes/theme073/images/logo.png" alt="Home" border="0" class="logo" /></a><br />
                                                                                                                                                
                                                                                            </td>
                                            <td width="270">
                                                <div class="search-box">
                                                                                                    </div>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                            <tr>
                                <td width="100%" style="height:54px;">
                                                                            <div class="pr-menu">
                                            <ul class="links primary-links"><li class="menu-227 active-trail first active"><a href="node.html" title="" class="active">Latest Article</a></li>
<li class="menu-339"><a href="podcast.html" title="Q.E.D. Code Podcast">Podcast</a></li>
<li class="menu-219"><a href="theory.html" title="">Theory</a></li>
<li class="menu-220"><a href="practice.html" title="">Practice</a></li>
<li class="menu-221 last"><a href="speaking.html" title="">Speaking</a></li>
</ul>                                            <br class="clear" />
                                        </div>
                                                                    </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </td>
        </tr>
        <tr>
            <td width="100%">
                <table width="100%" >
                    <tr>
                        <td width="189">
                            <div class="left2">
                                                                    <table width="100%">
                                      <tr>
                                        <td width="100%">
                                            <div class="block block-block" id="block-block-2">
	<div class="block-bot">
    	<div class="block-top">
        	<div class="block-indent">
                <div class="title">
                    <h3>About me</h3>
                </div>
                <div class="content"><div style="margin: 15px;">
<p style="margin-bottom: 7px;">Michael L Perry</p>
<p><a href="http://improvingenterprises.com/"><img src="images/IE-Logo.png" width="145" alt="Improving Enterprises" /></a></p>
<p style="margin-bottom: 15px;">Principal Consultant</p>
<p><a href="http://twitter.com/michaellperry">@michaellperry</a></p>
</div>
</div>
            </div>
        </div>
    </div>
</div><div class="block block-user" id="block-user-0">
	<div class="block-bot">
    	<div class="block-top">
        	<div class="block-indent">
                <div class="title">
                    <h3>User login</h3>
                </div>
                <div class="content"><form action="http://qedcode.com/node?destination=node%3Fpage%3D1"  accept-charset="UTF-8" method="post" id="user-login-form">
<div><div class="form-item" id="edit-name-wrapper">
 <label for="edit-name">Username: <span class="form-required" title="This field is required.">*</span></label>
 <input type="text" maxlength="60" name="name" id="edit-name" size="15" value="" class="form-text required" />
</div>
<div class="form-item" id="edit-pass-wrapper">
 <label for="edit-pass">Password: <span class="form-required" title="This field is required.">*</span></label>
 <input type="password" name="pass" id="edit-pass"  maxlength="60"  size="15"  class="form-text required" />
</div>
<input type="submit" name="op" id="edit-submit" value="Log in"  class="form-submit" />
<div class="item-list"><ul><li class="first last"><a href="user/password.html" title="Request new password via e-mail.">Request new password</a></li>
</ul></div><input type="hidden" name="form_build_id" id="form-353e36e3749b746c17c5f4889694e5be" value="form-353e36e3749b746c17c5f4889694e5be"  />
<input type="hidden" name="form_id" id="edit-user-login-block" value="user_login_block"  />

</div></form>
</div>
            </div>
        </div>
    </div>
</div>                                        </td>
                                      </tr>
                                    </table>
                                                            </div>
                        </td>
                        <td width="0">
                            <div class="right2">
                                                            </div>
                        </td>
                        <td width="" class="cont-row">
                            <div class="border-left">
                                <div class="border-right">
                                    <div class="border-bot">
                                        <div class="border-top">
                                            <div class="corner-bot-left">
                                                <div class="corner-bot-right">
                                                    <div class="corner-top-left">
                                                        <div class="corner-top-right">
                                                            <div class="cent">
                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                             
                                                                                                                    
                                                                                                                    
                                                              <!-- start main content -->
                                                            <div class="node">
	    	
			            <div class="bg-h2">
                <h1 class="title"><a href="content/building-next-generation-mobile-applications.html">Building the Next Generation of Mobile Applications</a></h1>
                <div class="submit"><span class="submitted">Submitted by Michael L Perry on Sat, 03/16/2013 - 17:46</span></div>
            </div>
       
        <div class="taxonomy"></div>
  
    <div class="content"><p>This weekend I spoke at Cowtown Code Camp. I showed a demo of Correspondence, and built an app called &quot;I Like Tunes&quot;. I built the app for Windows Phone <strong>and</strong> Windows 8 simultaneously, all the while showing how these two versions of the app talk to each other.</p>
<p>Please download the <a href="http://qedcode.com/sites/default/files/2c48863a89c8_F9E8/Collaborative-Applications.pptx" target="_blank">slides</a> and <a href="http://qedcode.com/sites/default/files/2c48863a89c8_F9E8/CTCC.ILikeTunes.zip" target="_blank">code</a>. </p>
</div>
    <br />
        	<div class="links-align">
            <div class="bg-links">
                <div class="links-left">
                    <div class="links-right">
                        <div class="links"><ul class="links inline"><li class="blog_usernames_blog first"><a href="blogs/michael-l-perry.html" title="Read Michael L Perry&#039;s latest blog entries.">Michael L Perry&#039;s blog</a></li>
<li class="comment_add last"><a href="http://qedcode.com/comment/reply/104#comment-form" title="Add a new comment to this page.">Add new comment</a></li>
</ul></div>
                    </div>
                </div>
            </div>
        </div>
	    <br class="clear" />    
    </div><div class="node">
	    	
			            <div class="bg-h2">
                <h1 class="title"><a href="content/open-source-reader-application.html">Open source Reader application</a></h1>
                <div class="submit"><span class="submitted">Submitted by Michael L Perry on Thu, 03/14/2013 - 14:34</span></div>
            </div>
       
        <div class="taxonomy"></div>
  
    <div class="content"><p>Google Reader will be <a href="http://googlereader.blogspot.com/2013/03/powering-down-google-reader.html">retired</a> on July 1, 2013. This leaves a vacuum in the application landscape. Many of the best reader applications on various platforms have used Google Reader as a back end. There are several RSS readers that are not backed by Google, but these applications lack an important feature: the <a href="http://www.engadget.com/2010/05/26/a-modest-proposal-the-continuous-client/">Continuous Client</a>. When you use an RSS reader on one device, it doesn’t know about the posts you’ve already read on a different device. Google Reader solved that problem, because it was a common back end for multiple clients.</p>
<h3>Correspondence</h3>
<p>To fill this vacuum, I am starting an open source project to build an RSS reader back end on Correspondence. Correspondence is a client library and a cloud service for building occasionally-connected applications. Correspondence applications work off-line. They store data locally so that it is immediately accessible and updatable without a network. They also publish data to the cloud, so that it can be shared across devices and across individuals.</p>
<p>Correspondence is the perfect platform for a continuous RSS reader client. People want to be able to consume posts while off-line. They want the application to know which posts they have read. And they want the application to publish that to the cloud so that they get a continuous experience when they pick up another device.</p>
<p>Correspondence currently supports all Microsoft client stacks. For this project, we will begin by focusing on Windows Phone, Windows 8, and ASP.NET MVC. In the near future, Correspondence will be ported to Android and iOS via Xamarin, and will have JavaScript binding for rich web clients. Work has already begun on a native Android implementation of Correspondence. A native Objective-C implementation for iOS will begin in the future.</p>
<p>So eventually, we will be able to deploy the RSS reader application natively to any client, and provide a rich web-based experience as a fall-back.</p>
<h3>Join me</h3>
<p>Please watch the project on <a href="https://github.com/michaellperry/reader">GitHub</a>. Once there’s a basic project structure in place, you can fork it and help me out with pull requests. I’ve created an AgileZen board for keeping track of work items. If you want to participate in a more material manner, please send me an email (Michael at this domain) or tweet (Michael L Perry on Twitter) and I’ll add you to the board.</p>
<p>The clients will be launched in their respective stores as free apps. My intention is not to produce revenue on the reader apps themselves, but to promote Correspondence as a platform.</p>
<p>Please help me to support the folks that Google has left behind.</p>
</div>
    <br />
        	<div class="links-align">
            <div class="bg-links">
                <div class="links-left">
                    <div class="links-right">
                        <div class="links"><ul class="links inline"><li class="blog_usernames_blog first"><a href="blogs/michael-l-perry.html" title="Read Michael L Perry&#039;s latest blog entries.">Michael L Perry&#039;s blog</a></li>
<li class="comment_comments last"><a href="content/open-source-reader-application.html#comments" title="Jump to the first comment of this posting.">2 comments</a></li>
</ul></div>
                    </div>
                </div>
            </div>
        </div>
	    <br class="clear" />    
    </div><div class="node">
	    	
			            <div class="bg-h2">
                <h1 class="title"><a href="content/renew-your-developer-license-surface-rt.html">Renew your developer license on Surface RT</a></h1>
                <div class="submit"><span class="submitted">Submitted by Michael L Perry on Mon, 02/18/2013 - 18:48</span></div>
            </div>
       
        <div class="taxonomy"></div>
  
    <div class="content"><p>To develop applications for Windows 8, you need to obtain a developer license. This is not the same as the Windows Store registration that allows you to publish applications. You don’t pay for this license. This is just a token that lets you run applications on your own machine. This license expires every 30 days, so you need to renew it often.</p>
<p>As you develop your app, it pays to frequently run on lower-powered hardware. Develop on a full-powered PC, but deploy to a surface RT or other ARM device periodically to test. To do this, you need to renew your developer license on the RT device as well.</p>
<p>On your full development machine, Visual Studio will prompt you to renew your license when you open your project. But on an ARM device, you don’t have Visual Studio. To renew the license, you have to run the following PowerShell command as an administrator:</p>
<pre>Show-WindowsDeveloperLicenseRegistration
</pre><p>This will display a login page where you enter your Microsoft ID credentials. You won’t be charged. You will just get a new license that is good for 30 days of development and testing.</p>
<p>Since you need to do this frequently, you’ll want to create a shortcut that you can launch from the start screen. Here’s how you do that.</p>
<h3>Create a PowerShell script</h3>
<p>Create a folder called c:\Scripts. Create a text file in that folder called “DeveloperLicense.ps1”. Add the command above to the text file. You can do this by running the following from the command line:</p>
<pre>mkdir c:\Scripts
echo Show-WindowsDeveloperLicenseRegistration &gt; c:\Scripts\DeveloperLicense.ps1
</pre><h3>Create a shortcut</h3>
<p>Then create a shortcut in that same folder. You do that by right-clicking and selecting “New”, “Shortcut”. Set the target to the following:</p>
<pre>%SystemRoot%\system32\WindowsPowerShell\v1.0\powershell.exe c:\Scripts\DeveloperLicense.ps1
</pre><p>Name this shortcut “Renew Developer License”. Right-click the new shortcut, edit the properties, click Advanced, and set it to run as administrator.</p>
<h3>Set the execution policy</h3>
<p>Finally, before you can run this license for the first time, you need to set the execution policy. Open a PowerShell command prompt as an administrator. To do this, pull up the start screen, type “PowerShell”, right-click “Windows PowerShell”, and click “Run as administrator”. Then run this command:</p>
<pre>Set-ExecutionPolicy Unrestricted
</pre><p>I should warn you that this opens your machine to running untrusted PowerShell scripts. Find out more about this setting at <a title="http://go.microsoft.com/fwlink/?LinkID=135170" href="http://go.microsoft.com/fwlink/?LinkID=135170">http://go.microsoft.com/fwlink/?LinkID=135170</a>. Don’t do this lightly.</p>
<p>Finally, you can right-click on this shortcut and pin it to the start screen. Now you can easily tap the tile and login to renew your free Windows developer license.</p>
</div>
    <br />
        	<div class="links-align">
            <div class="bg-links">
                <div class="links-left">
                    <div class="links-right">
                        <div class="links"><ul class="links inline"><li class="blog_usernames_blog first"><a href="blogs/michael-l-perry.html" title="Read Michael L Perry&#039;s latest blog entries.">Michael L Perry&#039;s blog</a></li>
<li class="comment_add last"><a href="http://qedcode.com/comment/reply/100#comment-form" title="Add a new comment to this page.">Add new comment</a></li>
</ul></div>
                    </div>
                </div>
            </div>
        </div>
	    <br class="clear" />    
    </div><div class="node">
	    	
			            <div class="bg-h2">
                <h1 class="title"><a href="content/function-closure-ioc.html">Function Closure as IoC</a></h1>
                <div class="submit"><span class="submitted">Submitted by Michael L Perry on Wed, 02/13/2013 - 15:36</span></div>
            </div>
       
        <div class="taxonomy"></div>
  
    <div class="content"><p><a href="http://qedcode.com/sites/default/files/function_ioc.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: right; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" align="right" src="http://qedcode.com/sites/default/files/function_ioc_thumb.png" width="490" height="484" /></a>With my style of MVVM, you end up with several layers of view model, each one taking a reference to a different part of the model. The view model hierarchy mirrors the model hierarchy. When a view model lower in the hierarchy needs a new reference, I have to plumb that parameter through all of the constructors.</p>
<p>At least, I used to. Now I use a simple functional IoC pattern.</p>
<h3>Hierarchy of view models</h3>
<p><a href="mycon.html">MyCon</a> is a template for conference web sites and mobile applications. In the Windows 8 app, the sessions for the conference appear in a GridView, grouped by track. The GridView is data bound to the TracksViewModel. This view model exposes a collection property called Tracks. It is a collection of TrackViewModel. This view model in turn exposes a collection of SessionHeaderViewModel through a property called Items.</p>
<pre class="code"><span style="background: white; color: blue">public class </span><span style="background: white; color: #2b91af">TracksViewModel
</span><span style="background: white; color: black">{
    </span><span style="background: white; color: blue">public </span><span style="background: white; color: #2b91af">IEnumerable</span><span style="background: white; color: black">&lt;</span><span style="background: white; color: #2b91af">TrackViewModel</span><span style="background: white; color: black">&gt; Tracks
    {
        </span><span style="background: white; color: blue">get
        </span><span style="background: white; color: black">{
            </span><span style="background: white; color: blue">return
                from </span><span style="background: white; color: black">track </span><span style="background: white; color: blue">in </span><span style="background: white; color: black">_synchronizationService.Conference.Tracks
                </span><span style="background: white; color: blue">orderby </span><span style="background: white; color: black">track.Name
                </span><span style="background: white; color: blue">select new </span><span style="background: white; color: #2b91af">TrackViewModel</span><span style="background: white; color: black">(track);
        }
    }
}
</span></pre><p>
<pre class="code"><span style="background: white; color: blue">public class </span><span style="background: white; color: #2b91af">TrackViewModel
</span><span style="background: white; color: black">{
    </span><span style="background: white; color: blue">public </span><span style="background: white; color: #2b91af">IEnumerable</span><span style="background: white; color: black">&lt;</span><span style="background: white; color: #2b91af">SessionHeaderViewModel</span><span style="background: white; color: black">&gt; Items
    {
        </span><span style="background: white; color: blue">get
        </span><span style="background: white; color: black">{
            </span><span style="background: white; color: blue">return
                from </span><span style="background: white; color: black">sessionPlace </span><span style="background: white; color: blue">in </span><span style="background: white; color: black">_track.CurrentSessionPlaces
                </span><span style="background: white; color: blue">orderby </span><span style="background: white; color: black">sessionPlace.Place.PlaceTime.Start
                </span><span style="background: white; color: blue">select new </span><span style="background: white; color: #2b91af">SessionHeaderViewModel</span><span style="background: white; color: black">(sessionPlace);
        }
    }
}
</span></pre></p><p>  Each view model constructor takes a reference to the part of the model that it represents. So the TracksViewModel takes a reference to the SynchronizationService – the top-level object that provides the reference to the Conference. The TrackViewModel references a Track. And the SessionHeaderViewModel references a SessionPlace – a model object that knows where and when a session will be given.</p>
<pre class="code"><span style="background: white; color: blue">public class </span><span style="background: white; color: #2b91af">TracksViewModel
</span><span style="background: white; color: black">{
    </span><span style="background: white; color: blue">private readonly </span><span style="background: white; color: #2b91af">SynchronizationService </span><span style="background: white; color: black">_synchronizationService;
        
    </span><span style="background: white; color: blue">public </span><span style="background: white; color: black">TracksViewModel(</span><span style="background: white; color: #2b91af">SynchronizationService </span><span style="background: white; color: black">synchronizationService)
    {
        _synchronizationService = synchronizationService;
    }
}
</span></pre><pre class="code"><span style="background: white; color: blue">public class </span><span style="background: white; color: #2b91af">TrackViewModel
</span><span style="background: white; color: black">{
    </span><span style="background: white; color: blue">private readonly </span><span style="background: white; color: #2b91af">Track </span><span style="background: white; color: black">_track;
        
    </span><span style="background: white; color: blue">public </span><span style="background: white; color: black">TrackViewModel(</span><span style="background: white; color: #2b91af">Track </span><span style="background: white; color: black">track)
    {
        _track = track;
    }
}
</span></pre><pre class="code"><span style="background: white; color: blue">public class </span><span style="background: white; color: #2b91af">SessionHeaderViewModel
</span><span style="background: white; color: black">{
    </span><span style="background: white; color: blue">private readonly </span><span style="background: white; color: #2b91af">SessionPlace </span><span style="background: white; color: black">_sessionPlace;
        
    </span><span style="background: white; color: blue">public </span><span style="background: white; color: black">SessionHeaderViewModel(</span><span style="background: white; color: #2b91af">SessionPlace </span><span style="background: white; color: black">sessionPlace)
    {
        _sessionPlace = sessionPlace;
    }
}
</span></pre><h3>Add a selection model</h3>
<p>The application also has a SelectionModel. This class records which session is currently selected. The SessionHeaderViewModel needs to set a property on the SelectionModel when it has been clicked. So let’s add the SelectionModel reference to the SessionHeaderViewModel constructor.</p>
<pre class="code"><span style="background: white; color: blue">public class </span><span style="background: white; color: #2b91af">SessionHeaderViewModel
</span><span style="background: white; color: black">{
    </span><span style="background: white; color: blue">private readonly </span><span style="background: white; color: #2b91af">SessionPlace </span><span style="background: white; color: black">_sessionPlace;
    </span><span style="background: white; color: blue">private readonly </span><span style="background: white; color: #2b91af">SelectionModel </span><span style="background: white; color: black">_selectionModel;
        
    </span><span style="background: white; color: blue">public </span><span style="background: white; color: black">SessionHeaderViewModel(</span><span style="background: white; color: #2b91af">SessionPlace </span><span style="background: white; color: black">sessionPlace)
    {
        _sessionPlace = sessionPlace;
        _selectionModel = selectionModel;
    }
}
</span></pre><p>After doing this, we have broken its parent view model – TrackViewModel. It needs to call the SessionHeaderViewModel constructor, so it needs to pass in the new parameter.</p>
<pre class="code"><span style="background: white; color: blue">public class </span><span style="background: white; color: #2b91af">TrackViewModel
</span><span style="background: white; color: black">{
    </span><span style="background: white; color: blue">private readonly </span><span style="background: white; color: #2b91af">Track </span><span style="background: white; color: black">_track;
    </span><span style="background: white; color: blue">private readonly </span><span style="background: white; color: #2b91af">SelectionModel </span><span style="background: white; color: black">_selectionModel;
        
    </span><span style="background: white; color: blue">public </span><span style="background: white; color: black">TrackViewModel(</span><span style="background: white; color: #2b91af">Track </span><span style="background: white; color: black">track, </span><span style="background: white; color: #2b91af">SelectionModel </span><span style="background: white; color: black">selectionModel)
    {
        _track = track;
        _selectionModel = selectionModel;
    }

    </span><span style="background: white; color: blue">public </span><span style="background: white; color: #2b91af">IEnumerable</span><span style="background: white; color: black">&lt;</span><span style="background: white; color: #2b91af">SessionHeaderViewModel</span><span style="background: white; color: black">&gt; Items
    {
        </span><span style="background: white; color: blue">get
        </span><span style="background: white; color: black">{
            </span><span style="background: white; color: blue">return
                from </span><span style="background: white; color: black">sessionPlace </span><span style="background: white; color: blue">in </span><span style="background: white; color: black">_track.CurrentSessionPlaces
                </span><span style="background: white; color: blue">orderby </span><span style="background: white; color: black">sessionPlace.Place.PlaceTime.Start
                </span><span style="background: white; color: blue">select new </span><span style="background: white; color: #2b91af">SessionHeaderViewModel</span><span style="background: white; color: black">(sessionPlace, _selectionModel);
        }
    }
}
</span></pre><p>Now it takes the SelectionModel and passes it on through. But guess what. Now we’ve broken <em>its</em> parent – TracksViewModel. So again, we have to plumb the parameter through the parent.</p>
<pre class="code"><span style="background: white; color: blue">public class </span><span style="background: white; color: #2b91af">TracksViewModel
</span><span style="background: white; color: black">{
    </span><span style="background: white; color: blue">private readonly </span><span style="background: white; color: #2b91af">SynchronizationService </span><span style="background: white; color: black">_synchronizationService;
    </span><span style="background: white; color: blue">private readonly </span><span style="background: white; color: #2b91af">SelectionModel </span><span style="background: white; color: black">_selectionModel;
        
    </span><span style="background: white; color: blue">public </span><span style="background: white; color: black">TracksViewModel(</span><span style="background: white; color: #2b91af">SynchronizationService </span><span style="background: white; color: black">synchronizationService, </span><span style="background: white; color: #2b91af">SelectionModel </span><span style="background: white; color: black">selectionModel)
    {
        _synchronizationService = synchronizationService;
        _selectionModel = selectionModel;
    }

    </span><span style="background: white; color: blue">public </span><span style="background: white; color: #2b91af">IEnumerable</span><span style="background: white; color: black">&lt;</span><span style="background: white; color: #2b91af">TrackViewModel</span><span style="background: white; color: black">&gt; Tracks
    {
        </span><span style="background: white; color: blue">get
        </span><span style="background: white; color: black">{
</span><span style="background: white; color: black">            </span><span style="background: white; color: blue">return
                from </span><span style="background: white; color: black">track </span><span style="background: white; color: blue">in </span><span style="background: white; color: black">_synchronizationService.Conference.Tracks
                </span><span style="background: white; color: blue">orderby </span><span style="background: white; color: black">track.Name
                </span><span style="background: white; color: blue">select new </span><span style="background: white; color: #2b91af">TrackViewModel</span><span style="background: white; color: black">(track, _selectionModel);
        }
    }
}
</span></pre><p>And so it goes with every constructor parameter I need to add. If a child view model needs to know about it, then the parent view model needs to provide it. And it bubbles up the hierarchy. Every level needs to know about all of these parameters, even if they don’t use them directly.</p>
<h3>Functional IoC to the rescue</h3>
<p>This looks like the sort of problem that an IoC container solves. IoC – Inversion of Control – is a pattern that takes construction and dependency management out of the hands of business objects, like view models. It places that responsibility in the hands of a container. The IoC container creates all of the business objects, so that they don’t have to create each other. And it figures out how to resolve their dependencies so that the intermediate objects don’t need to worry about it.</p>
<p>There are many great open source IoC containers available. One that would be particularly adept at solving this problem is <a href="http://code.google.com/p/autofac/">AutoFac</a>. But we’re not going to use AutoFac, or any other IoC container library. Instead, we are going to use a feature of the language: function closure.</p>
<p>Closure simply means that a function in C# will encapsulate any variables that are referenced within the function body. So we can declare a function that creates a SessionHeaderViewModel like so:</p>
<pre class="code"><span style="background: white; color: #2b91af">SelectionModel </span><span style="background: white; color: black">selectionModel = </span><span style="background: white; color: blue">new </span><span style="background: white; color: #2b91af">SelectionModel</span><span style="background: white; color: black">();

</span><span style="background: white; color: #2b91af">Func</span><span style="background: white; color: black">&lt;</span><span style="background: white; color: #2b91af">SessionPlace</span><span style="background: white; color: black">, </span><span style="background: white; color: #2b91af">SessionHeaderViewModel</span><span style="background: white; color: black">&gt; newSessionHeaderViewModel = s =&gt;
    </span><span style="background: white; color: blue">new </span><span style="background: white; color: #2b91af">SessionHeaderViewModel</span><span style="background: white; color: black">(s, selectionModel);
</span></pre><p>The variable selectionModel is declared outside of the scope of the lambda, but since it is referenced inside, that variable is encapsulated within the function. Anyone who calls the newSessionHeaderViewModel function will get back an object with that same SelectionModel reference.</p>
<p>Instead of letting the parent TrackViewModel call the SessionHeaderViewModel directly, we’ll just give it this function.</p>
<pre class="code"><span style="background: white; color: blue">public class </span><span style="background: white; color: #2b91af">TrackViewModel
</span><span style="background: white; color: black">{
    </span><span style="background: white; color: blue">private readonly </span><span style="background: white; color: #2b91af">Track </span><span style="background: white; color: black">_track;
    </span><span style="background: white; color: blue">private readonly </span><span style="background: white; color: #2b91af">Func</span><span style="background: white; color: black">&lt;</span><span style="background: white; color: #2b91af">SessionPlace</span><span style="background: white; color: black">, </span><span style="background: white; color: #2b91af">SessionHeaderViewModel</span><span style="background: white; color: black">&gt; _newSessionHeaderViewModel;

    </span><span style="background: white; color: blue">public </span><span style="background: white; color: black">TrackViewModel(</span><span style="background: white; color: #2b91af">Track </span><span style="background: white; color: black">track, </span><span style="background: white; color: #2b91af">Func</span><span style="background: white; color: black">&lt;</span><span style="background: white; color: #2b91af">SessionPlace</span><span style="background: white; color: black">, </span><span style="background: white; color: #2b91af">SessionHeaderViewModel</span><span style="background: white; color: black">&gt; newSessionHeaderViewModel)
    {
        _track = track;
        _newSessionHeaderViewModel = newSessionHeaderViewModel;
    }

    </span><span style="background: white; color: blue">public </span><span style="background: white; color: #2b91af">IEnumerable</span><span style="background: white; color: black">&lt;</span><span style="background: white; color: #2b91af">SessionHeaderViewModel</span><span style="background: white; color: black">&gt; Items
    {
        </span><span style="background: white; color: blue">get
        </span><span style="background: white; color: black">{
            </span><span style="background: white; color: blue">return
                from </span><span style="background: white; color: black">sessionPlace </span><span style="background: white; color: blue">in </span><span style="background: white; color: black">_track.CurrentSessionPlaces
                </span><span style="background: white; color: blue">orderby </span><span style="background: white; color: black">sessionPlace.Place.PlaceTime.Start
                </span><span style="background: white; color: blue">select </span><span style="background: white; color: black">_newSessionHeaderViewModel(sessionPlace);
        }
    }
}
</span></pre><p>Continuing this trend upward, we’ll define a function that creates TrackViewModels. Again, we’ll use functional closure to encapsulate the parameters we need.</p>
<pre class="code"><span style="background: white; color: #2b91af">SelectionModel </span><span style="background: white; color: black">selectionModel = </span><span style="background: white; color: blue">new </span><span style="background: white; color: #2b91af">SelectionModel</span><span style="background: white; color: black">();

</span><span style="background: white; color: #2b91af">Func</span><span style="background: white; color: black">&lt;</span><span style="background: white; color: #2b91af">SessionPlace</span><span style="background: white; color: black">, </span><span style="background: white; color: #2b91af">SessionHeaderViewModel</span><span style="background: white; color: black">&gt; newSessionHeaderViewModel = s =&gt;
    </span><span style="background: white; color: blue">new </span><span style="background: white; color: #2b91af">SessionHeaderViewModel</span><span style="background: white; color: black">(s, selectionModel);

</span><span style="background: white; color: #2b91af">Func</span><span style="background: white; color: black">&lt;</span><span style="background: white; color: #2b91af">Track</span><span style="background: white; color: black">, </span><span style="background: white; color: #2b91af">TrackViewModel</span><span style="background: white; color: black">&gt; newTrackViewModel = t =&gt;
    </span><span style="background: white; color: blue">new </span><span style="background: white; color: #2b91af">TrackViewModel</span><span style="background: white; color: black">(t, newSessionHeaderViewModel);
</span></pre><p>In this case, the newTrackViewModel function is encapsulating the newSessionHeaderViewModel function. So we change the TracksViewModel to use this function.</p>
<pre class="code"><span style="background: white; color: blue">public class </span><span style="background: white; color: #2b91af">TracksViewModel
</span><span style="background: white; color: black">{
    </span><span style="background: white; color: blue">private readonly </span><span style="background: white; color: #2b91af">SynchronizationService </span><span style="background: white; color: black">_synchronizationService;
    </span><span style="background: white; color: blue">private readonly </span><span style="background: white; color: #2b91af">Func</span><span style="background: white; color: black">&lt;</span><span style="background: white; color: #2b91af">Track</span><span style="background: white; color: black">, </span><span style="background: white; color: #2b91af">TrackViewModel</span><span style="background: white; color: black">&gt; _newTrackViewModel;

    </span><span style="background: white; color: blue">public </span><span style="background: white; color: black">TracksViewModel(</span><span style="background: white; color: #2b91af">SynchronizationService </span><span style="background: white; color: black">synchronizationService, </span><span style="background: white; color: #2b91af">Func</span><span style="background: white; color: black">&lt;</span><span style="background: white; color: #2b91af">Track</span><span style="background: white; color: black">, </span><span style="background: white; color: #2b91af">TrackViewModel</span><span style="background: white; color: black">&gt; newTrackViewModel)
    {
        _synchronizationService = synchronizationService;
        _newTrackViewModel = newTrackViewModel;
    }

    </span><span style="background: white; color: blue">public </span><span style="background: white; color: #2b91af">IEnumerable</span><span style="background: white; color: black">&lt;</span><span style="background: white; color: #2b91af">TrackViewModel</span><span style="background: white; color: black">&gt; Tracks
    {
        </span><span style="background: white; color: blue">get
        </span><span style="background: white; color: black">{
            </span><span style="background: white; color: blue">return
                from </span><span style="background: white; color: black">track </span><span style="background: white; color: blue">in </span><span style="background: white; color: black">_synchronizationService.Conference.Tracks
                </span><span style="background: white; color: blue">orderby </span><span style="background: white; color: black">track.Name
                </span><span style="background: white; color: blue">select </span><span style="background: white; color: black">_newTrackViewModel(track);
        }
    }
}
</span></pre><h3></h3>
<h3>A containerless container</h3>
<p>All of the functions related to a given top-level view model need to be managed in the same scope. That is what allows those functions to be encapsulated into each other via closure. And so I like to declare a static class in my view model namespace called Container. This static class contains a static method that creates a top-level view model.</p>
<pre class="code"><span style="background: white; color: blue">public static class </span><span style="background: white; color: #2b91af">Container
</span><span style="background: white; color: black">{
    </span><span style="background: white; color: blue">public static </span><span style="background: white; color: #2b91af">TracksViewModel </span><span style="background: white; color: black">CreateViewModel(
        </span><span style="background: white; color: #2b91af">SelectionModel </span><span style="background: white; color: black">selectionModel,
        </span><span style="background: white; color: #2b91af">SynchronizationService </span><span style="background: white; color: black">synchronizationService)
    {
        </span><span style="background: white; color: #2b91af">Func</span><span style="background: white; color: black">&lt;</span><span style="background: white; color: #2b91af">SessionPlace</span><span style="background: white; color: black">, </span><span style="background: white; color: #2b91af">SessionHeaderViewModel</span><span style="background: white; color: black">&gt; newSessionHeaderViewModel = s =&gt;
            </span><span style="background: white; color: blue">new </span><span style="background: white; color: #2b91af">SessionHeaderViewModel</span><span style="background: white; color: black">(s, selectionModel);

        </span><span style="background: white; color: #2b91af">Func</span><span style="background: white; color: black">&lt;</span><span style="background: white; color: #2b91af">Track</span><span style="background: white; color: black">, </span><span style="background: white; color: #2b91af">TrackViewModel</span><span style="background: white; color: black">&gt; newTrackViewModel = t =&gt;
            </span><span style="background: white; color: blue">new </span><span style="background: white; color: #2b91af">TrackViewModel</span><span style="background: white; color: black">(t, newSessionHeaderViewModel);

        </span><span style="background: white; color: blue">return new </span><span style="background: white; color: #2b91af">TracksViewModel</span><span style="background: white; color: black">(synchronizationService, newTrackViewModel);
    }
}
</span></pre><p>Then if I need to add a parameter to any of the view models in this hierarchy, I simply add that parameter to this function. It is encapsulated into the functions that need it. The view models that don’t need it do not need to change.</p>
<p>Without resorting to an IoC container library, I have defined a container that creates instances of view models. It manages the dependencies of each particular view model, so that the parent view models don’t have to. It does so simply by using the language feature of function closure.</p>
<p>You can see the complete source code at <a title="https://github.com/michaellperry/MyCon" href="https://github.com/michaellperry/MyCon">https://github.com/michaellperry/MyCon</a>. Open the FacetedWorlds.MyCon project the WinRT folder.</p>
</div>
    <br />
        	<div class="links-align">
            <div class="bg-links">
                <div class="links-left">
                    <div class="links-right">
                        <div class="links"><ul class="links inline"><li class="blog_usernames_blog first"><a href="blogs/michael-l-perry.html" title="Read Michael L Perry&#039;s latest blog entries.">Michael L Perry&#039;s blog</a></li>
<li class="comment_add last"><a href="http://qedcode.com/comment/reply/99#comment-form" title="Add a new comment to this page.">Add new comment</a></li>
</ul></div>
                    </div>
                </div>
            </div>
        </div>
	    <br class="clear" />    
    </div><div class="node">
	    	
			            <div class="bg-h2">
                <h1 class="title"><a href="content/artificial-boundaries.html">Artificial boundaries</a></h1>
                <div class="submit"><span class="submitted">Submitted by Michael L Perry on Thu, 01/24/2013 - 12:43</span></div>
            </div>
       
        <div class="taxonomy"></div>
  
    <div class="content"><p>In “About Face”, Alan Cooper showed us how the Save command in most desktop programs forces users to change their conceptual model. The user has a model of how the domain works, and that model does not include things like memory and files. When an application provides a Save command, it forces the user to see the implementation detail that data on the disk can be different from the data in memory. This is an artificial boundary</p>
<p>This artificial boundary becomes increasingly visible when the user exits the program. If they haven’t hit that Save button, then they get a prompt. This prompt points out that the version of their document in memory is different than the one on disk. It “stops the proceedings with idiocy”. The user wanted to quit the program and move on to something else, but the idiot program interrupted them to satisfy its own implementation detail. That detail – the artificial boundary – is unimportant to the user.</p>
<h3>Boundaries on the web</h3>
<p>On the web, there is no Save command. Users make their changes, and those changes are naturally saved. The artificial boundary doesn’t exist … or does it?</p>
<p>The web actually has a much bigger artificial boundary: that between the browser and the server. The data that the user enters is not saved until they hit submit. Even then, there might be a network problem that prevents them from submitting the form. There might be an authentication step that they have to complete. And there is always the very real risk that the work that the user is trying to save won’t be there after they correct the problem or hit the Back button.</p>
<p>So we rely on AJAX to solve this problem. As the user enters data on the page, we can post back to the server. We don’t have to wait for them to click Submit. We don’t have to show them the artificial boundary, unless something goes wrong. Then, of course, all bets are off and we have to tell them that we failed to save their data.</p>
<h3>Boundaries in code</h3>
<p>The AJAX solution is a reasonable one. Unfortunately, it creates artificial boundaries within our code. For example, in an MVC application, we have one programming model for postback-style web pages, and another programming model for AJAX.</p>
<p>In a postback-style web page, we inject data into the page on the server using Razor. Then, when the user clicks Submit, we pull data back out of the page using the model binder.</p>
<p>But in an AJAX-style interaction, we can use neither of these. We send data to the client through a REST endpoint as JSON, and then receive it in a similar fashion. All of the data injection, binding, and DOM manipulation occurs in JavaScript rather than Razor.</p>
<p>This is an artificial boundary, too. It’s one that we have imposed upon ourselves. But this isn’t the way it has to be.</p>
<h3>Recognizing boundaries</h3>
<p>A boundary in software exists when the state on one side can differ from the state on the other. The document in memory can be different from the one on disk. The data in the browser can be different from the data on the server. Sometimes we can eliminate these boundaries. Sometimes these boundaries have to exist. But we must recognize them as accidental complexity – not essential to the problem that we are actually trying to solve.</p>
<p>When you see a view model with fields or auto properties, that is an artificial boundary that we can eliminate. Fields and auto properties can store data. That data can become different from its source. To eliminate this boundary, write get and set methods in your properties that reference the source directly. That’s what I’ve done with Update Controls.</p>
<p>When you see data on disk and in memory, that is another artificial boundary that we can eliminate. Let the in-memory cache be the only way to access the persisted data. Write through the cache so that you know it always represents the persisted data. That’s what I’ve done with Correspondence.</p>
<p>When you see two machines separated by a network, then there is an artificial boundary that we can’t eliminate. But at the very least, we could define a consistent, composable programming model that recognizes the boundary, yet doesn’t force you to code against it. This programming model should be&#160; Again, that’s what I’ve done with Correspondence.</p>
<p>In future posts, I will lay out the programming model that remains consistent across artificial boundaries, and eliminates them entirely when possible. I will show examples in client applications first. But eventually, I will apply these principals to web applications. The goal is to reduce defects by making all programming consistent and composable across boundaries.</p>
</div>
    <br />
        	<div class="links-align">
            <div class="bg-links">
                <div class="links-left">
                    <div class="links-right">
                        <div class="links"><ul class="links inline"><li class="blog_usernames_blog first"><a href="blogs/michael-l-perry.html" title="Read Michael L Perry&#039;s latest blog entries.">Michael L Perry&#039;s blog</a></li>
<li class="comment_add last"><a href="http://qedcode.com/comment/reply/98#comment-form" title="Add a new comment to this page.">Add new comment</a></li>
</ul></div>
                    </div>
                </div>
            </div>
        </div>
	    <br class="clear" />    
    </div><div class="node">
	    	
			            <div class="bg-h2">
                <h1 class="title"><a href="no-really.html">Force a Windows laptop to stay asleep</a></h1>
                <div class="submit"><span class="submitted">Submitted by Michael L Perry on Fri, 12/28/2012 - 19:29</span></div>
            </div>
       
        <div class="taxonomy"></div>
  
    <div class="content"><p>
<div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:8eb9d37f-1541-4f29-b6f4-1eea890d4876:76e0fd8d-22dd-4e86-8b7d-917bd10ccea3" class="wlWriterEditableSmartContent">
<div><a href="http://qedcode.com/sites/default/files/0b7bc4435975_10213/NoReallyC.exe" target="_self">NoReallyC.exe</a></div>
</div></p>


<p>How often have you closed the lid to your laptop and put it in the bag, only to reach in an hour later and feel a nice toasty machine with a nearly dead battery?</p>
<p>Here’s a little program to solve that problem. I call it “No, Really!”.</p>
<pre>#include &quot;stdafx.h&quot;

int _tmain(int argc, _TCHAR* argv[])
{
	for (;;)
	{
		DWORD sleep = GetTickCount();
		SetSuspendState(false, false, true);
		DWORD wake = GetTickCount();
		if (wake-sleep &gt; 30000)
			break;
	}
	return 0;
}</pre></div>
    <br />
        	<div class="links-align">
            <div class="bg-links">
                <div class="links-left">
                    <div class="links-right">
                        <div class="links"><ul class="links inline"><li class="blog_usernames_blog first"><a href="blogs/michael-l-perry.html" title="Read Michael L Perry&#039;s latest blog entries.">Michael L Perry&#039;s blog</a></li>
<li class="comment_add last"><a href="http://qedcode.com/comment/reply/96#comment-form" title="Add a new comment to this page.">Add new comment</a></li>
</ul></div>
                    </div>
                </div>
            </div>
        </div>
	    <br class="clear" />    
    </div><div class="node">
	    	
			            <div class="bg-h2">
                <h1 class="title"><a href="esb.html">Enterprise Service Bus</a></h1>
                <div class="submit"><span class="submitted">Submitted by Michael L Perry on Sat, 12/08/2012 - 14:51</span></div>
            </div>
       
        <div class="taxonomy"></div>
  
    <div class="content"><p>Distributed systems are constructed from different bounded contexts. These subsystems each have their own dialect of the ubiquitous language, and are owned by different teams. An enterprise service bus lets you integrate these bounded contexts using messages. Messages are a fantastic form of integration, because they tend to be small, complete, and temporally decoupled. But to effectively integrate using messages, you need to understand what kind of messages you can use.</p>
<h3>Kinds of messages</h3>
<p><a href="http://qedcode.com/sites/default/files/Enterprise-Service-Bus_A298/image_4.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: right; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" align="right" src="http://qedcode.com/sites/default/files/Enterprise-Service-Bus_A298/image_thumb_4.png" width="364" height="320" /></a>A distributed system using a message-driven architecture will have three kinds of messages:</p>
<ul>
<li>Commands </li>
<li>Queries </li>
<li>Events </li>
</ul>
<p>Each kind of message is intended to flow between bounded contexts in a certain way.</p>
<p>A <strong>command</strong> is a message that is intended to change the system in some way. Commands are sent asynchronously. They are sent durably. And they carry a complete payload. Commands are named as imperative verb phrases using words like “place” or “process”.</p>
<p>An order placed by a customer is an example of a command. The command carries with it all of the items that the customer wishes to order. There is no guarantee that the command will be successful, but there is a guarantee that it will be processed. We can make this guarantee by adhering to the rules of durability. The command will be received, it will be processed, and it will not&#160; be duplicated. We just can’t make any guarantees about the outcome of the command. It may result in the order being shipped. Or it may result in a refund and an apologetic email.</p>
<p>A <strong>query</strong> is a message that makes no change to the system. Instead, it returns results. Queries are sent synchronously. They are not sent durably. And they carry a specification. Queries are named as imperative verb phrases using words like “get”, “check”, or “list”.</p>
<p>For example, a customer can query for the status of a previously submitted order. The query doesn’t change anything. It is safe to query the status again and again. Because of this, queries don’t have to be sent durably. The payload of the query is a set of criteria for the desired results. These criteria collectively are called a specification. In the case of an order status query, the specification could be nothing more than the order ID.</p>
<p>An <strong>event</strong> is a notification message that is multi-cast to several interested parties. Events are sent asynchronously. They are sent durably. And they carry a complete payload. what distinguishes an event from a command is the fact that the sender does not have any particular intent for the subsequent change to the system. An event is named as a past tense verb phrase.</p>
<p>The fulfillment system will notify any interested party when an order ships. It multi-casts the order shipped event asynchronously to all subscribers. It must send these messages durably, because they may have a downstream impact on the system. The event contains all of the information that a subscriber might need. This includes the contents of the order, information about the customer, and tracking information for the shipment. The publisher has no way of knowing which pieces of information will be important to the subscribers, so it has to send everything.</p>
<h3>Dependencies among bounded contexts</h3>
<p><a href="http://qedcode.com/sites/default/files/Enterprise-Service-Bus_A298/image_3.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: right; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" align="right" src="http://qedcode.com/sites/default/files/Enterprise-Service-Bus_A298/image_thumb_3.png" width="364" height="321" /></a>One of the best features of an enterprise service bus is the way that it manages dependencies among bounded contexts. The dependencies in an ESB do not necessarily flow in the same direction as the information. The direction of the dependency is determined by the system that defines it. It is not determined by the direction in which the information flows. </p>
<p>Commands are defined by the information consumer. The producer <strong>sends</strong> the message to the consumer.&#160; The sender intends to make a certain change to a system. It needs to express that intent using the language of the consumer. Senders take a dependency on consumers. They know the data types defined by the command handler, as well as the address of the handler.</p>
<p>Queries are defined by the information producer. The consumer calls an <strong>RPC</strong> to request information from the producer. The caller provides a specification using the language of the producer. The producer will respond using data types that it has defined. Even though the information is flowing back toward the consumer, the direction of dependency is toward the producer.</p>
<p>Events are defined by the information producer. The consumer <strong>subscribes</strong> to events from the producer. The subscriber makes the request using the language of the publisher. The subscriber knows the address of the publisher, not the other way around. The publisher will multi-cast events using its own data types. So even though the data is flowing toward the subscriber, the dependency is toward the publisher.</p>
<p>By decoupling the direction of dependency from the direction of information flow, an enterprise service bus lets information flow in many directions without forming circular dependencies. The dependency direction is best optimized for collaboration among bounded contexts created by different teams, hosted on different hardware, and deployed on different schedules. The ESB manages those dependencies and keeps the information flowing.</p>
<p>For more information about CQRS, durability, and enterprise service busses, please watch <a href="http://www.pluralsight.com/training/Courses/TableOfContents/cqrs-theory-practice">CQRS Theory and Practice</a> on Pluralsight.</p>
</div>
    <br />
        	<div class="links-align">
            <div class="bg-links">
                <div class="links-left">
                    <div class="links-right">
                        <div class="links"><ul class="links inline"><li class="blog_usernames_blog first"><a href="blogs/michael-l-perry.html" title="Read Michael L Perry&#039;s latest blog entries.">Michael L Perry&#039;s blog</a></li>
<li class="comment_add last"><a href="http://qedcode.com/comment/reply/95#comment-form" title="Add a new comment to this page.">Add new comment</a></li>
</ul></div>
                    </div>
                </div>
            </div>
        </div>
	    <br class="clear" />    
    </div><div class="node">
	    	
			            <div class="bg-h2">
                <h1 class="title"><a href="durability.html">Durability</a></h1>
                <div class="submit"><span class="submitted">Submitted by Michael L Perry on Mon, 10/29/2012 - 12:12</span></div>
            </div>
       
        <div class="taxonomy"></div>
  
    <div class="content"><p><a href="http://qedcode.com/sites/default/files/Durability_9628/image.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: right; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" align="right" src="http://qedcode.com/sites/default/files/Durability_9628/image_thumb.png" width="415" height="362" /></a>In a system using the CQRS pattern, the client will typically send command messages to a queue. A handler will pull messages from that queue for asynchronous processing.</p>
<p>When we take this approach, we have to be sure not to violate the client’s trust. If they send us a command, and know that we have received it, they should expect that it will eventually be processed. Furthermore, if they send us a command, and don’t know whether we received it (because they got a network failure), then they should feel safe to re-send the command.</p>
<p>These are durability guarantees. We guarantee that the message was persisted. If the server reboots before it can handle the message, the message won’t be lost. The message is not removed from persistent storage until it is processed. And if the client sends a duplicate, the handler recognizes it and does not duplicate the results.</p>
<h3>MSMQ command queue</h3>
<p>If you are using MSMQ for the commands, you don’t get the durability guarantees for free. The default behavior of MSMQ is optimized for performance. Durability has a cost. To get it, use the following options:</p>
<ul>
<li>Recoverable messages</li>
<li>Transactional queues</li>
<li>Private local queues</li>
</ul>
<p>As C# developers, we have our own definition for public and private. These definitions do not apply to MSMQ. Private local queues are managed just at the machine level. A public queue is managed by Active Directory. Because we are using this queue as an inbox for a known command handler, private queues are the simpler option.</p>
<p>When the command handler first starts up, it needs to check whether the queue exists. If not, it should create it. Use the overload that takes an extra boolean parameter so that you can specify this to be a transactional queue.</p>
<pre class="code">_path = <span style="color: #a31515">@&quot;.\private$\&quot; </span>+ queueName;
<span style="color: blue">if </span>(!<span style="color: #2b91af">MessageQueue</span>.Exists(_path))
{
    <span style="color: #2b91af">MessageQueue</span>.Create(_path,
        transactional: <span style="color: blue">true</span>);
}</pre><p>To send a message to a transactional queue, you have to be in a transaction. Create a TransactionScope to begin the transaction. Use the Send overload that takes a MessageQueueTransactionType so that you can tell MSMQ to participate in that transaction. And always remember to call Complete on your transaction scope when it’s done. If you forget any of these steps, you will find that your message is silently dropped, and never makes it to the queue.</p>
<p>We want to send recoverable messages to the queue. Recoverable messages are persisted. Non-recoverable messages are kept in memory. If the machine reboots before the handler removes them from the queue, non-recoverable messages are lost. Set the Recoverable property to “true” before sending.</p>
<pre class="code"><span style="color: blue">using </span>(<span style="color: blue">var </span>scope = <span style="color: blue">new </span><span style="color: #2b91af">TransactionScope</span>())
{
    <span style="color: blue">using </span>(<span style="color: blue">var </span>queue = <span style="color: blue">new </span><span style="color: #2b91af">MessageQueue</span>(_path))
    {
        queue.DefaultPropertiesToSend
            .Recoverable = <span style="color: blue">true</span>;
        queue.Send(message,
            <span style="color: #2b91af">MessageQueueTransactionType</span>.Automatic);
    }
    scope.Complete();
}</pre><p>The receiver must also create a TransactionScope to receive from a transactional queue. It should enlist its database connection in this same transaction. That way the removal from the queue and the commit to the database are performed atomically. If the message is not processed, it is not removed from the queue.</p>
<p>Because we are using this transaction scope for database operations, be sure to set the isolation level to ReadCommitted. By default the isolation level is Serializable, which is usually far too paranoid. Again, use the MessageQueueTransactionType to enlist in the active transaction, and remember to call Complete.</p>
<pre class="code"><span style="color: blue">using </span>(<span style="color: blue">var </span>scope = <span style="color: blue">new </span><span style="color: #2b91af">TransactionScope</span>(
    <span style="color: #2b91af">TransactionScopeOption</span>.RequiresNew,
    <span style="color: blue">new </span><span style="color: #2b91af">TransactionOptions
    </span>{
        IsolationLevel = <span style="color: #2b91af">IsolationLevel
            </span>.ReadCommitted
    }))
{
    <span style="color: blue">using </span>(<span style="color: blue">var </span>queue = <span style="color: blue">new </span><span style="color: #2b91af">MessageQueue</span>(_path))
    {
        <span style="color: blue">var </span>msmqMessage = queue.Receive(
            <span style="color: #2b91af">MessageQueueTransactionType</span>.Automatic);
        message = (T)msmqMessage.Body;

        HandleMessage(message);

        scope.Complete();
    }
}</pre><p>By using MSMQ in this way, you can guarantee that the message is persisted, and that it is not removed from persistent storage until it is processed. But this does not guarantee that duplicates are recognized. For that, we need to follow some simple guidelines.</p>
<h3>Duplicate messages</h3>
<p>If the client sends a command, and a network exception occurs, then the client doesn’t know whether message made it into the queue. It has no choice but to retry. It is up to the server to detect duplicates and handle them appropriately. To make sure we don’t duplicate, follow these guidelines:</p>
<ul>
<li>Client-generated identifier</li>
<li>Check for the outcome</li>
<li>Nod and smile</li>
</ul>
<p>To detect duplicates, the server needs a way to uniquely identify commands. Because the duplication originates on the client, the unique identifier must as well. include a Guid command ID with every message.</p>
<pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">PlaceOrder
</span>{
    <span style="color: blue">public </span><span style="color: #2b91af">Guid </span>OrderId { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }
    ...
}</pre><p>When the handler has processed the message – whether it was successful or not – it should store an outcome. Make sure that outcome includes the command identifier. Then, when the next message comes in, you can simply check for an outcome having the same ID.</p>
<p>You might be tempted to throw an exception when you detect a duplicate. Doing so only confuses the issue. The best thing to do is nod and smile.</p>
<p>The client has already sent the original message, gotten an error, and sent the duplicate. They should not get an error after having successfully sent a message. What would the client do in response to that exception? The answer is the same as if they received no exception: move on. So don’t throw an exception to the client. Just nod and smile.</p>
<p>It’s better to just check for duplicates in the handler, after the client has already moved on. If you find an outcome for this command, then you know that the message is a duplicate. Just short-circuit the handler.</p>
<pre class="code"><span style="color: blue">if </span>(_pickListService.GetPickLists(message.OrderId)
    .Any())
    <span style="color: blue">return</span>;</pre><p>These guidelines will help you to create services that uphold the durability guarantees. If the client knows that you have received the message, then they know that you have already persisted it. If the power goes out, their command won’t be lost. Furthermore, they know that you won’t drop the message until it has been handled. And finally, if they have to send you a duplicate in order to know that you’ve received it, they can rest assured that you won’t duplicate the results.</p>
</div>
    <br />
        	<div class="links-align">
            <div class="bg-links">
                <div class="links-left">
                    <div class="links-right">
                        <div class="links"><ul class="links inline"><li class="blog_usernames_blog first"><a href="blogs/michael-l-perry.html" title="Read Michael L Perry&#039;s latest blog entries.">Michael L Perry&#039;s blog</a></li>
<li class="comment_comments last"><a href="durability.html#comments" title="Jump to the first comment of this posting.">2 comments</a></li>
</ul></div>
                    </div>
                </div>
            </div>
        </div>
	    <br class="clear" />    
    </div><div class="node">
	    	
			            <div class="bg-h2">
                <h1 class="title"><a href="cqrs.html">CQRS</a></h1>
                <div class="submit"><span class="submitted">Submitted by Michael L Perry on Thu, 10/18/2012 - 10:37</span></div>
            </div>
       
        <div class="taxonomy"></div>
  
    <div class="content"><p>Greg Young and Udi Dahan have documented a pattern that they found worked well in large-scale distributed systems. They called this pattern Command Query Responsibility Segregation, or CQRS. This pattern is based on the principal of Command Query Separation, or CQS, which is described in Bertrand Meyer’s Object-Oriented Software Construction. It seeks to scale read-heavy components separately from write-heavy components. In order to achieve that scale, the responsibilities for processing write-heavy commands had to be segregated from the responsibility of processing read-heavy queries.</p>
<h3>Command Query Separation</h3>
<p><a href="http://qedcode.com/sites/default/files/CQRS_7A35/image.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: right; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" align="right" src="http://qedcode.com/sites/default/files/CQRS_7A35/image_thumb.png" width="485" height="367" /></a>The underlying principal of Command Query Separation tells us that a method should either change the state of the system, or return results. A method should not do both. <strong>It is very difficult to reason about the behavior of a software system if it changes state whenever you observe it</strong>. The methods that change state are commands. The methods that return results are queries.</p>
<p>It is very easy for a user of the API to recognize commands and queries. Commands declare their return type as “void”. Queries have a non-void return type. This also makes it easy to spot the calls in code. The code will be doing something with the results of queries.</p>
<p>Have you ever seen code that ignores the return value of a method call? The caller probably made a mistake. It’s very difficult to see that mistake in the written code, since you can’t see that the method returns a value. If the method obeyed the principal of Command Query Separation, then it either wouldn’t have any effect on the system, or it wouldn’t have a return value to ignore. Either way, the caller wouldn’t be able to make that mistake.</p>
<p>When code follows the principal of Command Query Separation, callers are encouraged to organize their code in three sections. The first section gathers information by executing queries. The second section makes a decision based on that information. And the third section records the decision by calling a command.</p>
<p>There can be many calls to different objects to get the information the caller needs. These calls can occur in any order. Since the calls have no side-effects, they can be easily reordered. New calls can be inserted with no change in correctness.</p>
<p>There is usually just one command issued at the end of this kind of sequence. Chains of commands open the possibility for corruption and inconsistencies due to partial successes. It is much easier to maintain code in which each command leaves the system in a consistent state. A subsequent sequence of operations can read that state and issue the next command.</p>
<p>This kind of structure is much easier to reason about. In the gather information section, we can rewrite the calls just as we would a mathematical equation. We can apply the commutative and associative properties, because the order in which we execute queries has no effect on their results. There is only one state change in the entire sequence, and that always occurs at the end.</p>
<h3>Command Query Responsibility Segregation</h3>
<p>The CQRS pattern has a much different goal than it’s predecessor, the CQS principal. The goal of CQRS is to scale reads differently than writes.</p>
<p>Many of the systems that we build are read-heavy. We tend to read data much more often and in much higher quantity than we write it. You can actually calculate a ratio for any given system. Take a typical record. It will be written once. How many times will it be read? How many times will it be aggregated to produce a report? How many times will it be shared with the other users of the system? In most systems, it is not surprising to find that the average record is read hundreds or thousands of times. So the ratio of reads to writes is easily two to three orders of magnitude, in most business systems.</p>
<p>Given the read-heavy nature of business systems, when they come under load, it makes sense to scale up the number of resources dedicated to servicing reads. However, if those same resources are responsible for writes, then those resources are wasted. Worse, those resources can put heavier write load on the system, compete with the reads, and counteract the benefit of scaling up in the first place.</p>
<p>Where CQS separates commands from queries at the method level, CQRS separates them at the component level. Some components are responsible for commands – writes – and others are responsible for queries – reads. To scale out a read-heavy business system, you can allocate more resources just to the read components.</p>
<h3>CQRS in practice</h3>
<p>Consider this WCF contract.</p>
<pre class="code">[<span style="color: #2b91af">ServiceContract</span>]
<span style="color: blue">public interface </span><span style="color: #2b91af">IFulfillmentService
</span>{
    [<span style="color: #2b91af">OperationContract</span>]
    <span style="color: #2b91af">Confirmation </span>PlaceOrder(<span style="color: #2b91af">Order </span>order);
}</pre><p>This method does not obey the CQS principal. It is changing the state of the system, and returning a result. Hidden inside of this result is a tracking number. This result is quite expensive. To process an order and get a tracking number, the fulfillment system needs to:</p>
<ul>
<li>Locate inventory</li>
<li>Allocate that inventory to this order</li>
<li>Determine the shipment method</li>
<li>Allocate space on a pallet</li>
<li>Obtain a tracking number from the carrier</li>
</ul>
<p>Because this is returned from a method, all of these steps must be performed synchronously. The caller will have to wait while those steps are performed before they know that their order has even been submitted.</p>
<p>The first step in correcting this problem is to define two methods: a command and a query.</p>
<pre class="code">[<span style="color: #2b91af">ServiceContract</span>]
<span style="color: blue">public interface </span><span style="color: #2b91af">IFulfillmentService
</span>{
    [<span style="color: #2b91af">OperationContract</span>]
    <span style="color: blue">void </span>PlaceOrder(<span style="color: #2b91af">Order </span>order);

    [<span style="color: #2b91af">OperationContract</span>]
    <span style="color: #2b91af">Confirmation </span>CheckOrderStatus(<span style="color: #2b91af">Guid </span>orderId);
}</pre><p>Now the service can return immediately after storing the incoming order. It doesn’t have to go through all of the steps before letting the caller know that the order was received. The caller can come back later and check the status of the order by executing a query.</p>
<p>The next step will be to move the processing of that command to a different component. We will see how to do that in the next article.</p>
<p>For the complete example, please download the code from the <a href="http://github.com/michaellperry/pharmanet">PharmaNet</a> repository on GitHub. Look at the Fulfillment solution for this service.</p>
</div>
    <br />
        	<div class="links-align">
            <div class="bg-links">
                <div class="links-left">
                    <div class="links-right">
                        <div class="links"><ul class="links inline"><li class="blog_usernames_blog first"><a href="blogs/michael-l-perry.html" title="Read Michael L Perry&#039;s latest blog entries.">Michael L Perry&#039;s blog</a></li>
<li class="comment_add last"><a href="http://qedcode.com/comment/reply/92#comment-form" title="Add a new comment to this page.">Add new comment</a></li>
</ul></div>
                    </div>
                </div>
            </div>
        </div>
	    <br class="clear" />    
    </div><div class="node">
	    	
			            <div class="bg-h2">
                <h1 class="title"><a href="content/ensure-value-correspondence-property.html">Ensure the value of a Correspondence property</a></h1>
                <div class="submit"><span class="submitted">Submitted by Michael L Perry on Tue, 09/25/2012 - 15:37</span></div>
            </div>
       
        <div class="taxonomy"></div>
  
    <div class="content"><p>When a <a href="http://correspondencecloud.com/">Correspondence</a> application starts up, it doesn’t need to immediately load data from storage. It can complete its data binding and render an empty view. Then, when the data is loaded, it can update the view. This results in quicker load times and more responsive applications. But it also means that you sometimes have to take one extra step to ensure the value of a property or result of a query.</p>
<h3>Delayed load for more fluid UI</h3>
<p>Let’s start with a simple model. An individual is identified by their anonymous Windows Live ID. The user can change their name. Here’s the model:</p>
<pre class="code">fact Individual {
key:
    string anonymousId;

mutable:
    publish string name;
}</pre><p>We’ll inject the individual into a view model. From there, we expose the name property for data binding.</p>
<pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">MainViewModel
</span>{
    <span style="color: blue">private </span><span style="color: #2b91af">Individual </span>_individual;

    <span style="color: blue">public </span>MainViewModel(<span style="color: #2b91af">Individual </span>individual)
    {
        _individual = individual;
    }

    <span style="color: blue">public string </span>Name
    {
        <span style="color: blue">get </span>{ <span style="color: blue">return </span>_individual.Name; }
        <span style="color: blue">set </span>{ _individual.Name = <span style="color: blue">value</span>; }
    }
}</pre><p>When the application starts up, Correspondence won’t wait for the name to load from storage before displaying the view. It will just return a null during the initial data binding. After the name has loaded asynchronously, it will fire property changed and update the view.</p>
<p>When the user enters a new name, the property setter asynchronously starts the process of writing the new value. It returns before that process is finished so that the UI can be more responsive. When dealing with data binding and user interaction, this behavior is beneficial. The UI renders more quickly and fluidly, even if the data fills in just a fraction of a second later.</p>
<h3>Delayed load is not so good for code</h3>
<p>But when dealing with code, this behavior is unexpected. For example:</p>
<pre class="code">_flynn.FavoriteColor = <span style="color: #a31515">&quot;Blue&quot;</span>;

<span style="color: green">// It's still blank.
</span><span style="color: #2b91af">Assert</span>.AreEqual(<span style="color: blue">null</span>, _flynn.FavoriteColor.Value);</pre><p>If I’ve never read the property before, it will return null. It will start loading the value asynchronously, but by then my code has already moved on. It won’t respond to a PropertyChanged notification when the value finishes loading.</p>
<h3>Ensure that a property is loaded</h3>
<p>You don’t want the UI to wait for the value to finish loading. That would just cause stutter. But you do want code to wait. So in code, you should call the “Ensure()” method. Ensure will block until the property has finished loading.</p>
<pre class="code">_flynn.FavoriteColor = <span style="color: #a31515">&quot;Blue&quot;</span>;

<span style="color: green">// Ensure that the value is loaded.
</span><span style="color: #2b91af">Assert</span>.AreEqual(<span style="color: #a31515">&quot;Blue&quot;</span>, _flynn.FavoriteColor.Ensure().Value);</pre><h3>Ensure that query results are loaded</h3>
<p>Ensure also works with queries. By default, a query will return an empty collection while the result loads asynchronously. But when you need to make a decision based on the results of a query, you need to Ensure that they’ve finished loading.</p>
<pre class="code"><span style="color: #2b91af">TaskList </span>taskList = individual.TaskLists.Ensure().FirstOrDefault();
<span style="color: blue">if </span>(taskList == <span style="color: blue">null</span>)
    taskList = individual.CreateTaskList();

<span style="color: #2b91af">Task </span>task = taskList.AddTask();</pre><p>Without the call to Ensure, this code will create a new task list every time the application starts.</p>
<p>Because Ensure blocks, do not call it in a view model property getter. You don’t want to block the UI. But it is perfectly valid in a view model property setter. The user has already performed an action, and they won’t perceive the momentary pause while the query or property loads. It’s also appropriate to use in background code that is not related to the view model at all. If you use Ensure in the right places, you can have the consistent behavior that code needs while still getting the responsive UI that the user desires.</p>
</div>
    <br />
        	<div class="links-align">
            <div class="bg-links">
                <div class="links-left">
                    <div class="links-right">
                        <div class="links"><ul class="links inline"><li class="blog_usernames_blog first"><a href="blogs/michael-l-perry.html" title="Read Michael L Perry&#039;s latest blog entries.">Michael L Perry&#039;s blog</a></li>
<li class="comment_add last"><a href="http://qedcode.com/comment/reply/90#comment-form" title="Add a new comment to this page.">Add new comment</a></li>
</ul></div>
                    </div>
                </div>
            </div>
        </div>
	    <br class="clear" />    
    </div><div class="item-list"><ul class="pager"><li class="pager-first first"><a href="node.html" title="Go to first page" class="active">« first</a></li>
<li class="pager-previous"><a href="node.html" title="Go to previous page" class="active">‹ previous</a></li>
<li class="pager-item"><a href="node.html" title="Go to page 1" class="active">1</a></li>
<li class="pager-current">2</li>
<li class="pager-item"><a href="node4658.html?page=2" title="Go to page 3" class="active">3</a></li>
<li class="pager-item"><a href="node9ba9.html?page=3" title="Go to page 4" class="active">4</a></li>
<li class="pager-item"><a href="nodefdb0.html?page=4" title="Go to page 5" class="active">5</a></li>
<li class="pager-item"><a href="nodeaf4d.html?page=5" title="Go to page 6" class="active">6</a></li>
<li class="pager-item"><a href="nodec575.html?page=6" title="Go to page 7" class="active">7</a></li>
<li class="pager-item"><a href="node235c.html?page=7" title="Go to page 8" class="active">8</a></li>
<li class="pager-item"><a href="nodefdfa.html?page=8" title="Go to page 9" class="active">9</a></li>
<li class="pager-next"><a href="node4658.html?page=2" title="Go to next page" class="active">next ›</a></li>
<li class="pager-last last"><a href="nodefdfa.html?page=8" title="Go to last page" class="active">last »</a></li>
</ul></div>                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
    <div id="footer">
    	<div class="foot">
        	                <span><a rel="license" href="http://creativecommons.org/licenses/by/3.0/us/"><img alt="Creative Commons License" src="../licensebuttons.net/l/by/3.0/us/88x31.png" /></a><br /><span dc="http://purl.org/dc/elements/1.1/" href="http://purl.org/dc/dcmitype/Text" property="title" rel="type">Q.E.D. Code</span> by <a cc="http://creativecommons.org/ns#" href="index.html" property="attributionName" rel="attributionURL">Michael L Perry</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/3.0/us/">Creative Commons Attribution 3.0 United States License</a>.</span>
                    </div>
    </div>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
var _gaq = _gaq || [];_gaq.push(["_setAccount", "UA-389401-7"]);_gaq.push(["_trackPageview"]);(function() {var ga = document.createElement("script");ga.type = "text/javascript";ga.async = true;ga.src = ("https:" == document.location.protocol ? "https://ssl" : "http://www") + ".google-analytics.com/ga.js";var s = document.getElementsByTagName("script")[0];s.parentNode.insertBefore(ga, s);})();
//--><!]]>
</script>
</body>

<!-- Mirrored from qedcode.com/node?page=1 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 12:21:38 GMT -->
</html>
