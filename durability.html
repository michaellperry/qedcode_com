<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">

<!-- Mirrored from qedcode.com/durability by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 12:22:18 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Durability | Q.E.D. Code</title>
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="prev" href="cqrs.html" />
<link rel="up" href="content/distributed-systems.html" />
<link rel="next" href="esb.html" />
<link rel="shortcut icon" href="http://qedcode.com/misc/favicon.ico" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/book/book.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/node/node.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/system/defaults.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/system/system.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/system/system-menus.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/user/user.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/sites/all/modules/mollom/mollom.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/sites/all/modules/views/css/views.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/modules/comment/comment.css?2" />
<link type="text/css" rel="stylesheet" media="all" href="http://qedcode.com/themes/theme073/style.css?2" />
  <script type="text/javascript" src="http://qedcode.com/misc/jquery.js?2"></script>
<script type="text/javascript" src="http://qedcode.com/misc/drupal.js?2"></script>
<script type="text/javascript" src="http://qedcode.com/sites/all/modules/google_analytics/googleanalytics.js?2"></script>
<script type="text/javascript" src="http://qedcode.com/sites/all/modules/mollom/mollom.js?2"></script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
jQuery.extend(Drupal.settings, { "basePath": "/", "googleanalytics": { "trackOutbound": 1, "trackMailto": 1, "trackDownload": 1, "trackDownloadExtensions": "7z|aac|arc|arj|asf|asx|avi|bin|csv|doc|exe|flv|gif|gz|gzip|hqx|jar|jpe?g|js|mp(2|3|4|e?g)|mov(ie)?|msi|msp|pdf|phps|png|ppt|qtm?|ra(m|r)?|sea|sit|tar|tgz|torrent|txt|wav|wma|wmv|wpd|xls|xml|z|zip" } });
//--><!]]>
</script>
  
</head>
  
<body>
    <table id="main">
        <tr>
            <td width="100%" class="header">
            	<div class="top-left">
                	<div class="top-right">
                    	<table width="100%">
                            <tr>
                                <td width="100%" style="height:195px;">
                                    <table width="100%">
                                        <tr>
                                            <td width="">
                                                                                                    <a href="index.html" title="Home"><img src="http://qedcode.com/themes/theme073/images/logo.png" alt="Home" border="0" class="logo" /></a><br />
                                                                                                                                                
                                                                                            </td>
                                            <td width="270">
                                                <div class="search-box">
                                                                                                    </div>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                            <tr>
                                <td width="100%" style="height:54px;">
                                                                            <div class="pr-menu">
                                            <ul class="links primary-links"><li class="menu-227 first"><a href="node.html" title="">Latest Article</a></li>
<li class="menu-339"><a href="podcast.html" title="Q.E.D. Code Podcast">Podcast</a></li>
<li class="menu-219"><a href="theory.html" title="">Theory</a></li>
<li class="menu-220"><a href="practice.html" title="">Practice</a></li>
<li class="menu-221 last"><a href="speaking.html" title="">Speaking</a></li>
</ul>                                            <br class="clear" />
                                        </div>
                                                                    </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </td>
        </tr>
        <tr>
            <td width="100%">
                <table width="100%" >
                    <tr>
                        <td width="189">
                            <div class="left2">
                                                                    <table width="100%">
                                      <tr>
                                        <td width="100%">
                                            <div class="block block-block" id="block-block-2">
	<div class="block-bot">
    	<div class="block-top">
        	<div class="block-indent">
                <div class="title">
                    <h3>About me</h3>
                </div>
                <div class="content"><div style="margin: 15px;">
<p style="margin-bottom: 7px;">Michael L Perry</p>
<p><a href="http://improvingenterprises.com/"><img src="images/IE-Logo.png" width="145" alt="Improving Enterprises" /></a></p>
<p style="margin-bottom: 15px;">Principal Consultant</p>
<p><a href="http://twitter.com/michaellperry">@michaellperry</a></p>
</div>
</div>
            </div>
        </div>
    </div>
</div><div class="block block-user" id="block-user-0">
	<div class="block-bot">
    	<div class="block-top">
        	<div class="block-indent">
                <div class="title">
                    <h3>User login</h3>
                </div>
                <div class="content"><form action="http://qedcode.com/durability?destination=node%2F94"  accept-charset="UTF-8" method="post" id="user-login-form">
<div><div class="form-item" id="edit-name-wrapper">
 <label for="edit-name">Username: <span class="form-required" title="This field is required.">*</span></label>
 <input type="text" maxlength="60" name="name" id="edit-name" size="15" value="" class="form-text required" />
</div>
<div class="form-item" id="edit-pass-wrapper">
 <label for="edit-pass">Password: <span class="form-required" title="This field is required.">*</span></label>
 <input type="password" name="pass" id="edit-pass"  maxlength="60"  size="15"  class="form-text required" />
</div>
<input type="submit" name="op" id="edit-submit" value="Log in"  class="form-submit" />
<div class="item-list"><ul><li class="first last"><a href="user/password.html" title="Request new password via e-mail.">Request new password</a></li>
</ul></div><input type="hidden" name="form_build_id" id="form-5d3ebfd427cde8eccc90278d88b8ed92" value="form-5d3ebfd427cde8eccc90278d88b8ed92"  />
<input type="hidden" name="form_id" id="edit-user-login-block" value="user_login_block"  />

</div></form>
</div>
            </div>
        </div>
    </div>
</div>                                        </td>
                                      </tr>
                                    </table>
                                                            </div>
                        </td>
                        <td width="0">
                            <div class="right2">
                                                            </div>
                        </td>
                        <td width="" class="cont-row">
                            <div class="border-left">
                                <div class="border-right">
                                    <div class="border-bot">
                                        <div class="border-top">
                                            <div class="corner-bot-left">
                                                <div class="corner-bot-right">
                                                    <div class="corner-top-left">
                                                        <div class="corner-top-right">
                                                            <div class="cent">
                                                                                                                                                                                                
                                                                                                                        
                                                                <h2>Durability</h2>
                                                                                                                                                                                                                                                                 
                                                                                                                    
                                                                                                                    
                                                              <!-- start main content -->
                                                            <div class="node">
	    <div class="taxonomy"></div>
  
    <div class="content"><p><a href="http://qedcode.com/sites/default/files/Durability_9628/image.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: right; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" align="right" src="http://qedcode.com/sites/default/files/Durability_9628/image_thumb.png" width="415" height="362" /></a>In a system using the CQRS pattern, the client will typically send command messages to a queue. A handler will pull messages from that queue for asynchronous processing.</p>
<p>When we take this approach, we have to be sure not to violate the client’s trust. If they send us a command, and know that we have received it, they should expect that it will eventually be processed. Furthermore, if they send us a command, and don’t know whether we received it (because they got a network failure), then they should feel safe to re-send the command.</p>
<p>These are durability guarantees. We guarantee that the message was persisted. If the server reboots before it can handle the message, the message won’t be lost. The message is not removed from persistent storage until it is processed. And if the client sends a duplicate, the handler recognizes it and does not duplicate the results.</p>
<h3>MSMQ command queue</h3>
<p>If you are using MSMQ for the commands, you don’t get the durability guarantees for free. The default behavior of MSMQ is optimized for performance. Durability has a cost. To get it, use the following options:</p>
<ul>
<li>Recoverable messages</li>
<li>Transactional queues</li>
<li>Private local queues</li>
</ul>
<p>As C# developers, we have our own definition for public and private. These definitions do not apply to MSMQ. Private local queues are managed just at the machine level. A public queue is managed by Active Directory. Because we are using this queue as an inbox for a known command handler, private queues are the simpler option.</p>
<p>When the command handler first starts up, it needs to check whether the queue exists. If not, it should create it. Use the overload that takes an extra boolean parameter so that you can specify this to be a transactional queue.</p>
<pre class="code">_path = <span style="color: #a31515">@&quot;.\private$\&quot; </span>+ queueName;
<span style="color: blue">if </span>(!<span style="color: #2b91af">MessageQueue</span>.Exists(_path))
{
    <span style="color: #2b91af">MessageQueue</span>.Create(_path,
        transactional: <span style="color: blue">true</span>);
}</pre><p>To send a message to a transactional queue, you have to be in a transaction. Create a TransactionScope to begin the transaction. Use the Send overload that takes a MessageQueueTransactionType so that you can tell MSMQ to participate in that transaction. And always remember to call Complete on your transaction scope when it’s done. If you forget any of these steps, you will find that your message is silently dropped, and never makes it to the queue.</p>
<p>We want to send recoverable messages to the queue. Recoverable messages are persisted. Non-recoverable messages are kept in memory. If the machine reboots before the handler removes them from the queue, non-recoverable messages are lost. Set the Recoverable property to “true” before sending.</p>
<pre class="code"><span style="color: blue">using </span>(<span style="color: blue">var </span>scope = <span style="color: blue">new </span><span style="color: #2b91af">TransactionScope</span>())
{
    <span style="color: blue">using </span>(<span style="color: blue">var </span>queue = <span style="color: blue">new </span><span style="color: #2b91af">MessageQueue</span>(_path))
    {
        queue.DefaultPropertiesToSend
            .Recoverable = <span style="color: blue">true</span>;
        queue.Send(message,
            <span style="color: #2b91af">MessageQueueTransactionType</span>.Automatic);
    }
    scope.Complete();
}</pre><p>The receiver must also create a TransactionScope to receive from a transactional queue. It should enlist its database connection in this same transaction. That way the removal from the queue and the commit to the database are performed atomically. If the message is not processed, it is not removed from the queue.</p>
<p>Because we are using this transaction scope for database operations, be sure to set the isolation level to ReadCommitted. By default the isolation level is Serializable, which is usually far too paranoid. Again, use the MessageQueueTransactionType to enlist in the active transaction, and remember to call Complete.</p>
<pre class="code"><span style="color: blue">using </span>(<span style="color: blue">var </span>scope = <span style="color: blue">new </span><span style="color: #2b91af">TransactionScope</span>(
    <span style="color: #2b91af">TransactionScopeOption</span>.RequiresNew,
    <span style="color: blue">new </span><span style="color: #2b91af">TransactionOptions
    </span>{
        IsolationLevel = <span style="color: #2b91af">IsolationLevel
            </span>.ReadCommitted
    }))
{
    <span style="color: blue">using </span>(<span style="color: blue">var </span>queue = <span style="color: blue">new </span><span style="color: #2b91af">MessageQueue</span>(_path))
    {
        <span style="color: blue">var </span>msmqMessage = queue.Receive(
            <span style="color: #2b91af">MessageQueueTransactionType</span>.Automatic);
        message = (T)msmqMessage.Body;

        HandleMessage(message);

        scope.Complete();
    }
}</pre><p>By using MSMQ in this way, you can guarantee that the message is persisted, and that it is not removed from persistent storage until it is processed. But this does not guarantee that duplicates are recognized. For that, we need to follow some simple guidelines.</p>
<h3>Duplicate messages</h3>
<p>If the client sends a command, and a network exception occurs, then the client doesn’t know whether message made it into the queue. It has no choice but to retry. It is up to the server to detect duplicates and handle them appropriately. To make sure we don’t duplicate, follow these guidelines:</p>
<ul>
<li>Client-generated identifier</li>
<li>Check for the outcome</li>
<li>Nod and smile</li>
</ul>
<p>To detect duplicates, the server needs a way to uniquely identify commands. Because the duplication originates on the client, the unique identifier must as well. include a Guid command ID with every message.</p>
<pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">PlaceOrder
</span>{
    <span style="color: blue">public </span><span style="color: #2b91af">Guid </span>OrderId { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }
    ...
}</pre><p>When the handler has processed the message – whether it was successful or not – it should store an outcome. Make sure that outcome includes the command identifier. Then, when the next message comes in, you can simply check for an outcome having the same ID.</p>
<p>You might be tempted to throw an exception when you detect a duplicate. Doing so only confuses the issue. The best thing to do is nod and smile.</p>
<p>The client has already sent the original message, gotten an error, and sent the duplicate. They should not get an error after having successfully sent a message. What would the client do in response to that exception? The answer is the same as if they received no exception: move on. So don’t throw an exception to the client. Just nod and smile.</p>
<p>It’s better to just check for duplicates in the handler, after the client has already moved on. If you find an outcome for this command, then you know that the message is a duplicate. Just short-circuit the handler.</p>
<pre class="code"><span style="color: blue">if </span>(_pickListService.GetPickLists(message.OrderId)
    .Any())
    <span style="color: blue">return</span>;</pre><p>These guidelines will help you to create services that uphold the durability guarantees. If the client knows that you have received the message, then they know that you have already persisted it. If the power goes out, their command won’t be lost. Furthermore, they know that you won’t drop the message until it has been handled. And finally, if they have to send you a duplicate in order to know that you’ve received it, they can rest assured that you won’t duplicate the results.</p>
  <div id="book-navigation-3" class="book-navigation">
    
        <div class="page-links clear-block">
              <a href="cqrs.html" class="page-previous" title="Go to previous page">‹ CQRS</a>
                    <a href="content/distributed-systems.html" class="page-up" title="Go to parent page">up</a>
                    <a href="esb.html" class="page-next" title="Go to next page">Enterprise Service Bus ›</a>
          </div>
    
  </div>
</div>
    <br />
        	<div class="links-align">
            <div class="bg-links">
                <div class="links-left">
                    <div class="links-right">
                        <div class="links"><ul class="links inline"><li class="blog_usernames_blog first"><a href="blogs/michael-l-perry.html" title="Read Michael L Perry&#039;s latest blog entries.">Michael L Perry&#039;s blog</a></li>
<li class="comment_add last"><a href="http://qedcode.com/comment/reply/94#comment-form" title="Share your thoughts and opinions related to this posting.">Add new comment</a></li>
</ul></div>
                    </div>
                </div>
            </div>
        </div>
	    <br class="clear" />    
    </div><div id="comments">
  <a id="comment-72"></a>
<div class="comment comment-published">
    <h3 class="title"><a href="durability.html#comment-72" class="active">Should I use this right away</a></h3>
  <div class="submitted">Submitted by Breno (not verified) on Fri, 11/23/2012 - 06:55.</div>
  <div class="content">
    <p>Hello Michael, I'm following your course on pluralsight and thats how I got here, nice to meet you.</p>
<p>I've got a simple question, hope you can help me out...</p>
<p>I'm about to right a simple e-commerce app, and I'd like to know if it sounds like a good idea to use msmq to proccess the orders, I'll probably deploy to windows azure and to a single machine, I mean, It is not a distributed system physically.. do the msqm benefits still aply to my scenario? </p>
<p>I'm not sure whether my app is going to be a success, but I keep thinking that I should make it as it's going to be</p>
      </div>
  <!-- BEGIN: links -->
  <div class="links"><ul class="links"><li class="comment_reply first last"><a href="http://qedcode.com/comment/reply/94/72">reply</a></li>
</ul></div>
  <!-- END: links -->
</div>
<div class="indented"><a id="comment-73"></a>
<div class="comment comment-published">
    <h3 class="title"><a href="durability.html#comment-73" class="active">Yes</a></h3>
  <div class="submitted">Submitted by Michael L Perry on Fri, 11/23/2012 - 12:04.</div>
  <div class="content">
    <p>There are two good reasons for using these patterns right away. First, you tolerate failures without data loss. And second, you are more prepared for success.</p>
<p>Udi Dahan gave some tounge-in-cheek advice in a recent article (<a href="http://msdn.microsoft.com/en-us/magazine/cc663023.aspx" title="http://msdn.microsoft.com/en-us/magazine/cc663023.aspx">http://msdn.microsoft.com/en-us/magazine/cc663023.aspx</a>). He said that you should take out logging. The reason is that if you call a web service to place an order, and that service fails, the log entry is the only record that you have of loosing the order. So cover your tracks and discard the evidence.</p>
<p>His actual advice was to queue the request so that you can retry in failure. Even if the message is moved to the dead letter queue, you haven't lost the data. You can fix the software and replay it, or even process it manually. So start queueing today so you can handle failures.</p>
<p>Then second reason to start today is just in case your application does well. If it takes off, you may find that one server is not enough to handle the load. Using these patterns gives you more opportunity to scale in the future. Retrofitting a scalable solution into a synchronous web service is difficult.</p>
<p>So get started now just in case you fail, and just in case you succeed.</p>
      </div>
  <!-- BEGIN: links -->
  <div class="links"><ul class="links"><li class="comment_reply first last"><a href="http://qedcode.com/comment/reply/94/73">reply</a></li>
</ul></div>
  <!-- END: links -->
</div>
</div></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
    <div id="footer">
    	<div class="foot">
        	                <span><a rel="license" href="http://creativecommons.org/licenses/by/3.0/us/"><img alt="Creative Commons License" src="../licensebuttons.net/l/by/3.0/us/88x31.png" /></a><br /><span dc="http://purl.org/dc/elements/1.1/" href="http://purl.org/dc/dcmitype/Text" property="title" rel="type">Q.E.D. Code</span> by <a cc="http://creativecommons.org/ns#" href="index.html" property="attributionName" rel="attributionURL">Michael L Perry</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/3.0/us/">Creative Commons Attribution 3.0 United States License</a>.</span>
                    </div>
    </div>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
var _gaq = _gaq || [];_gaq.push(["_setAccount", "UA-389401-7"]);_gaq.push(["_trackPageview"]);(function() {var ga = document.createElement("script");ga.type = "text/javascript";ga.async = true;ga.src = ("https:" == document.location.protocol ? "https://ssl" : "http://www") + ".google-analytics.com/ga.js";var s = document.getElementsByTagName("script")[0];s.parentNode.insertBefore(ga, s);})();
//--><!]]>
</script>
</body>

<!-- Mirrored from qedcode.com/durability by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 12:22:18 GMT -->
</html>
